<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>å¸ƒéš†éæ¿¾å™¨ Bloom filter - Rust Algorithm Club</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn algorithms and data structures with Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Rust Algorithm Club</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ’¡ åŸºç¤æ¦‚å¿µ</li><li class="chapter-item expanded "><a href="../../concepts/asymptotic-notation/index.html">æ¼¸é€²ç¬¦è™Ÿ Asymptotic Notation</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ” æœå°‹</li><li class="chapter-item expanded "><a href="../../searching/linear_search/index.html">ç·šæ€§æœå°‹ Linear search</a></li><li class="chapter-item expanded "><a href="../../searching/binary_search/index.html">äºŒå…ƒæœå°‹ Binary search</a></li><li class="chapter-item expanded "><a href="../../searching/interpolation_search/index.html">å…§æ’æœå°‹ Interpolation search</a></li><li class="chapter-item expanded "><a href="../../searching/exponential_search/index.html">æŒ‡æ•¸æœå°‹ Exponential search</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ“š æ’åº</li><li class="chapter-item expanded affix "><li class="part-title">ç°¡å–®æ’åº</li><li class="chapter-item expanded "><a href="../../sorting/insertion_sort/index.html">æ’å…¥æ’åº Insertion sort</a></li><li class="chapter-item expanded "><a href="../../sorting/selection_sort/index.html">é¸æ“‡æ’åº Selection sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bubble_sort/index.html">æ°£æ³¡æ’åº Bubble sort</a></li><li class="chapter-item expanded "><a href="../../sorting/shellsort/index.html">å¸Œçˆ¾æ’åº Shellsort</a></li><li class="chapter-item expanded affix "><li class="part-title">é«˜æ•ˆæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/heapsort/index.html">å †ç©æ’åº Heapsort</a></li><li class="chapter-item expanded "><a href="../../sorting/quicksort/index.html">å¿«é€Ÿæ’åº Quicksort</a></li><li class="chapter-item expanded "><a href="../../sorting/mergesort/index.html">åˆä½µæ’åº Mergesort</a></li><li class="chapter-item expanded affix "><li class="part-title">æ··åˆæ’åº</li><li class="chapter-item expanded "><div>ğŸš§ å…§çœæ’åº Introsort</div></li><li class="chapter-item expanded "><div>ğŸš§ è‡ªé©æ‡‰åˆä½µæ’åº Timsort</div></li><li class="chapter-item expanded "><div>ğŸš§ æ¨¡å¼æ¶ˆé™¤å¿«é€Ÿæ’åº Pdqsort</div></li><li class="chapter-item expanded affix "><li class="part-title">ç‰¹æ®Šæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/counting_sort/index.html">è¨ˆæ•¸æ’åº Counting sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bucket_sort/index.html">æ¡¶æ’åº Bucket sort</a></li><li class="chapter-item expanded "><a href="../../sorting/radix_sort/index.html">åŸºæ•¸æ’åº Radix sort</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ  è³‡æ–™çµæ§‹</li><li class="chapter-item expanded affix "><li class="part-title">å †ç–Šèˆ‡ä½‡åˆ—</li><li class="chapter-item expanded "><a href="../../collections/stack/index.html">å †ç–Š Stack</a></li><li class="chapter-item expanded "><div>ğŸš§ ä½‡åˆ— Queue</div></li><li class="chapter-item expanded "><div>ğŸš§ é›™ç«¯ä½‡åˆ— Deque</div></li><li class="chapter-item expanded affix "><li class="part-title">éˆçµä¸²åˆ—</li><li class="chapter-item expanded "><a href="../../collections/linked_list/index.html">éˆçµä¸²åˆ—æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/singly_linked_list/index.html">å–®å‘éˆçµä¸²åˆ— Singly linked list</a></li><li class="chapter-item expanded "><div>ğŸš§ é›™å‘éˆçµä¸²åˆ— Doubly linked list</div></li><li class="chapter-item expanded "><div>ğŸš§ å¾ªç’°éˆçµä¸²åˆ— Circular linked list</div></li><li class="chapter-item expanded affix "><li class="part-title">é—œè¯å®¹å™¨</li><li class="chapter-item expanded "><a href="../../collections/associative-container/index.html">é—œè¯å®¹å™¨æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/hash_map/index.html">é›œæ¹Šè¡¨ Hash map</a></li><li class="chapter-item expanded "><div>ğŸš§ æœ‰åºæ˜ å°„è¡¨ Ordered map</div></li><li class="chapter-item expanded "><div>ğŸš§ å¤šé‡æ˜ å°„è¡¨ Multimap</div></li><li class="chapter-item expanded "><a href="../../collections/set/index.html">é›†åˆ Set</a></li><li class="chapter-item expanded "><a href="../../collections/bloom_filter/index.html" class="active">å¸ƒéš†éæ¿¾å™¨ Bloom filter</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../CONTRIBUTING.html">è²¢ç»æŒ‡å—</a></li><li class="chapter-item expanded affix "><a href="../../404.html">404</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust Algorithm Club</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/weihanglo/rust-algorithm-club" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#å¸ƒéš†éæ¿¾å™¨-bloom-filter" id="å¸ƒéš†éæ¿¾å™¨-bloom-filter">å¸ƒéš†éæ¿¾å™¨ Bloom Filter</a></h1>
<p>Bloom filter æ˜¯ä¸€ç¨®æ©Ÿç‡è³‡æ–™çµæ§‹ï¼ˆprobabilistic data structureï¼‰ï¼Œé¡ä¼¼æ–¼<a href="../set">é›†åˆ</a>ï¼Œå¸¸ç”¨æ–¼éœ€å¿«é€Ÿé©—è­‰æˆå“¡æ˜¯å¦ã€Œå¯èƒ½å­˜åœ¨ã€æˆ–æ˜¯ã€Œçµ•å°ä¸å­˜åœ¨ã€åœ¨å®¹å™¨ä¸­ï¼Œäº¦å³æœ‰æ©Ÿæœƒå‡ºç¾å‡é™½æ€§ï¼ˆfalse positiveï¼‰ï¼Œä½†çµ•ä¸æœƒæœ‰å‡é™°æ€§ï¼ˆfalse negativeï¼‰ã€‚</p>
<p>Bloom filter çš„å„ªå‹¢æ˜¯ï¼š</p>
<ul>
<li>é¡ä¼¼<a href="../set">é›†åˆ</a>ï¼Œå¯åœ¨ $O(1)$ æ™‚é–“è¤‡é›œåº¦é©—è­‰æˆå“¡æ˜¯å¦å­˜åœ¨ï¼Œå»åƒ…éœ€ç›¸å°å°‘çš„å„²å­˜ç©ºé–“ã€‚</li>
<li>æ‰¿ä¸Šï¼Œ<a href="https://hur.st/bloomfilter/?n=1M&amp;p=0.001&amp;m=&amp;k=">åœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiB</a>ã€‚</li>
<li>éå¸¸å®¹æ˜“å¯¦ä½œçš„æ©Ÿç‡è³‡æ–™çµæ§‹ï¼Œåƒ…éœ€å¤šæ¬¡é›œæ¹Šã€‚</li>
</ul>
<p>Bloom filter å‰‡æœ‰ä»¥ä¸‹çŸ­è™•ï¼š</p>
<ul>
<li>ç¶“å…¸æ¬¾ Bloom filter å®¹å™¨å¤§å°å›ºå®šï¼ˆfixed-sizeï¼‰ï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ã€‚</li>
<li>å¯èƒ½çµ¦å‡ºå‡é™½æ€§ç­”æ¡ˆï¼šå›å ±å­˜åœ¨ä½†å¯¦éš›ä¸å­˜åœ¨ï¼Œä¸”éŒ¯èª¤éš¨æ•¸é‡è®Šå¤šä¸Šå‡ã€‚</li>
<li>è‡ªèº«ä¸å„²å­˜æˆå“¡è³‡æ–™ï¼Œéœ€è¦æœ‰é¡å¤–çš„å„²å­˜è³‡æ–™æ–¹æ¡ˆã€‚</li>
<li>åªèƒ½æ–°å¢æˆå“¡ï¼Œä½†ä¸èƒ½ç§»é™¤æˆå“¡ï¼ˆå¯é€é<a href="#%E8%AE%8A%E5%BD%A2">è®Šå½¢</a>è§£æ±ºï¼‰ã€‚</li>
<li>è‹¥è¼¸å…¥è³‡æ–™é›†æœ¬èº«é›¢æ•£ï¼Œæ¥è¿‘<a href="https://en.wikipedia.org/wiki/Random_access">éš¨æ©Ÿå­˜å–</a>ï¼Œç„¡æ³•å……åˆ†åˆ©ç”¨ CPU cacheã€‚</li>
<li>æ‰¿ä¸Šï¼Œå› ç‚ºéš¨æ©Ÿå­˜å–ï¼Œä¸åˆ©æ–¼å»¶ä¼¸åˆ°è¨˜æ†¶é«”ä»¥å¤–çš„å¤–éƒ¨å„²å­˜è£ç½®ã€‚</li>
</ul>
<p>Bloom filter å¸¸è¦‹æ‡‰ç”¨å ´æ™¯ç‚ºï¼š</p>
<ul>
<li><a href="https://www.postgresql.org/docs/12/bloom.html">è³‡æ–™åº«åˆ©ç”¨ Bloom filter</a> ä¸­æ¸›å°‘å¯¦éš›å­˜å– disk çš„ IO é–‹éŠ·ã€‚</li>
<li>Chromium ç€è¦½å™¨<a href="https://chromiumcodereview.appspot.com/10896048/">é©—è­‰å¤§é‡æƒ¡æ„é€£çµ</a>ã€‚</li>
<li>Medium <a href="https://blog.medium.com/what-are-bloom-filters-1ec2a50c68ff">é¿å…æ¨è–¦å·²æ¨è–¦éçš„æ–‡ç« </a>ã€‚</li>
</ul>
<blockquote>
<p>å°çŸ¥è­˜ï¼šbloom æ˜¯é–‹èŠ±ä¹‹æ„ï¼Œä½† Bloom filter å’Œé–‹èŠ±æ²’ä»»ä½•é—œä¿‚ï¼Œåªå› ç™¼æ˜äººå§“æ°ç‚º Bloom</p>
</blockquote>
<blockquote>
<p>æœ¬æ¬¡å¯¦ä½œçš„ç¨‹å¼ç¢¼ç½®æ–¼åœ¨ <a href="/doc/rust_algorithm_club/collections/struct.BloomFilter.html"><code>rust_algorithm_club::collections::BloomFilter</code></a> API æ–‡ä»¶ä¸­ã€‚</p>
</blockquote>
<h2><a class="header" href="#æ¦‚å¿µ" id="æ¦‚å¿µ">æ¦‚å¿µ</a></h2>
<p>Bloom filter ç”±ä¸‹åˆ—å…©å€‹éƒ¨åˆ†çµ„æˆï¼š</p>
<ul>
<li>ä¸€å€‹ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ï¼ˆbit arrayï¼‰</li>
<li>$k$ å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸</li>
</ul>
<p>ç¶“å…¸æ¬¾çš„ Bloom filter ä½œç‚ºä¸€å€‹è¿‘ä¼¼é›†åˆçš„å®¹å™¨ï¼Œæä¾›ä¸‹åˆ—å…©å€‹æ“ä½œ</p>
<ul>
<li><strong>æ–°å¢ï¼š</strong> æ–°å¢ä¸€å€‹å€¼æ™‚ï¼Œé€é $k$ å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿ $k$ å€‹é›œæ¹Šå€¼ï¼Œåˆ†åˆ¥ä»£è¡¨åœ¨ä½å…ƒé™£åˆ—çš„ç´¢å¼•ä½ç½®ï¼Œå†å°‡ $k$ å€‹ä½ç½®çš„ä½å…ƒç¿»è½‰è‡³ 1ã€‚</li>
<li><strong>æŸ¥è©¢ï¼š</strong> åŒæ¨£é€é $k$ å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿ $k$ å€‹é›œæ¹Šå€¼ä½œç‚ºä½å…ƒé™£åˆ—çš„ç´¢å¼•ä½ç½®ï¼Œè‹¥æ‰€æœ‰ä½å…ƒçš†ç‚º 1ï¼Œå‰‡ä»£è¡¨è©²å€¼å­˜åœ¨ã€‚</li>
</ul>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Bloom_filter.svg/1280px-Bloom_filter.svg.png" alt="" /></p>
<blockquote>
<p>ä¸Šåœ–é¡¯ç¤º w ä¸¦æ²’æœ‰åœ¨ {x,y,z} é›†åˆä¸­ï¼Œå› ç‚º w çš„é›œæ¹Šçµæœæœ‰å€‹ä½å…ƒç‚º 0ã€‚</p>
</blockquote>
<p>ä½ å¯èƒ½æœƒé–‹å§‹æƒ³ï¼š</p>
<ul>
<li>æ¬²å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ ï¼Œéœ€è¦å¤šå°‘ä½å…ƒï¼Ÿ</li>
<li>å‡ºç¾å‡é™½æ€§çš„æ©Ÿç‡æ˜¯å¤šå°‘ï¼Ÿå¯ä»¥èª¿æ•´å—ï¼Ÿ</li>
<li>éœ€è¦å¹¾å€‹é›œæ¹Šå‡½æ•¸ï¼Ÿ</li>
<li>å¯é‡è¤‡ä½¿ç”¨ç›¸åŒçš„é›œæ¹Šå‡½æ•¸å—ï¼Ÿ</li>
</ul>
<p>å›ç­”é€™äº›å•é¡Œéœ€è¦å…©å€‹å·²çŸ¥æ¢ä»¶ï¼š</p>
<ol>
<li>é æœŸæœƒå„²å­˜å¤šå°‘ $n$ å€‹å…ƒç´ åˆ°å®¹å™¨ã€‚</li>
<li>å¯å®¹å¿çš„å‡é™½æ€§æ©Ÿç‡ $\epsilon$ï¼Œå³å®¹å™¨ä¸åŒ…å«è©²å…ƒç´ ï¼Œæª¢æ¸¬å»å›å ±å­˜åœ¨ï¼ˆæ‰€æœ‰é›œæ¹Šä½çš†ç‚º 1ï¼‰ã€‚</li>
</ol>
<p>æ–¼æ˜¯å¯å¾—ä½å…ƒé™£åˆ—æœ€ä½³åŒ–çš„é•·åº¦ç‚º $m$ å€‹ä½å…ƒï¼Œ$m$ ç‚ºï¼š</p>
<p>$$m = -\frac{n \ln{\epsilon}}{(\ln{2})^2}$$</p>
<p>è€Œåœ¨å·²çŸ¥æ¢ä»¶ä¸‹ï¼Œéœ€è¦çš„é›œæ¹Šå‡½æ•¸æ•¸é‡ $k$ ç‚ºï¼š</p>
<p>$$k = -\frac{\ln{\epsilon}}{\ln{2}} = -\log_2{\epsilon}$$</p>
<p>ç•¶ç„¶ï¼Œé€™äº›å…¬å¼ä¸¦éæ†‘ç©ºå†’å‡ºï¼Œæœ‰èˆˆè¶£å¯ä»¥è®€è®€<a href="https://en.wikipedia.org/wiki/Bloom_filter#Optimal_number_of_hash_functions">ç¶­åŸºç™¾ç§‘ä¸Šçš„æ•¸å­¸</a>ï¼Œå’Œ<a href="https://sagi.io/bloom-filters-for-the-perplexed/#false-positive-probability-and-formulae">é€™æ®µè©³ç´°çš„æ¨å°</a>ï¼Œä¸éä¹Ÿè¦æ³¨æ„ï¼ŒBloom filter çš„å‡è¨­æ˜¯ã€Œæ¯å€‹é›œæ¹Šå‡½æ•¸ç¨ç«‹ã€ä½†<a href="https://gopiandcode.uk/logs/log-bloomfilters-debunked.html#org7b3d391">ä½å…ƒé–“æ˜¯å¦ç¨ç«‹æœ‰å¾…è¨è«–</a>ï¼Œé€™é †ä¾¿é–‹å•Ÿäº†å…¶ä»–å•é¡Œï¼Œå¯é‡è¤‡ä½¿ç”¨ç›¸åŒçš„é›œæ¹Šå‡½æ•¸å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œ é€™ç¯‡<a href="https://www.eecs.harvard.edu/%7Emichaelm/postscripts/rsa2008.pdf">ã€ŒLess Hashing, Same Performance:Building a Better Bloom Filterã€</a>æåŠï¼Œåœ¨ä¸çŠ§ç‰²æ¼¸é€²å‡é™½æ€§æ©Ÿç‡ï¼ˆasymptotic false positive probabilityï¼‰çš„å‰æä¸‹ï¼Œé€éå…©å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸ $h_1(x)$ å’Œ $h_2(x)$ï¼Œé…åˆä»¥ä¸‹å…¬å¼ï¼Œå°±å¯ä»¥æ¨¡æ“¬å‡ºå¤šå€‹é›œæ¹Šå‡½æ•¸ï¼š</p>
<p>$$g_i(x) = h_1(x) + ih_2(x)$$</p>
<p>æ•¸å­¸çœ‹æšˆäº†å—ï¼Ÿä¾†é»ç¨‹å¼ç¢¼å§ã€‚</p>
<h2><a class="header" href="#æ¶æ§‹è¨­è¨ˆ" id="æ¶æ§‹è¨­è¨ˆ">æ¶æ§‹è¨­è¨ˆ</a></h2>
<h3><a class="header" href="#åˆ©ç”¨-vec-å„²å­˜ä½å…ƒ" id="åˆ©ç”¨-vec-å„²å­˜ä½å…ƒ">åˆ©ç”¨ <code>Vec</code> å„²å­˜ä½å…ƒ</a></h3>
<p>Bloom filter åº•å±¤ä»¥ä½å…ƒé™£åˆ—ä½œç‚ºå„²å­˜å®¹å™¨ï¼Œå¦‚æœç›®æ¨™æ˜¯æœ€çœç©ºé–“ï¼Œè©²ç”¨ Rust çš„ä»€éº¼å‹åˆ¥ä¾†å„²å­˜ä½å…ƒå‘¢ï¼Ÿ</p>
<p>ç›´è§€ä½œæ³•æ˜¯åœ¨ struct æ–°å¢ä¸€å€‹ <code>bits</code> ä½å…ƒé™£åˆ—çš„ <code>array</code> å‹åˆ¥ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BloomFilter {
  bits: [bool; N]
}
<span class="boring">}
</span></code></pre></pre>
<p>é›–ç„¶éå¸¸çœç©ºé–“ï¼Œç”¨äº†å¤šå°‘ bits é€™å€‹ struct å°±ä½”å¤šå¤§ï¼Œä½†é€™èªæ³•ä¸¦éä¸åˆæ³•ï¼Œå› ç‚º <code>N</code> æœªå®šç¾©ï¼Œç„¡æ³•ç·¨è­¯ï¼Œ<a href="https://doc.rust-lang.org/std/primitive.array.html">array</a> çš„ <code>N</code> å¿…é ˆæ˜¯ç·¨è­¯æœŸå°±æ±ºå®šçš„å¸¸æ•¸ï¼ŒBloomFilter è‹¥å¯«æ­» <code>N</code> å°±ä¸å¤ æ³›ç”¨äº†ï¼ˆé™¤éåƒè€ƒ <a href="https://doc.rust-lang.org/alloc/macro.vec.html"><code>vec!</code></a> é€é macro å»ºç«‹ï¼‰ã€‚</p>
<p>ä¸å¦‚æ›å€‹æ–¹å‘ï¼Œä¸ç”¨ fixed size arrayï¼Œçµ¦å®šå‹•æ…‹å¤§å°çš„ <code>slice</code> è©¦è©¦çœ‹ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BloomFilter {
  bits: [bool]
}
<span class="boring">}
</span></code></pre></pre>
<p>å—¯ï¼Œå¯ä»¥ç·¨è­¯é€šéï¼Œä½†å¦‚æœå˜—è©¦å»ºç«‹ä¸€å€‹ struct å‘¢ï¼Ÿ</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let input_len = 5;
    let bits = [true; input_len];
    BloomFilter { bits };
}
</code></pre></pre>
<p>å°±æœƒç™¼ç¾ç·¨è­¯çµæœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">error[E0435]: attempt to use a non-constant value in a constant
 --&gt; src/main.rs:7:23
  |
7 |     let bits = [true; input_len];
  |                       ^^^^^^^^^ non-constant value

error[E0277]: the size for values of type `[bool]` cannot be known at compilation time
 --&gt; src/main.rs:8:5
  |
8 |     BloomFilter { bits };
  |     ^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time
</code></pre>
<p>åŸå› æœ‰äºŒï¼Œå…¶ä¸€åŒæ¨£æ˜¯ array <code>bits</code> éœ€è¦ä¸€å€‹å¸¸æ•¸é•·åº¦ï¼›å…¶äºŒå‰‡æ˜¯ <code>bits</code> æ˜¯ä¸€å€‹ <a href="https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait">Dynamic Sized Typesï¼ˆDstsï¼‰</a> ï¼Œé•·åº¦ç„¡æ³•åœ¨ç·¨è­¯æ™‚æ±ºå®šï¼Œç·¨è­¯æœŸå°±ç„¡æ³•å¾—çŸ¥ BloomFilter çš„æ‰€ä½”è¨˜æ†¶é«”ç”¨é‡ã€‚</p>
<p>çœ‹ä¾†å¾—æ”¾æ£„ç”¨ <code>array</code> æˆ– <code>slice</code> é€™äº›æ–¹æ³•ï¼Œæ”¹ç”¨æœ€æš´åŠ›çš„ <code>Vec</code> ä½œç‚ºä½å…ƒé™£åˆ—å„²å­˜å®¹å™¨ï¼Œ<code>Vec</code> é›–å¯å‹•æ…‹èª¿æ•´å¤§å°ï¼ŒèƒŒå¾Œå…¶å¯¦æ˜¯ä¸€å€‹ pointer + ä¸€å€‹ <code>usize</code> çš„ <code>capacity</code> + ä¸€å€‹ <code>usize</code> çš„ <code>len</code> çµ„æˆï¼Œè‹¥æ˜¯åœ¨ 64 ä½å…ƒçš„æ©Ÿå™¨ä¸Šï¼Œ<a href="https://cheats.rs/#general-purpose-heap-storage">ä¸€å€‹ <code>Vec</code> å°±æœƒä½” 24 ä½å…ƒçµ„</a>ï¼Œæ¯”èµ· <code>array</code> å¤šè€—è²»å…©å€‹ 2 * 8 å€‹ä½å…ƒçµ„ç©ºé–“ï¼Œå¹¸å¥½é€™é¡å¤–çš„ 16 å€‹ä½å…ƒçµ„æ˜¯å›ºå®šæ”¯å‡ºï¼Œä¸éš¨è‘— $m$ å’Œ $n$ æˆé•·ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BloomFilter {
  bits: Vec&lt;bool&gt;
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#å„²å­˜å…©å€‹é›œæ¹Šå‡½æ•¸" id="å„²å­˜å…©å€‹é›œæ¹Šå‡½æ•¸">å„²å­˜å…©å€‹é›œæ¹Šå‡½æ•¸</a></h3>
<p>å†ä¾†ï¼Œè¦åœ¨ <code>BloomFilter</code> å„²å­˜å…©å€‹ hasherï¼Œä¹Ÿå°±æ˜¯å¯¦ä½œå‰é¢æåŠ<a href="https://www.eecs.harvard.edu/%7Emichaelm/postscripts/rsa2008.pdf">ç”¨å…©å€‹é›œæ¹Šå‡½æ•¸æ¨¡æ“¬ $k$ å€‹</a>è«–æ–‡ä¸­çš„å…©å€‹ hasherï¼Œé€™å…©å€‹åœ¨ <code>BloomFilter</code> å»ºæ§‹æ™‚åŒæ™‚å»ºç«‹ï¼Œä¸¦åœ¨æ“ä½œ <code>BloomFilter</code> çš„æ–¹æ³•ä¸Šå…±ç”¨ã€‚</p>
<p>é€™æ¬¡ç›´æ¥ä½¿ç”¨æ¨™æº–å‡½å¼åº«å…§é è¨­é›œæ¹Šæ¼”ç®—æ³• <a href="http://doc.rust-lang.org/std/collections/hash_map/struct.DefaultHasher.html"><code>DefaultHasher</code></a> ä½œç‚ºéš¨æ©Ÿçš„å…©å€‹é›œæ¹Šå‡½æ•¸ <code>BloomFilter.hashers</code>ã€‚ç”±æ–¼æ˜¯æ¨¡æ“¬ $k$ å€‹å‡½æ•¸çš„é›œæ¹Šè¡Œç‚ºï¼Œä»éœ€å¦é—¢æ¬„ä½ï¼Œå„²å­˜ $k$ å¯¦éš›ä¸Šæ˜¯å¤šå°‘å€‹é›œæ¹Šå‡½æ•¸ <code>BloomFilter.hash_fn_count</code>ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::collections::hash_map::DefaultHasher;

pub struct BloomFilter {
  /// The bit array of _m_ bits.
  bits: Vec&lt;bool&gt;,
  /// Count of hash functions. Denoted by _k_.
  hash_fn_count: usize,
  /// The hashers that do real works.
  hashers: [DefaultHasher; 2],
}
<span class="boring">}
</span></code></pre></pre>
<p>å°±å‰©æœ€å¾Œä¸€é‡Œè·¯äº†ï¼</p>
<h3><a class="header" href="#ä½¿ç”¨-a-hrefhttpsdocrust-langorgcoremarkerstructphantomdatahtmlphantomdataa-è®“ç·¨è­¯å™¨é–‰å˜´" id="ä½¿ç”¨-a-hrefhttpsdocrust-langorgcoremarkerstructphantomdatahtmlphantomdataa-è®“ç·¨è­¯å™¨é–‰å˜´">ä½¿ç”¨ <a href="https://doc.rust-lang.org/core/marker/struct.PhantomData.html"><code>PhantomData</code></a> è®“ç·¨è­¯å™¨é–‰å˜´</a></h3>
<p>çœ¾æ‰€å‘¨çŸ¥ï¼Œé€é<a href="https://doc.rust-lang.org/book/ch10-01-syntax.html">æ³›å‹ï¼ˆGenericï¼‰</a>ï¼ŒRust å¯é‡ç”¨ç›¸åŒçš„å®¹å™¨å‹åˆ¥ï¼Œç‰¹åŒ–æ¥å—ä¸åŒå‹åˆ¥çš„å®¹å™¨ï¼Œä¾‹å¦‚ <code>HashMap&lt;K, V&gt;</code> å¯ä»¥ç‰¹åŒ–ç‚ºéµç‚º <code>String</code>ï¼Œå€¼ç‚º <code>u32</code> çš„ <code>HashMap&lt;String, u32&gt;</code>ï¼Œ<code>Vec&lt;T&gt;</code> å¯ä»¥æˆç‚ºäºŒç¶­ä½å…ƒçµ„ <code>Vec&lt;Vec&lt;u8&gt;&gt;</code>ã€‚çœ‹ <a href="http://doc.rust-lang.org/std/collections/index.html"><code>std::collections</code></a> æä¾›çš„å®¹å™¨ï¼Œæ‰€æœ‰æ³›å‹å‹åˆ¥åƒæ•¸ï¼ˆType Parameterï¼‰åƒæ˜¯ <code>T</code>ã€<code>K</code>ã€<code>V</code> éƒ½æ˜¯è·Ÿè‘— struct å®£å‘Šï¼Œä¹Ÿå› ç‚ºé€™äº›å®¹å™¨çš„ç¢ºå¯¦éš›å„²å­˜äº†é€™äº›å‹åˆ¥çš„å…ƒç´ ï¼Œæ³›å‹å‹åˆ¥åƒæ•¸è·Ÿè‘— struct å¾ˆåˆç†ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œä½œç‚ºä¸€å€‹å®¹å™¨ï¼ŒBloom filter å…¶å¯¦ä¸å„²å­˜å…ƒç´ æœ¬èº«ï¼Œè€Œæ˜¯è¨˜éŒ„å…ƒç´ æ˜¯å¦ã€Œæ›¾ç¶“æ–°å¢è‡³ã€è©²å®¹å™¨ä¸­ã€‚é€™çµ¦äº†ä¸€äº›æƒ³åƒç©ºé–“ï¼šå¦‚ä½•æä¾›å‹åˆ¥åƒæ•¸çµ¦ Bloom filterï¼Ÿæä¾›å…©å€‹æ–¹å‘ï¼š</p>
<ol>
<li><strong>æ³›å‹å‹åˆ¥åƒæ•¸å®£å‘Šè·Ÿè‘— structï¼š</strong> ä¹Ÿå°±æ˜¯ <code>struct BloomFilter&lt;T&gt;</code>ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œä¸€å€‹å®¹å™¨å¯¦ä¾‹åªèƒ½æ“ä½œä¸€ç¨®å‹åˆ¥ï¼Œè€Œä¸”åœ¨ç·¨è­¯æœŸå°±æ±ºå®šã€‚
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let bf = BloomFilter::new();
bf.insert(&amp;1);            // infer the type T is i32
bf.insert(&quot;wront type&quot;);  // compile error: &amp;str is not compatible to i32
<span class="boring">}
</span></code></pre></pre>
</li>
<li><strong>æ³›å‹å‹åˆ¥è·Ÿè‘— struct çš„æ–¹æ³•ï¼Œstruct æœ¬èº«ä¸å®£å‘Šï¼š</strong> å¾ˆé›£æƒ³åƒå®¹å™¨è£¡é¢å„²å­˜ä¸åŒçš„å‹åˆ¥ï¼Œä½† BloomFilter å¯¦éš›ä¸Šåªéœ€è¦ä¸€å€‹ <code>Vec&lt;bool&gt;</code> è¨˜éŒ„å­˜åœ¨èˆ‡å¦ï¼Œåˆ°åº•æ–°å¢äº†ä»€éº¼å‹åˆ¥çš„å…ƒç´ å…¶å¯¦ä¸é‡è¦ï¼Œå‹åˆ¥æœ‰å¯¦ä½œé›œæ¹Šå°±è¡Œã€‚é€™å€‹ä½œæ³•ä¸‹ï¼Œä½ å¯èƒ½æœƒçœ‹åˆ°é€™ç¨®é‚ªé­”æ­ªé“ï¼š
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let bf = BloomFilter::new();
bf.insert(&amp;1);
bf.insert(&quot;another type&quot;);  // it works
bf.insert(vec![3.14159]);   // it also works
<span class="boring">}
</span></code></pre></pre>
</li>
</ol>
<p>ç‚ºäº†è®“å®¹å™¨æœ‰ä¸€è‡´æ„Ÿï¼Œé€™è£¡æ±ºå®šé¸æ“‡æ³•ä¸€ï¼Œè®“æ³›å‹è·Ÿè‘—å®¹å™¨èµ°ã€‚å¯¦ä½œéå¸¸ç°¡å–®ï¼ŒåŠ ä¸Š <code>T</code> æ³›å‹åƒæ•¸å°±è¡Œ</p>
<pre><code class="language-diff">use std::collections::hash_map::DefaultHasher;

- pub struct BloomFilter {
+ pub struct BloomFilter&lt;T&gt; {
  /// .. snip
}
</code></pre>
<p>å“å‘€ï¼Œç·¨è­¯å¤±æ•—ï¼</p>
<pre><code class="language-bash">error[E0392]: parameter `T` is never used
 --&gt; src/lib.rs:3:24
  |
3 | pub struct BloomFilter&lt;T&gt; {
  |                        ^ unused parameter
  |
  = help: consider removing `T`, referring to it in a field, or using a marker such as `std::marker::PhantomData`
</code></pre>
<p>å› ç‚º Rust ç·¨è­¯å™¨èªç‚º <code>BloomFilter</code> ä¸¦ä¸å¯¦éš›æ“æœ‰ <code>T</code> ç›¸é—œæ¬„ä½ï¼Œå› æ­¤ç·¨è­¯ä¸é€šéï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨ <a href="https://doc.rust-lang.org/core/marker/struct.PhantomData.html"><code>std::marker::PhantomData</code></a>ï¼Œ<code>PhantomData</code> æ˜¯ä¸€å€‹ Zero-Sized Type ä¸ä½”ç©ºé–“ï¼Œå°±æ˜¯ç‚ºäº†å–æ‚…ç·¨è­¯å™¨ï¼Œè£½é€ å‡º struct æ“æœ‰ <code>T</code> çš„å‡è±¡ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::collections::hash_map::DefaultHasher;
use std::marker::PhantomData;

pub struct BloomFilter&lt;T&gt; {
  /// The bit array of _m_ bits.
  bits: Vec&lt;bool&gt;,
  /// Count of hash functions. Denoted by _k_.
  hash_fn_count: usize,
  /// The hashers that do real works.
  hashers: [DefaultHasher; 2],
  _phantom: PhantomData&lt;T&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#sized-è®“å®¹å™¨å¯ä»¥å„²å­˜-dsts" id="sized-è®“å®¹å™¨å¯ä»¥å„²å­˜-dsts"><code>?Sized</code> è®“å®¹å™¨å¯ä»¥å„²å­˜ DSTs</a></h2>
<p>æœ€å¾Œï¼Œæœ‰é‘‘æ–¼è®“Bloom fliter èƒ½å¤ æ¥å—æ›´å¤šå‹åˆ¥ï¼Œå…ƒç´ ä¸ä¸€å®šè¦ç¬¦åˆç·¨è­¯æœŸç¢ºå®šå¤§å°çš„ <a href="http://doc.rust-lang.org/std/marker/trait.Sized.html"><code>Sized</code></a> trait boundï¼Œå¯ä»¥é€éåŠ ä¸Š <code>?Sized</code> trait bound è§£é™¤é è¨­çš„é™åˆ¶ï¼Œå¦‚æ­¤ä¸€ä¾† <code>BloomFilter</code> å°±å¯æ¥å— slice å’Œ trait object é€™äº› <a href="https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait">DSTs</a> äº†ï¼Œå‚³å…¥ string literal è®Šç‚ºå¯èƒ½ <code>bloom_filter.insert(&quot;1234&quot;)</code>ã€‚</p>
<pre><code class="language-diff">use std::collections::hash_map::DefaultHasher;
use std::marker::PhantomData;

- pub struct BloomFilter&lt;T&gt; {
+ pub struct BloomFilter&lt;T: ?Sized&gt; {
    // .. snip
}
</code></pre>
<h2><a class="header" href="#åŸºæœ¬æ“ä½œ" id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</a></h2>
<p>Bloom filter ç‚ºé¡ä¼¼é›†åˆçš„å®¹å™¨ï¼Œç•¶ç„¶æœ‰<a href="../set#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C">é¡ä¼¼çš„æ“ä½œ</a>ï¼Œäº‹å¯¦ä¸Šï¼Œé€™é¡æ©Ÿç‡æ€§é›†åˆæˆå“¡æª¢æ¸¬çš„è³‡æ–™çµæ§‹æœ‰å€‹è¼ƒå°‘è½è¦‹ä½†ä»¤äººå°è±¡æ·±åˆ»çš„åå­—ï¼Œç¨±ç‚ºã€ŒApproximate Membership Queryï¼ˆAMQï¼‰ã€ï¼Œæä¾› <code>add(element)</code> å’Œ <code>query(element)</code> å…©å€‹åŸºæœ¬æ“ä½œã€‚</p>
<p>æœ¬æ–‡çš„ <code>BloomFilter</code> æä¾›ä¸‹åˆ—å¹¾å€‹å…¬é–‹æ–¹æ³•ï¼š</p>
<ul>
<li><code>new</code>ï¼šåˆå§‹åŒ–ä¸€å€‹å®¹å™¨ã€‚</li>
<li><code>insert</code>ï¼šæ–°å¢ä¸€å€‹å…ƒç´ ã€‚</li>
<li><code>contains</code>ï¼šæª¢æŸ¥å®¹å™¨å…§æœ‰ç„¡ç‰¹å®šå…ƒç´ ï¼ˆæ˜¯å¦æ›¾æ–°å¢éï¼‰ã€‚</li>
</ul>
<p>ä»¥åŠå¹¾å€‹å…§éƒ¨è¼”åŠ©æ–¹æ³•ï¼š</p>
<ul>
<li><code>make_hash</code>ï¼šçµ¦å®šè¼¸å…¥å…ƒç´ è³‡æ–™ï¼Œé€éå…©å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿå…©å€‹é›œæ¹Šå€¼ã€‚</li>
<li><code>get_index</code>ï¼šå°‡ <code>make_hash</code> çš„å…©é›œæ¹Šå€¼å¸¶å…¥ $g_i(x) = h_1(x) + ih_2(x)$ è¨ˆç®—å–®æ¬¡ <code>i</code> çš„ç´¢å¼•ä½ç½®ã€‚</li>
<li><code>optimal_bits_count</code>ï¼šçµ¦å®šé æœŸå„²å­˜å…ƒç´ å€‹æ•¸ $n$ èˆ‡å‡é™½æ€§æ©Ÿç‡ $\epsilon$ï¼Œå¾—ä½å…ƒé™£åˆ—æœ€é©ä½å…ƒæ•¸ $m$ã€‚</li>
<li><code>optimal_hashers_count</code>ï¼šçµ¦å®šé æœŸå‡é™½æ€§æ©Ÿç‡ï¼Œå¾—æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸ $k$ã€‚</li>
</ul>
<h3><a class="header" href="#åˆå§‹åŒ–" id="åˆå§‹åŒ–">åˆå§‹åŒ–</a></h3>
<p>Bloom filter æœ‰å››å€‹åƒæ•¸ $m$ã€$n$ã€$k$ã€$\epsilon$ å¯ä»¥èª¿æ•´ï¼ˆè©³è¦‹ <a href="#%E6%95%88%E8%83%BD">æ•ˆèƒ½</a>ä¸€ç¯€ï¼‰ï¼Œå°ä½¿ç”¨è€…ä¾†èªªï¼Œæœ‰å¹¾å€‹é›œæ¹Šå‡½æ•¸æˆ–åº•å±¤æ˜¯å¤šå°‘å€‹ä½å…ƒéƒ½æ˜¯å¯¦ä½œç´°ç¯€äº†ï¼Œæ›´é—œå¿ƒçš„å¯èƒ½æ˜¯</p>
<p><em>ã€Œæˆ‘æœ‰ä¸€ç™¾è¬ç­†è³‡æ–™éœ€è¦é©—è­‰å­˜åœ¨ï¼Œå®¹éŒ¯ç‡éœ€è¦åœ¨ 0.1%ï¼Œæˆ‘éœ€è¦å¤šå¤§çš„å„²å­˜ç©ºé–“ï¼Ÿã€</em></p>
<p>å› æ­¤ï¼Œå»ºæ§‹å‡½æ•¸ <code>new</code> æä¾›è¼¸å…¥é æœŸå„²å­˜å…ƒç´ å€‹æ•¸ $n$ å’Œé æœŸçš„å‡é™½æ€§æ©Ÿç‡ $\epsilon$ æ˜¯å¤©ç¶“åœ°ç¾©çš„äº‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn new(capacity: usize, err_rate: f64) -&gt; Self;
<span class="boring">}
</span></code></pre></pre>
<p>æ¥ä¸‹ä¾†ï¼Œæœƒå¯¦ä½œ<a href="#%E6%A6%82%E5%BF%B5">æ¦‚å¿µ</a>ä¸€ç¯€çš„æ•¸å­¸å…¬å¼ï¼Œæ‰¾å‡ºæœ€é©ä½å…ƒæ•¸å’Œæœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸ã€‚é€™å…©å€‹å‡½æ•¸éƒ½æ˜¯ä»¥ Rust è¡¨é”æ•¸å­¸å…¬å¼ï¼Œå¯æ³¨æ„çš„é»æ˜¯ï¼Œ<a href="http://doc.rust-lang.org/std/f32/consts/index.html"><code>std::f32::consts</code></a> å’Œ <a href="http://doc.rust-lang.org/std/f64/consts/index.html"><code>std::f64::consts</code></a>ï¼Œæä¾›è¨±å¤šæ•¸å­¸ä¸Šå¸¸è¦‹çš„å¸¸æ•¸è€æœ‹å‹ï¼Œæ“ä½œæµ®é»æ•¸å’Œé›™ç²¾åº¦æµ®é»æ•¸å°±ä¸ç”¨è‡ªå·±æ‰‹å‹•é‡ç®—äº†ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// m = -1 * (n * ln Îµ) / (ln 2)^2
fn optimal_bits_count(capacity: usize, err_rate: f64) -&gt; usize {
    let ln_2_2 = std::f64::consts::LN_2.powf(2f64);
    (-1f64 * capacity as f64 * err_rate.ln() / ln_2_2).ceil() as usize
}

/// k = -log_2 Îµ
fn optimal_hashers_count(err_rate: f64) -&gt; usize {
    (-1f64 * err_rate.log2()).ceil() as usize
}
<span class="boring">}
</span></code></pre></pre>
<p>ç›®å‰ç‚ºæ­¢ï¼Œ<code>BloomFilter::new</code> é•·é€™æ¨£ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn new(capacity: usize, err_rate: f64) -&gt; Self {
    let bits_count = Self::optimal_bits_count(capacity, err_rate);
    let hash_fn_count = Self::optimal_hashers_count(err_rate);
}
<span class="boring">}
</span></code></pre></pre>
<p>æœ€å¾Œï¼ŒæŒ‰ç…§å‰è¿°<a href="https://www.eecs.harvard.edu/%7Emichaelm/postscripts/rsa2008.pdf">å…©å€‹é›œæ¹Šå‡½æ•¸æ°æ°å¥½</a>çš„é“ç†ï¼Œå»ºç«‹å…©å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸ï¼Œä¸¦åˆå§‹åŒ–ä½å…ƒé™£åˆ—ï¼Œå¤§åŠŸå‘Šæˆï¼</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn new(capacity: usize, err_rate: f64) -&gt; Self {
    // #1 Get optimal count of bit
    let bits_count = Self::optimal_bits_count(capacity, err_rate);
    // #2 Get optimal count of hash functions
    let hash_fn_count = Self::optimal_hashers_count(err_rate);
    // #3 Use RandomState to build different hasher
    let hashers = [
        RandomState::new().build_hasher(),
        RandomState::new().build_hasher(),
    ];

    Self {
        bits: vec![false; bits_count], // #4 Initialize a all zero bit array
        hash_fn_count,
        hashers,
        _phantom: PhantomData,
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>é€éæŒ‡å®šå‡é™½æ€§æ©Ÿç‡èˆ‡é æœŸå…ƒç´ å€‹æ•¸ï¼Œç®—å¾—æœ€é©ä½å…ƒæ•¸</li>
<li>é€éæŒ‡å®šå‡é™½æ€§æ©Ÿç‡ï¼Œç®—å¾—æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸</li>
<li>é€é std å…§å»ºçš„ <a href="http://doc.rust-lang.org/std/collections/hash_map/struct.RandomState.html"><code>RandomState</code></a> ç”¢ç”Ÿå…©å€‹ä¸åŒåˆå§‹ç‹€æ…‹çš„é›œæ¹Šå‡½æ•¸ï¼Œä»¥æ¨¡æ“¬ $k$ å€‹é›œæ¹Šå‡½æ•¸</li>
<li>åˆå§‹åŒ–ä¸€å€‹å…¨é›¶çš„ä½å…ƒé™£åˆ—</li>
</ol>
<h3><a class="header" href="#æ–°å¢" id="æ–°å¢">æ–°å¢</a></h3>
<p>æ–°å¢ä¸€å€‹å…ƒç´ åˆ° Bloom filterï¼Œèªªç©¿äº†å°±åšä¸€ä»¶äº‹ï¼šå°‡å…ƒç´ é€é $k$ å€‹é›œæ¹Šå‡½æ•¸ï¼Œç”¢å‡º $k$ å€‹ç´¢å¼•ä½ç½®ï¼Œä¸¦å°‡ä½å…ƒé™£åˆ—ä¸Šé€™äº›ä½ç½®çš„ä½å…ƒç¿»è½‰è‡³ 1ã€‚</p>
<p>æ•´å€‹ <code>insert</code> å‡½æ•¸å³ç‚ºè¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ æ¨¡æ“¬ $k$ å€‹é›œæ¹Šå‡½æ•¸çš„éç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn insert(&amp;mut self, elem: &amp;T)
where
    T: Hash,
{
    let hashes = self.make_hash(elem);  // #1
    for fn_i in 0..self.hash_fn_count { // #2
        let index = self.get_index(hashes, fn_i as u64); // #3
        self.bits[index] = true;        // #4
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å–å¾— $h_1(x)$ å’Œ $h_2(x)$ çš„é›œæ¹Šè¼¸å‡ºçµæœã€‚</li>
<li>è¿­ä»£ <code>i</code> æ¬¡ï¼Œ<code>i</code> ä¸Šé™ç‚º $k$ï¼šåˆå§‹åŒ–æ™‚æ‰€å¾—çš„æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸</li>
<li>è¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ å–å¾—ç´¢å¼•ä½ç½®</li>
<li>å°‡ç´¢å¼•ä½ç½®ä¸‹çš„ä½å…ƒè¨­å®šç‚º 1</li>
</ol>
<p>é€™è£¡æœ‰å…©å€‹å…§éƒ¨æ–¹æ³•ï¼Œå…ˆè¬›è§£å¦‚ä½•è¨ˆç®— $h_1(x)$ å’Œ $h_2(x)$ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn make_hash(&amp;self, elem: &amp;T) -&gt; (u64, u64)
where
    T: Hash,
{
    // #1
    let hasher1 = &amp;mut self.hashers[0].clone();
    let hasher2 = &amp;mut self.hashers[1].clone();

    // #2
    elem.hash(hasher1);
    elem.hash(hasher2);

    // #3
    (hasher1.finish(), hasher2.finish())
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>ç‚ºä¿å­˜å…©å€‹ hasher å…§éƒ¨åˆå§‹ç‹€æ…‹ï¼Œä½¿ç”¨ <code>clone</code> è¤‡è£½æ–°çš„ hasher ä¾†åšé›œæ¹Š</li>
<li>å°‡ <code>elem</code> é¤µçµ¦ hasher è¨ˆç®—é›œæ¹Šå€¼</li>
<li>è¼¸å‡ºé›œæ¹Šå€¼ï¼Œç”±æ–¼ <a href="http://doc.rust-lang.org/core/hash/trait.Hasher.html#tymethod.finish"><code>Hasher::finish</code></a> ä¸æœƒé‡è¨­ hasher å…§éƒ¨ç‹€æ…‹ï¼Œæ‰€ä»¥éœ€è¦æ­¥é©Ÿä¸€ <code>clone</code> ä¾†ä¿ç•™ hasher çš„åŸå§‹ç‹€æ…‹</li>
</ol>
<p>å†ä¾†æ˜¯å¯¦ä½œè¨ˆç®—ç´¢å¼•ä½ç½® $g_i(x) = h_1(x) + ih_2(x)$ï¼Œé€™å€‹å‡½æ•¸éå¸¸å–®ç´”ï¼Œå°±æ˜¯è¼¸å…¥ <code>make_hash</code> æ‰€å¾—ä¹‹é›œæ¹Šå€¼ï¼Œç„¶å¾Œå¸¶å…¥å…¬å¼ä¸­ã€‚ç‚ºäº†é˜²æ­¢è¼¸å‡ºçš„ç´¢å¼•ä½ç½®è¶…éä½å…ƒé™£åˆ—çš„ä½å…ƒæ•¸ï¼Œé€™è£¡ä»¥ä½å…ƒæ•¸ $m$ å–æ¨¡ï¼ˆ<code>%</code> moduloï¼‰ï¼ŒåŠ ä¸Šä½¿ç”¨ <code>wrapping_ops</code> é€™äº› modular arithmetic operation é”æˆã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn get_index(&amp;self, (h1, h2): (u64, u64), fn_i: u64) -&gt; usize {
    (h1.wrapping_add(fn_i.wrapping_mul(h2)) % self.bits.len() as u64) as usize
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#æŸ¥è©¢" id="æŸ¥è©¢">æŸ¥è©¢</a></h3>
<p>æŸ¥è©¢å…ƒç´ æ˜¯å¦åœ¨ Bloom filter è£¡é¢ï¼Œå°±æ˜¯çœ‹çœ‹è©²å…ƒç´ é€é $k$ å€‹é›œæ¹Šå‡½æ•¸è¼¸å‡ºçš„æ¯å€‹ç´¢å¼•ä½ç½®<strong>å…¨éƒ¨ç‚º 1</strong>ï¼Œå‰‡å¯èƒ½å­˜åœ¨ï¼›å¦å‰‡å°±æ˜¯çµ•å°ä¸å­˜åœ¨ã€‚</p>
<p>å¯¦ä½œæ­¥é©Ÿå’Œæ’å…¥éå¸¸ç›¸ä¼¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn contains(&amp;self, elem: &amp;T) -&gt; bool
where
    T: Hash,
{
    let hashes = self.make_hash(elem); // #1
    (0..self.hash_fn_count).all(|fn_i| { // #1 ä½¿ç”¨ iter
        let index = self.get_index(hashes, fn_i as u64);
        self.bits[index]
    })
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å–å¾— $h_1(x)$ å’Œ $h_2(x)$ çš„é›œæ¹Šè¼¸å‡ºçµæœã€‚</li>
<li>ä½¿ç”¨ <a href="http://doc.rust-lang.org/1.45.2/core/iter/trait.Iterator.html#method.all">Iterator::all</a> è¿­ä»£æ”¶é›† $k$ å€‹é›œæ¹Šå‡½æ•¸çš„è¼¸å‡º</li>
<li>è¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ å–å¾—ç´¢å¼•ä½ç½®</li>
<li>å›å‚³ç´¢å¼•ä½ç½®ä¸‹çš„ä½å…ƒ <code>bool</code> å€¼ï¼Œæ­¤å€¼æœƒåŒ¯é›†èµ·ä¾†ï¼Œæ–¼æ­¥é©ŸäºŒç¢ºèªå‘½ä¸­å…¨éƒ¨ $k$ å€‹ç´¢å¼•ï¼Œå³ç‚ºå…ƒç´ å­˜åœ¨</li>
</ol>
<p>å®Œæ•´ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼Œæˆ–è½‰é§•åˆ° <a href="/doc/rust_algorithm_club/collections/struct.BloomFilter.html">API æ–‡ä»¶</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BloomFilter&lt;T: ?Sized&gt; {
    bits: Vec&lt;bool&gt;,
    hash_fn_count: usize,
    hashers: [DefaultHasher; 2],
    _phantom: PhantomData&lt;T&gt;,
}

impl&lt;T: ?Sized&gt; BloomFilter&lt;T&gt; {
    pub fn new(capacity: usize, err_rate: f64) -&gt; Self {
        let bits_count = Self::optimal_bits_count(capacity, err_rate);
        let hash_fn_count = Self::optimal_hashers_count(err_rate);
        let hashers = [
            RandomState::new().build_hasher(),
            RandomState::new().build_hasher(),
        ];

        Self {
            bits: vec![false; bits_count],
            hash_fn_count,
            hashers,
            _phantom: PhantomData,
        }
    }

    pub fn insert(&amp;mut self, elem: &amp;T)
    where
        T: Hash,
    {
        // g_i(x) = h1(x) + i * h2(x)
        let hashes = self.make_hash(elem);
        for fn_i in 0..self.hash_fn_count {
            let index = self.get_index(hashes, fn_i as u64);
            self.bits[index] = true;
        }
    }

    pub fn contains(&amp;self, elem: &amp;T) -&gt; bool
    where
        T: Hash,
    {
        let hashes = self.make_hash(elem);
        (0..self.hash_fn_count).all(|fn_i| {
            let index = self.get_index(hashes, fn_i as u64);
            self.bits[index]
        })
    }

    fn get_index(&amp;self, (h1, h2): (u64, u64), fn_i: u64) -&gt; usize {
        (h1.wrapping_add(fn_i.wrapping_mul(h2)) % self.bits.len() as u64) as usize
    }

    fn make_hash(&amp;self, elem: &amp;T) -&gt; (u64, u64)
    where
        T: Hash,
    {
        let hasher1 = &amp;mut self.hashers[0].clone();
        let hasher2 = &amp;mut self.hashers[1].clone();

        elem.hash(hasher1);
        elem.hash(hasher2);

        (hasher1.finish(), hasher2.finish())
    }

    /// m = -1 * (n * ln Îµ) / (ln 2)^2
    fn optimal_bits_count(capacity: usize, err_rate: f64) -&gt; usize {
        let ln_2_2 = std::f64::consts::LN_2.powf(2f64);
        (-1f64 * capacity as f64 * err_rate.ln() / ln_2_2).ceil() as usize
    }

    /// k = -log_2 Îµ
    fn optimal_hashers_count(err_rate: f64) -&gt; usize {
        (-1f64 * err_rate.log2()).ceil() as usize
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#æ•ˆèƒ½" id="æ•ˆèƒ½">æ•ˆèƒ½</a></h2>
<table><thead><tr><th>Notation</th><th>Description</th></tr></thead><tbody>
<tr><td>$n$</td><td>é æœŸå„²å­˜ $n$ å€‹å…ƒç´ åˆ°å®¹å™¨ä¸­</td></tr>
<tr><td>$m$</td><td>ä½¿ç”¨ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ä¾†å„²å­˜</td></tr>
<tr><td>$k$</td><td>æœ‰ $k$ å€‹é›œæ¹Šå‡½æ•¸è¨ˆç®—ç´¢å¼•ä½ç½®</td></tr>
<tr><td>$\epsilon$</td><td>å‡é™½æ€§éŒ¯èª¤çš„æ©Ÿç‡ $\epsilon$</td></tr>
</tbody></table>
<p>å’Œå¸¸è¦‹çš„å®¹å™¨è³‡æ–™çµæ§‹ä¸å¤ªä¸€æ¨£ï¼Œè¤‡é›œåº¦å’Œ $n$ å…ƒç´ å€‹æ•¸è„«é‰¤ï¼Œè€Œæ˜¯å’Œ $k$ å’Œ $m$ ç›¸é—œï¼š</p>
<table><thead><tr><th>Operation</th><th>Time complexity</th></tr></thead><tbody>
<tr><td>insert(v)</td><td>$O(k)$</td></tr>
<tr><td>contains(v)</td><td>$O(k)$</td></tr>
</tbody></table>
<p>è€Œå„²å­˜ç©ºé–“è¤‡é›œåº¦å‰‡æ˜¯ $O(m)$ã€‚</p>
<p>æ–°å¢å’Œæœå°‹ä¸€å€‹å…ƒç´ å€‹åˆ¥éœ€è¦é›œæ¹Š $k$ æ¬¡ï¼Œå› æ­¤æ™‚é–“è¤‡é›œåº¦ç‚º $O(k)$ é¡¯è€Œæ˜“è¦‹ï¼Œç„¶è€Œï¼Œ$k$ é€šå¸¸ç›¸å° $m$ $n$ æ˜¯éå¸¸å°çš„æ•¸å­—ï¼Œä¾‹å¦‚
<a href="https://hur.st/bloomfilter/?n=1M&amp;p=0.001&amp;m=&amp;k=">åœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiB å’Œ 7 å€‹é›œæ¹Šå‡½æ•¸</a>ï¼Œå¯¦å‹™ä¸Šç›´æ¥ç•¶ä½œ $O(1)$ ä¹Ÿä¸ç®—éŒ¯ã€‚</p>
<p>è‡³æ–¼ç©ºé–“è¤‡é›œåº¦ï¼Œç”±æ–¼å¿…é ˆäº‹å…ˆé…ç½®å¥½ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ï¼Œå°±ç®—æ–°å¢çš„å…ƒç´  $n \gt m$ï¼Œä¹Ÿä¸æœƒå†æ–°å¢æ–°ä½å…ƒï¼Œå› æ­¤ç©ºé–“ä½¿ç”¨ç‚º $O(m)$ å€‹ä½å…ƒã€‚å¯¦å‹™ä¸Šï¼Œç•¶ $n$ æˆé•·åˆ°æ¥è¿‘ $m$ æ™‚ï¼Œå‡é™½æ€§çš„æ©Ÿç‡æœƒå¤§å¢ï¼Œä¸å ªä½¿ç”¨ï¼Œé€²è€Œéœ€è¦èƒ½å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“çš„ Bloom filter è®Šå½¢ã€‚</p>
<h2><a class="header" href="#è®Šå½¢" id="è®Šå½¢">è®Šå½¢</a></h2>
<p>ç¶“å…¸æ¬¾ Bloom filter å®¹æ˜“å¯¦ä½œï¼Œæ­·ä¹…ä¸è¡°ï¼Œä¸éä»æœ‰è¨±å¤šå¯ä»¥å¢é€²ç©ºé–“ï¼š</p>
<ul>
<li>Data locality ä¸å¤ å¥½ï¼šBloom filter åº•å±¤å„²å­˜æ˜¯ä½å…ƒé™£åˆ—<a href="https://en.wikipedia.org/wiki/Random_access">éš¨æ©Ÿå­˜å–</a>ï¼Œè¼ƒä¸ç¬¦åˆç¾ä»£ CPU æ¶æ§‹çš„ cache line ä½¿ç”¨å§¿å‹¢ã€‚Cloudflare æŠ€è¡“éƒ¨è½æ ¼æ–‡ <a href="https://blog.cloudflare.com/when-bloom-filters-dont-bloom/">When Bloom filters donâ€™t bloom</a> ä»¥å¹½é»˜ç­†æ³•å¸¶å‡ºé€™å€‹å•é¡Œï¼Œå€¼å¾—ä¸€è®€ã€‚</li>
<li>é›œæ¹Šæ¬¡æ•¸éå¤šï¼šBloom filter æ¯ä¸€å€‹æ–°å¢æŸ¥è©¢æ“ä½œéƒ½éœ€è¦é›œæ¹Š $k$ æ¬¡ï¼Œå°±ç®—åˆ©ç”¨ double hashing é‚„æ˜¯è¦é›œæ¹Šå…©æ¬¡ï¼Œæ¯”èµ·å…¶ä»–é¡ä¼¼è³‡æ–™çµæ§‹ç¡¬ç”Ÿç”Ÿå¤šé›œæ¹Šæ•¸æ¬¡ã€‚</li>
<li>ä½å…ƒé™£åˆ—å¤§å°å›ºå®šï¼šBloom filter å®¹å™¨å¤§å°å›ºå®šï¼Œçµ¦ä½ é æœŸçš„å…ƒç´ å€‹æ•¸å¾Œï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ï¼Œ</li>
<li>bits per entry è¼ƒé«˜ï¼šä»¥é¡ä¼¼åŠŸèƒ½çš„çš„è³‡æ–™çµæ§‹ä¾†èªªï¼ŒBloom filter åœ¨ç©ºé–“åˆ©ç”¨ç‡ä¸Šï¼Œæ¬²ç¶­æŒä¸€å®šçš„å‡é™½æ€§æ©Ÿç‡ï¼Œæ¯å€‹å…ƒç´ æ‰€éœ€ä½å…ƒæ•¸ç›¸å°è¼ƒé«˜ï¼Œéœ€è¦ $1.44 \log_2{\frac{1}{\epsilon}}$ å€‹ä½å…ƒã€‚</li>
</ul>
<p>é€™è£¡ä»‹ç´¹å¹¾æ¬¾å˜—è©¦è§£æ±ºä¸Šè¿°å•é¡Œçš„ filterï¼Œæ‚¨ä¹Ÿå¯ä»¥å» <a href="https://en.wikipedia.org/wiki/Bloom_filter#Extensions_and_applications">Wikipedia çœ‹çœ‹å…¶ä»–æ›´å¤šè®Šå½¢çš„ä»‹ç´¹</a>ã€‚</p>
<h3><a class="header" href="#å¯ä»¥è¨ˆæ•¸çš„-counting-bloom-filter" id="å¯ä»¥è¨ˆæ•¸çš„-counting-bloom-filter">å¯ä»¥è¨ˆæ•¸çš„ Counting Bloom filter</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Counting_Bloom_filter">ğŸ“š ç¶­åŸºç™¾ç§‘</a></p>
<p>ç¶“å…¸æ¬¾ Bloom filter ä¹‹æ‰€ä»¥ç„¡æ³•åˆªé™¤å…ƒç´ ï¼Œæ˜¯å› ç‚ºæ²’æœ‰è¨˜éŒ„å“ªäº›å…ƒç´ æ–°å¢/åˆªé™¤çš„è³‡è¨Šï¼Œè€Œ Counting Bloom filter é¡§åæ€ç¾©ï¼ŒåŸæœ¬ç”¨ä¸€å€‹ä½å…ƒå„²å­˜ 0 / 1 è³‡è¨Šï¼Œå»¶ä¼¸ç‚ºå¤šä½å…ƒæ–¹ä¾¿å„²å­˜è¨ˆæ•¸ï¼ˆcountingï¼‰ï¼Œæœ‰äº†å€‹åˆ¥å…ƒç´ å¢åˆªè³‡è¨Šï¼ŒBloom filter å› æ­¤èƒ½å¯¦ä½œã€Œåˆªé™¤å…ƒç´ ã€ã€‚æœå°‹ä¸€å€‹ Counting Bloom filter æ˜¯å¦æ“æœ‰ n æ¬¡ä»¥ä¸Š xï¼Œç­”æ¡ˆä¸€æ¨£å’Œ Bloom filter é¡ä¼¼æ˜¯ã€Œå¯èƒ½æœ‰ n æ¬¡ä»¥ä¸Šçš„ xã€æˆ–æ˜¯ã€Œx çµ•å°æ²’æœ‰ n æ¬¡ä»¥ä¸Šã€ã€‚äº‹å¯¦ä¸Šï¼Œå¯å°‡ Counting Bloom filter è¦–ç‚º Bloom filter çš„ä¸€èˆ¬åŒ–å½¢å¼ï¼ˆgeneralized formï¼‰ï¼Œè€Œç¶“å…¸æ¬¾ Bloom filter åéä¾†å¯ç•¶ä½œåªè¨˜ä¸€æ¬¡æ•¸çš„ç‰¹åŒ–ã€‚</p>
<p>ä½† Counting Bloom filter çš„ç¼ºé»æ˜¯ç©ºé–“éœ€æ±‚å¤§ï¼Œç«¯çœ‹æ±ºå®šè¦ç”¨å¹¾å€‹ä½å…ƒè¨ˆæ•¸ï¼Œä¾‹å¦‚å¸¸è¦‹ç”¨ 4 å€‹ä½å…ƒè¨ˆæ•¸ï¼Œå‰‡æ˜¯ç¶“å…¸æ¬¾çš„å››å€ç©ºé–“æ¶ˆè€—ã€‚</p>
<h3><a class="header" href="#å‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°çš„-scalable-bloom-filter" id="å‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°çš„-scalable-bloom-filter">å‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°çš„ Scalable Bloom Filter</a></h3>
<p><a href="https://gsd.di.uminho.pt/members/cbm/ps/dbloom.pdf">ğŸ“š è«–æ–‡é€£çµ</a></p>
<p>Scalable Bloom Filter çš„ç‰¹è‰²æ˜¯ï¼šå‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°ï¼Œä¸éœ€äº‹å…ˆçŸ¥é“é æœŸå„²å­˜çš„å…ƒç´ å€‹æ•¸ã€‚</p>
<p>Scalable Bloom Filter çš„å¯¦ä½œè »æš´åŠ›çš„ï¼Œæœ¬èº«æ˜¯ç”±ä¸€è‡³å¤šå€‹ç¶“å…¸æ¬¾ Bloom filter çµ„æˆï¼Œè‹¥ä¸€å€‹ filter æ»¿äº†ï¼ˆè¶…é fill ratioï¼‰ï¼Œå‰‡æœƒæ–°å¢ä¸€å€‹ filterï¼Œå¾€å¾Œæ‰€æœ‰æ–°å¢éƒ½åœ¨é€™å€‹æ–° filter ä¸Šé¢ï¼Œç›´åˆ°å®ƒä¹Ÿæ»¿äº†ï¼Œå¯è¦–ç‚ºä¸€å€‹ recursive data structureã€‚</p>
<p>è‡³æ–¼æŸ¥è©¢ï¼Œé€™å°±æ˜¯ Scalable Bloom Filter æ¯”è¼ƒå¼±çš„åœ°æ–¹ï¼ŒæŸ¥è©¢æœƒå¾ç¬¬ä¸€å€‹ filter é–‹å§‹æ‰¾ï¼Œè‹¥æ‰¾ä¸åˆ°å¾€ä¸‹ä¸€å€‹ filter æ‰¾ï¼Œæ‰¾åˆ°æœƒæ²’æœ‰ä¸‹ä¸€å€‹ filter ç‚ºæ­¢ã€‚è‹¥ filter æ•¸é‡ç‚º $l$ï¼Œå‰‡æŸ¥è©¢çš„æ™‚é–“è¤‡é›œåº¦å¾ $O(k)$ è®Šæˆ $O(k \cdot l)$ã€‚</p>
<p>é™¤äº†åˆå§‹åŒ–å¤§å°å’Œå‡é™½æ€§æ©Ÿç‡ç‡ï¼ŒScalable Bloom Filter æä¾›è¨­å®šæˆé•·ç‡å’Œå‡é™½æ€§éŒ¯èª¤ç·Šç¸®ç‡ï¼š</p>
<ul>
<li>æˆé•·å› å­ $s$ï¼šæ¯å€‹æ–°å¢çš„ filter ç©ºé–“å¤§å°æˆé•·ç‡ï¼Œè«–æ–‡çš„ç¶“é©—æ³•å‰‡å¾—å‡ºé æœŸå°æˆé•·è¶¨å‹¢é¸æ“‡ $s = 2$ï¼Œæœ‰è¼ƒå¤§æˆé•·è¶¨å‹¢å‰‡ $s = 4$ æ•ˆæœå¥½ã€‚</li>
<li>éŒ¯èª¤ç·Šç¸®ç‡ $r$ï¼š æ¯å€‹æ–°å¢çš„ filter æœƒä»¥ç­‰æ¯”ç´šæ•¸å¾—åˆ°æ›´ç·Šç¸®çš„å‡é™½æ€§æ©Ÿç‡ä¸Šé™ï¼Œç”±æ–¼æ˜¯ç­‰æ¯”ç´šæ•¸ï¼Œé€¼è¿‘æ¥µé™æ™‚æœƒå°æ–¼åŸå§‹æ©Ÿç‡ï¼Œé€™è®“æ•´é«”å‡é™½æ€§æ©Ÿç‡å¾—ä»¥ä¿æŒã€‚è«–æ–‡ä¸­å¯¦è­‰ 0.8 åˆ° 0.9 åœ¨å…ƒç´ é æœŸæœ‰å¤§æˆé•·ç‡ä¸‹æœ‰æœ€ä½³å¹³å‡ç©ºé–“åˆ©ç”¨ç‡ã€‚</li>
</ul>
<h3><a class="header" href="#quotient-filter" id="quotient-filter">Quotient filter</a></h3>
<p><a href="http://vldb.org/pvldb/vol5/p1627_michaelabender_vldb2012.pdf">ğŸ“š è«–æ–‡é€£çµ</a>ï¼ˆç›´æ¥è®€è«–æ–‡æ›´æ˜“æ‡‚ï¼‰</p>
<p>å•†æ•¸éæ¿¾å™¨ï¼ˆQuotient filterFï¼‰åˆ©ç”¨<a href="../hash_map">é›œæ¹Šè¡¨</a>ç‚ºåº•å±¤å„²å­˜å®¹å™¨ï¼Œä¾†åšé›†åˆæˆå“¡æª¢æ¸¬çš„ AMQï¼Œç‚ºäº†ç¯€çœç©ºé–“ä½¿ç”¨é‡ï¼ŒQuotient filter çš„é›œæ¹Šè¡¨åªå„²å­˜ partial-keyï¼Œä¿—ç¨±æŒ‡ç´‹ï¼ˆfingerprintï¼‰ï¼ŒæŒ‡ç´‹çš„éµçŸ­ç©ºé–“ç”¨é‡ä½ï¼Œå‰¯ä½œç”¨æ˜¯æ›´å®¹æ˜“ç¢°æ’ï¼Œä»£è¡¨éœ€è¦æ›´æœ‰æ•ˆè™•ç†é›œæ¹Šç¢°æ’ï¼ˆhash collisionï¼‰ã€‚</p>
<p>ä¸€èˆ¬ä¾†èªªï¼Œ<a href="../hash_map#%E8%99%95%E7%90%86%E9%9B%9C%E6%B9%8A%E7%A2%B0%E6%92%9E">è™•ç†é›œæ¹Šç¢°æ’</a>æœ‰ separate chaining å’Œ Open addressping å…©å¤§é¡æ–¹æ³•ï¼Œè€Œ Quotient filter é¸æ“‡äº†å¦ä¸€æ¢è©­è­çš„æ–¹æ³•ï¼šåˆ©ç”¨ open addressing ä¸­ linear probing çš„æ–¹å¼ï¼Œå°æ¯å€‹ slot å„²å­˜é¡å¤–è³‡è¨Šï¼Œä½¿å¾—æˆ‘å€‘å¯è¾¨èªç¢°æ’çš„å…ƒç´ æ˜¯åœ¨ç›¸åŒæŒ‡ç´‹ä¸‹çš„åŒå€‹ bucket å…§ã€‚æ›å¥è©±èªªï¼Œé¡å¤–è³‡è¨Šå°±æ˜¯åœ¨ã€Œé€é linear probing æ¨¡æ“¬ separate chainingã€ã€‚</p>
<p>å›åˆ°æŒ‡ç´‹ï¼ŒQuotient filter å¯¦éš›ä¸Šä¸¦ä¸ç›´æ¥å„²å­˜æŒ‡ç´‹ï¼Œè€Œæ˜¯å°‡æŒ‡ç´‹ $f$ é€²ä¸€æ­¥æ‹†æˆå•† $f_q$ èˆ‡é¤˜æ•¸ $f_r$ï¼Œå•†ä½œç‚ºç´¢å¼•ä½ç½®ï¼Œè€Œé¤˜æ•¸å‰‡ç‚ºçœŸå¯¦è¢«å„²å­˜çš„å€¼ã€‚é€éå•†å’Œé¤˜æ•¸ï¼Œå¯é‡çµ„å›æ¨åŸæœ¬çš„æŒ‡ç´‹ã€‚ä¸éœ€å­˜å®Œæ•´çš„æŒ‡ç´‹ï¼Œåˆå†æ¬¡æ¸›å°‘ç©ºé–“ä½¿ç”¨é‡ï¼Œå¸¥ï¼</p>
<p>ç°¡å–®ç¸½çµ Quotient filter çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>ä½¿ç”¨ linear probing è§£æ±ºé›œæ¹Šç¢°æ’ï¼Œdata locality å¥½ï¼Œæœ‰ cache friendlyã€‚</li>
<li>æœ‰é¡å¤–å„²å­˜è³‡è¨Šï¼Œå¯åœ¨ä¸é‡å»ºä¸ rehash filter çš„æƒ…æ³ä¸‹æ”¯æ´åˆªé™¤ã€åˆä½µã€èª¿æ•´ç©ºé–“ã€‚</li>
<li>ç¶œåˆä¸Šè¿°å…©é»ï¼Œéå¸¸é©åˆ LSM-tree ç­‰éœ€è¦å­˜å– SSD çš„å ´æ™¯ï¼Œå¤§å¹…æ¸›å°‘ I/Oã€‚</li>
<li>Throughput å—åˆ°é›œæ¹Šè¡¨ load factor å½±éŸ¿è¼ƒå¤§ã€‚</li>
<li>ç©ºé–“ç”¨é‡ä»æ¯”ç¶“å…¸æ¬¾ Bloom filter å¤š 10% åˆ° 25%ã€‚</li>
</ul>
<p><img src="./quotient-filter.png" alt="" /></p>
<blockquote>
<p>Quotient filter èˆ‡å®ƒç­‰åƒ¹çš„ open addressing hash map</p>
</blockquote>
<p><em>Image Source: <a href="http://vldb.org/pvldb/vol5/p1627_michaelabender_vldb2012.pdf">Bender, et al., 2012. â€œDonâ€™t Thrash: How to Cache Your Hash on Flashâ€</a>.</em></p>
<h3><a class="header" href="#æ”¯æ´åˆªé™¤å…ƒç´ çš„-cuckoo-filter" id="æ”¯æ´åˆªé™¤å…ƒç´ çš„-cuckoo-filter">æ”¯æ´åˆªé™¤å…ƒç´ çš„ Cuckoo filter</a></h3>
<p><a href="https://www.cs.cmu.edu/%7Edga/papers/cuckoo-conext2014.pdf">ğŸ“š è«–æ–‡é€£çµ</a>ï¼ˆæœ‰è¶£æ˜“è®€ï¼Œèª æ‘¯æ¨è–¦ï¼‰</p>
<p>Cuckoo hashing æ˜¯ä¸€ç¨®è§£æ±ºé›œæ¹Šç¢°æ’çš„æ–¹æ³•ï¼Œé€éä¸€æ¬¡è¨ˆç®—å…©å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿå…©å€‹ç´¢å¼•ä½ç½®ï¼Œè‹¥å…¶ä¸­ä¸€å€‹ä½ç½®æœ‰ç©ºä½å‰‡æ’å…¥ç©ºä½ï¼Œè‹¥éƒ½æ²’æœ‰ç©ºä½ï¼Œå‰‡éš¨æ©Ÿè¸¢æ‰ä¸€å€‹ï¼Œè¢«è¸¢æ‰çš„å†å»æ‰¾ä¸‹ä¸€å€‹æ›¿æ­»é¬¼ï¼Œç›´åˆ°å…¨éƒ¨éƒ½æœ‰ä½ç½®ï¼Œæˆ–è¸¢æ‰æ¬¡æ•¸å¤§æ–¼ä¸€å®šå€¼å‰‡åœæ­¢ã€‚é€™ç¨®è¡Œç‚ºå’Œæœéµ‘é³¥ï¼ˆcuckooã€å¸ƒç©€é³¥ï¼‰é³©ä½”éµ²å·¢çš„ç”Ÿç‰©ç¿’æ€§å¾ˆåƒï¼Œå› æ­¤å¾—åã€‚</p>
<p>Cuckoo filter åˆ©ç”¨<a href="./hash_map">é›œæ¹Šè¡¨</a>ç‚ºåº•å±¤å„²å­˜å®¹å™¨ï¼Œä¾†åšé›†åˆæˆå“¡æª¢æ¸¬çš„ AMQï¼Œæœƒå’Œ cuckoo æ‰¯ä¸Šé—œä¿‚å‰‡æ˜¯å› ç‚ºä½¿ç”¨ Cuckoo hashing è§£æ±ºé›œæ¹Šç¢°æ’ï¼Œä»¥å¢åŠ ç©ºé–“ä½¿ç”¨ç‡ï¼ˆé”åˆ° 95% occupancyï¼‰ã€‚Cuckoo filter çš„é›œæ¹Šè¡¨å’Œ Quotient filter ä¸€æ¨£ï¼Œç‚ºäº†æ¸›å°‘ç©ºé–“ä½¿ç”¨é‡è€Œåªå„²å­˜ partial-keyã€‚</p>
<p>å„²å­˜æŒ‡ç´‹å°è‡´éµè®ŠçŸ­ï¼Œå®¹æ˜“ç¢°æ’ï¼Œä¹Ÿä»£è¡¨è¬ä¸€ç¢°æ’ï¼Œæ²’è¾¦æ³•é€éåŸå§‹çš„éµå†æ¬¡é›œæ¹Šä¾†æ‰¾åˆ° Cuckoo hasing å°æ‡‰å¦ä¸€ä½ç½®ï¼Œä¸é Cuckoo filter å·§å¦™åˆ©ç”¨ XOR çš„ identity $x \oplus x = 0$ è§£æ±ºå•é¡Œï¼Œdouble hashing å…¬å¼å¥‰ä¸Šï¼š</p>
<p>$$
h_1(x) = hash(x) \\ 
h_2(x) = h_1(x) \oplus hash(fingerprint(x))
$$</p>
<p>å¦‚æ­¤ä¸€æ¬¡ï¼Œé€é $h_2(x)$ å’ŒæŒ‡ç´‹çš„ XOR å°±å¯ä»¥å¾—åˆ° $h_1(x)$ï¼Œå…¬å¼é€²è€Œå¯ä¸€èˆ¬åŒ–æˆï¼š</p>
<p>$$j = i \oplus hash(fingerprint(x))$$</p>
<p>å…¶ä¸­ $j$ èˆ‡ $i$ ç‚ºåŒå€‹å…ƒç´ ç¶“éå…©å€‹é›œæ¹Šå‡½æ•¸ä¸­ä»»ä¸€çš„å€¼ï¼Œç¥å¥‡å§ï¼</p>
<p>Cuckoo filter çš„ç‰¹æ€§æ˜¯ï¼š</p>
<ul>
<li>æ”¯æ´å‹•æ…‹æ–°å¢èˆ‡åˆªé™¤å…ƒæ•¸ã€‚</li>
<li>æ¯”å…¶ä»– filter è®Šå½¢ï¼ˆä¾‹å¦‚ Quotient filterï¼‰å¥½å¯¦ä½œï¼Œå¦‚æœæ‡‚ Cuckoo hashing çš„è©±ã€‚</li>
<li>æŸ¥è©¢æ•ˆèƒ½æ¯”ç¶“å…¸æ¬¾ Bloom filter å¥½ï¼Œbits per item ä¹Ÿæ¯”è¼ƒä½ï¼ˆ$(\log_2{\frac{1}{\epsilon}} + 2) / \alpha$ï¼Œ$\alpha$ æ˜¯é›œæ¹Šè¡¨çš„ load factorï¼Œé€šå¸¸ç‚º 95.5%ï¼‰ã€‚</li>
<li>ç¼ºé»æ˜¯ã€Œä¸€å®šè¦å…ˆæ–°å¢éä¸€å€‹å…ƒç´ ï¼Œæ‰èƒ½å° filter åˆªé™¤è©²å…ƒç´ ã€ï¼Œä½†é€™æ˜¯æ‰€æœ‰æ”¯æ´åˆªé™¤çš„ filter çš„é€šç—…ï¼Œä¸ç„¶å°±æœƒæœ‰å‡é™½æ€§ç™¼ç”Ÿã€‚</li>
</ul>
<p><img src="./cuckoo-filter.png" alt="" /></p>
<p><em>Image Source: <a href="https://www.cs.cmu.edu/%7Edga/papers/cuckoo-conext2014.pdf">Fan, et al., 2014. â€œCuckoo Filter: Practically Better Than Bloomâ€</a>.</em></p>
<h2><a class="header" href="#åƒè€ƒè³‡æ–™" id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</a></h2>
<ul>
<li><a href="https://citeseerx.ist.psu.edu/viewdoc/download;?doi=10.1.1.641.9096&amp;rep=rep1&amp;type=pdf">Burton H. Bloom: Space/Time Trade-offs in Hash Coding with Allowable Errors</a></li>
<li><a href="https://en.wikipedia.org/wiki/Bloom_filter">Wiki: Bloom filter</a></li>
<li><a href="https://www.eecs.harvard.edu/%7Emichaelm/postscripts/rsa2008.pdf">Less Hashing, Same Performance:Building a Better Bloom Filter</a></li>
<li><a href="https://onatm.dev/2020/08/10/let-s-implement-a-bloom-filter/">Onat: Letâ€™s implement a Bloom Filter</a></li>
<li><a href="https://github.com/google/guava/blob/v29.0/guava/src/com/google/common/hash/BloomFilter.java">Google Guava: BloomFilter</a></li>
<li><a href="https://hur.st/bloomfilter/">Bloom Filter Calculator</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../collections/set/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../CONTRIBUTING.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../collections/set/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../CONTRIBUTING.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../theme/custom.js"></script>
        

        

    </body>
</html>
