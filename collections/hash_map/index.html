<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>é›œæ¹Šè¡¨ Hash map - Rust Algorithm Club</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn algorithms and data structures with Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Rust Algorithm Club</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ’¡ åŸºç¤æ¦‚å¿µ</li><li class="chapter-item expanded "><a href="../../concepts/asymptotic-notation/index.html">æ¼¸é€²ç¬¦è™Ÿ Asymptotic Notation</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ” æœå°‹</li><li class="chapter-item expanded "><a href="../../searching/linear_search/index.html">ç·šæ€§æœå°‹ Linear search</a></li><li class="chapter-item expanded "><a href="../../searching/binary_search/index.html">äºŒå…ƒæœå°‹ Binary search</a></li><li class="chapter-item expanded "><a href="../../searching/interpolation_search/index.html">å…§æ’æœå°‹ Interpolation search</a></li><li class="chapter-item expanded "><a href="../../searching/exponential_search/index.html">æŒ‡æ•¸æœå°‹ Exponential search</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ“š æ’åº</li><li class="chapter-item expanded affix "><li class="part-title">ç°¡å–®æ’åº</li><li class="chapter-item expanded "><a href="../../sorting/insertion_sort/index.html">æ’å…¥æ’åº Insertion sort</a></li><li class="chapter-item expanded "><a href="../../sorting/selection_sort/index.html">é¸æ“‡æ’åº Selection sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bubble_sort/index.html">æ°£æ³¡æ’åº Bubble sort</a></li><li class="chapter-item expanded "><a href="../../sorting/shellsort/index.html">å¸Œçˆ¾æ’åº Shellsort</a></li><li class="chapter-item expanded affix "><li class="part-title">é«˜æ•ˆæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/heapsort/index.html">å †ç©æ’åº Heapsort</a></li><li class="chapter-item expanded "><a href="../../sorting/quicksort/index.html">å¿«é€Ÿæ’åº Quicksort</a></li><li class="chapter-item expanded "><a href="../../sorting/mergesort/index.html">åˆä½µæ’åº Mergesort</a></li><li class="chapter-item expanded affix "><li class="part-title">æ··åˆæ’åº</li><li class="chapter-item expanded "><div>ğŸš§ å…§çœæ’åº Introsort</div></li><li class="chapter-item expanded "><div>ğŸš§ è‡ªé©æ‡‰åˆä½µæ’åº Timsort</div></li><li class="chapter-item expanded "><div>ğŸš§ æ¨¡å¼æ¶ˆé™¤å¿«é€Ÿæ’åº Pdqsort</div></li><li class="chapter-item expanded affix "><li class="part-title">ç‰¹æ®Šæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/counting_sort/index.html">è¨ˆæ•¸æ’åº Counting sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bucket_sort/index.html">æ¡¶æ’åº Bucket sort</a></li><li class="chapter-item expanded "><a href="../../sorting/radix_sort/index.html">åŸºæ•¸æ’åº Radix sort</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ  è³‡æ–™çµæ§‹</li><li class="chapter-item expanded affix "><li class="part-title">å †ç–Šèˆ‡ä½‡åˆ—</li><li class="chapter-item expanded "><a href="../../collections/stack/index.html">å †ç–Š Stack</a></li><li class="chapter-item expanded "><div>ğŸš§ ä½‡åˆ— Queue</div></li><li class="chapter-item expanded "><div>ğŸš§ é›™ç«¯ä½‡åˆ— Deque</div></li><li class="chapter-item expanded affix "><li class="part-title">éˆçµä¸²åˆ—</li><li class="chapter-item expanded "><a href="../../collections/linked_list/index.html">éˆçµä¸²åˆ—æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/singly_linked_list/index.html">å–®å‘éˆçµä¸²åˆ— Singly linked list</a></li><li class="chapter-item expanded "><div>ğŸš§ é›™å‘éˆçµä¸²åˆ— Doubly linked list</div></li><li class="chapter-item expanded "><div>ğŸš§ å¾ªç’°éˆçµä¸²åˆ— Circular linked list</div></li><li class="chapter-item expanded affix "><li class="part-title">é—œè¯å®¹å™¨</li><li class="chapter-item expanded "><a href="../../collections/associative-container/index.html">é—œè¯å®¹å™¨æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/hash_map/index.html" class="active">é›œæ¹Šè¡¨ Hash map</a></li><li class="chapter-item expanded "><div>ğŸš§ æœ‰åºæ˜ å°„è¡¨ Ordered map</div></li><li class="chapter-item expanded "><div>ğŸš§ å¤šé‡æ˜ å°„è¡¨ Multimap</div></li><li class="chapter-item expanded "><a href="../../collections/set/index.html">é›†åˆ Set</a></li><li class="chapter-item expanded "><a href="../../collections/bloom_filter/index.html">å¸ƒéš†éæ¿¾å™¨ Bloom filter</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../CONTRIBUTING.html">è²¢ç»æŒ‡å—</a></li><li class="chapter-item expanded affix "><a href="../../404.html">404</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust Algorithm Club</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/weihanglo/rust-algorithm-club" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#é›œæ¹Šè¡¨-hash-map" id="é›œæ¹Šè¡¨-hash-map">é›œæ¹Šè¡¨ Hash Map</a></h1>
<p>é›œæ¹Šè¡¨æ˜¯ä»¥é›œæ¹Šå‡½æ•¸å¯¦ä½œçš„é—œè¯å®¹å™¨ã€‚é€éé›œæ¹Šå‡½æ•¸ï¼Œè¨ˆç®—éµï¼ˆkeyï¼‰å°æ‡‰åˆ°å®¹å™¨å…§éƒ¨çš„ç´¢å¼•ä½ç½®ï¼Œé€²è€Œæ‰¾åˆ°å°æ‡‰çš„å€¼ï¼ˆvalueï¼‰ã€‚ä¸€èˆ¬ä¾†èªªï¼Œé›œæ¹Šè¡¨æœ€å¸¸è¦‹çš„å¯¦ä½œæ˜¯ä»¥ä¸€å€‹ç°¡å–®é™£åˆ—å„²å­˜è³‡æ–™ã€‚</p>
<p>é›œæ¹Šè¡¨çš„å„ªå‹¢æ˜¯ï¼š</p>
<ul>
<li>åœ¨è³‡æ–™é‡å¤§æ™‚ï¼Œä»ç„¶ç¶­æŒå¸¸æ•¸æ™‚é–“çš„é«˜æ•ˆèƒ½ã€‚</li>
<li>è‹¥è³‡æ–™æ•¸é‡ä¸Šé™å·²çŸ¥ï¼Œå°±å¯é¿å…é‡æ–°é…ç½®è¨˜æ†¶é«”ï¼Œæ•ˆèƒ½æ›´ä½³ã€‚</li>
<li>è‹¥è³‡æ–™å½¢æ…‹å·²çŸ¥ï¼Œå°±å¯é‡å°è©²è³‡æ–™å½¢æ…‹æ‰¾å°‹é©åˆçš„é›œæ¹Šå‡½æ•¸æœ€ä½³åŒ–ã€‚</li>
</ul>
<p>è€Œé›œæ¹Šè¡¨ç›¸å°æœ‰ä»¥ä¸‹çŸ­è™•ï¼š</p>
<ul>
<li>è³‡æ–™é‡ä¸å¤ å¤§æ™‚ï¼Œå–®ä¸€æ“ä½œéœ€è¦é›œæ¹Šè¨ˆç®—ï¼Œé–‹éŠ·ç›¸å°é«˜ã€‚</li>
<li>æ•ˆèƒ½èˆ‡é›œæ¹Šå‡½æ•¸æ¯æ¯ç›¸é—œï¼Œè¼ƒå·®çš„å‡½æ•¸å®¹æ˜“é›œæ¹Šç¢°æ’ï¼Œè¼ƒä½³å‡½æ•¸è¨ˆç®—æˆæœ¬é€šå¸¸è¼ƒé«˜ã€‚</li>
<li>åªèƒ½ä»¥æŸç¨®å½éš¨æ©Ÿçš„é †åºè¿­ä»£é›œæ¹Šè¡¨ã€‚</li>
</ul>
<blockquote>
<p>æœ¬æ¬¡å¯¦ä½œçš„ç¨‹å¼ç¢¼ç½®æ–¼åœ¨ <a href="/doc/rust_algorithm_club/collections/struct.HashMap.html"><code>rust_algorithm_club::collections::HashMap</code></a> API æ–‡ä»¶ä¸­ã€‚</p>
</blockquote>
<h2><a class="header" href="#æ¦‚å¿µ" id="æ¦‚å¿µ">æ¦‚å¿µ</a></h2>
<p>å»ºç«‹é›œæ¹Šè¡¨çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯é…ç½®ä¸€å®šå¤§å°çš„é™£åˆ—ï¼ˆé€šå¸¸ç¨±ç‚º bucket arrayï¼‰ï¼Œä¾†å„²å­˜å°æ‡‰ç´¢å¼•çš„éµå€¼å°ã€‚æˆ‘å€‘ä»¥å»ºç«‹é›»è©±ç°¿ç‚ºä¾‹ï¼Œå„²å­˜äººåèˆ‡è™Ÿç¢¼çš„å°æ‡‰é—œä¿‚ã€‚</p>
<pre><code>Create an empty phone book with some blank slots.

          +--------------+
          | 0:           |
          +--------------+
          | 1:           |
          +--------------+
          | 2:           |
          +--------------+
          | 3:           |
          +--------------+
</code></pre>
<p>æˆ‘å€‘å˜—è©¦æ’å…¥ç¬¬ä¸€ç­†è³‡æ–™ï¼Œè¨˜éŒ„ Frodo ä»¥åŠä»–çš„æ‰‹æ©Ÿè™Ÿç¢¼ 88-7-666ã€‚</p>
<ol>
<li>é€éé›œæ¹Šå‡½æ•¸ï¼Œè¨ˆç®—å‡º Frodo çš„ç´¢å¼•å€¼ç‚º 1ã€‚</li>
<li>å°‡ 88-7-666 æ’å…¥ table[1] çš„ä½ç½®ä¸Šã€‚</li>
</ol>
<blockquote>
<p>table[1] é€™ç¨® bucket array ä¸‹çš„å€‹åˆ¥ç´¢å¼•ç©ºé–“ï¼Œé€šå¸¸ç¨±ç‚ºä¸€å€‹ slot æˆ– bucketã€‚</p>
</blockquote>
<pre><code>Fordo: hash_function(Frodo) --&gt; 1

          +-------------+
          | 0:          |
          +-------------+
Frodo --&gt; | 1: 88-7-666 |
          +-------------+
          | 2:          |
          +-------------+
          | 3:          |
          +-------------+
</code></pre>
<p>å˜—è©¦æ’å…¥å¦å¤–äºŒç­†è³‡æ–™ï¼Œè¨˜éŒ„ Sam çš„æ‰‹æ©Ÿ 11-2-333ï¼Œä»¥åŠ Gollum çš„æ‰‹æ©Ÿ 00-0-000ã€‚</p>
<ol>
<li>é€éé›œæ¹Šå‡½æ•¸ï¼Œè¨ˆç®—å‡º Sam çš„ç´¢å¼•å€¼ç‚º 2ã€‚</li>
<li>å°‡ 11-2-333 æ’å…¥ table[2] çš„ä½ç½®ä¸Šã€‚</li>
<li>é€éé›œæ¹Šå‡½æ•¸ï¼Œè¨ˆç®—å‡º Gollumn çš„ç´¢å¼•å€¼ç‚º 0ã€‚</li>
<li>å°‡ 00-0-000 æ’å…¥ table[0] çš„ä½ç½®ä¸Šã€‚</li>
</ol>
<pre><code>Sam: hash_function(Sam) --&gt; 2

          +-------------+
          | 0:          |
          +-------------+
          | 1: 88-7-666 |
          +-------------+
Sam   --&gt; | 2: 11-2-333 |
          +-------------+
          | 3:          |
          +-------------+


Gollum: hash_function(Gollum) --&gt; 0

          +-------------+
Gollum -&gt; | 0: 00-0-000 |
          +-------------+
          | 1: 88-7-666 |
          +-------------+
          | 2: 11-2-333 |
          +-------------+
          | 3:          |
          +-------------+
</code></pre>
<p>è‹¥éœ€è¦å–å¾— Sam çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œåªè¦</p>
<ol>
<li>é€éé›œæ¹Šå‡½æ•¸ï¼Œè¨ˆç®—å‡º Sam çš„ç´¢å¼•å€¼ç‚º 2ã€‚</li>
<li>å¾ table[2] çš„ç´¢å¼•ä½ç½®ä¸Šï¼Œæ‰¾åˆ° Sam çš„æ‰‹æ©Ÿè™Ÿç¢¼</li>
</ol>
<pre><code>Sam: hash_function(Sam) --&gt; 2

          +-------------+
          | 0: 00-0-000 |
          +-------------+
          | 1: 88-7-666 |
          +-------------+
Sam   --&gt; | 2: 11-2-333 | --&gt; Sam's phone number
          +-------------+
          | 3:          |
          +-------------+
</code></pre>
<p>é€™å°±æ˜¯æœ€åŸºæœ¬ï¼Œä»¥é™£åˆ—å¯¦ä½œçš„é›œæ¹Šè¡¨äº†ã€‚</p>
<p>ç„¶è€Œï¼Œä½ å¯èƒ½å·²ç¶“é–‹å§‹å¥½å¥‡äº†ã€‚</p>
<ul>
<li>é›œæ¹Šæ˜¯ä»€éº¼ï¼Ÿæ€éº¼çŸ¥é“è¦æ˜ å°„åˆ°å“ªå€‹ç´¢å¼•ä½ç½®ï¼Ÿ</li>
<li>é›œæ¹Šå‡½æ•¸æ˜¯å¦æœƒè¨ˆç®—å‡ºç›¸åŒçš„ç´¢å¼•å€¼ï¼Ÿè¦å¦‚ä½•è§£æ±ºï¼Ÿ</li>
<li>è‹¥é å…ˆé…ç½®çš„é™£åˆ—å¡«æ»¿äº†ï¼Œè©²å¦‚ä½•è™•ç†ï¼Ÿ</li>
</ul>
<p>æ¥ä¸‹ä¾†ï¼Œå°‡æ¢è¨é€™å¹¾å€‹é­”è¡“èˆ¬çš„å› å­ï¼Œå¾ç°¡å–®ä»‹ç´¹é›œæ¹Šå‡½æ•¸ï¼Œåˆ°å¦‚ä½•è§£æ±ºé›œæ¹Šç¢°æ’ï¼Œæœ€å¾Œæ¢è¨é™£åˆ—å¡æ»¿é‡é…ç½®è§£æ±ºæ–¹æ¡ˆã€‚</p>
<blockquote>
<p>è¨»ï¼šé›œæ¹Šè¡¨ä¹Ÿå¯ä»¥æœå°‹æ¨¹ç­‰å…¶ä»–è³‡æ–™çµæ§‹å¯¦ä½œï¼Œåœ¨æ­¤ä¸æ·±å…¥è¨è«–ã€‚</p>
</blockquote>
<h3><a class="header" href="#é›œæ¹Š" id="é›œæ¹Š">é›œæ¹Š</a></h3>
<p>æ‰€è¬‚çš„é›œæ¹Šå‡½æ•¸ï¼Œå°±æ˜¯ä¸€ç¨®å°‡ã€Œè¼ƒå¯¬çš„å®šç¾©åŸŸæ˜ å°„åˆ°è¼ƒçª„å€¼åŸŸã€çš„å‡½æ•¸ã€‚ç°¡å–®ä¾†èªªï¼Œå°±æ˜¯è¼¸å…¥ä»»æ„å€¼åˆ°æ­¤å‡½æ•¸ï¼Œå‰‡è¼¸å‡ºå€¼æœƒè½åœ¨ä¸€å·²çŸ¥ç¯„åœã€‚å†ç™½è©±ä¸€é»ï¼Œé›œæ¹Šå‡½æ•¸å°±æ˜¯ç”¨ä¾†ã€ŒåŒ–ç¹ç‚ºç°¡ã€ï¼ŒæŠŠè¤‡é›œå¤šè®Šçš„æ±è¥¿ï¼Œé€éå‡½æ•¸ç”Ÿæˆç°¡åŒ–ç‰ˆæœ¬ã€‚æ­¤å¤–ï¼Œç›¸åŒçš„è¼¸å…¥éµï¼Œå¿…é ˆå¾—åˆ°ç›¸åŒçš„è¼¸å‡ºé›œæ¹Šå€¼ï¼Œé€™æ˜¯é›œæ¹Šå‡½æ•¸å¾ˆé‡è¦çš„ä¸€å€‹ç‰¹æ€§ï¼Œä»¥è™›æ“¬ç¢¼è¡¨ç¤ºï¼š</p>
<pre><code>key1 == key2 -&gt; hash(key1) == hash(key2)
</code></pre>
<p>ã€Œæ˜ å°„ã€é€™éƒ¨åˆ†åªæ˜¯ä½¿ç”¨é›œæ¹Šçš„ä¸€å°æ­¥ã€‚é›œæ¹Šè¡¨æ ¹æ“šç¨‹å¼å¯¦ä½œçš„ä¸åŒï¼Œåº•å±¤å„²å­˜è³‡æ–™çš„å½¢å¼ä¹Ÿä¸ç›¡ç›¸åŒï¼Œç‚ºäº†å®Œå…¨æ”¾å…¥é™£åˆ—ä¸­ï¼Œé€šå¸¸æœƒå°é›œæ¹Šå€¼ï¼ˆé›œæ¹Šå‡½æ•¸çš„è¨ˆç®—çµæœï¼‰å–æ¨¡ï¼ˆmoduloï¼‰ã€‚ä¹Ÿå°±æ˜¯èªªï¼šå‡è¨­æœ‰é•·åº¦ç‚º <em>n</em> çš„é™£åˆ—ã€‚1ï¼‰å…ˆå° key å–é›œæ¹Šå€¼ã€‚2ï¼‰å†å°é›œæ¹Šå€¼å–æ¨¡ï¼Œç¢ºèªç´¢å¼•å€¼è½åœ¨é™£åˆ—å…§éƒ¨ã€‚</p>
<pre><code>Assumed: array_size = n

hash_value = hash_function(key) // 1

index = hash_value % array_size // 2
</code></pre>
<p>å¦‚æ­¤ä¸€ä¾†ï¼Œæ‰€æœ‰å¯èƒ½çš„å€¼éƒ½æœƒè½åœ¨é™£åˆ—å…§ï¼Œé€™å°±æ˜¯æœ€ç°¡å–®æ™®éçš„é›œæ¹Šå…©æ­¥é©Ÿï¼šè¨ˆç®—é›œæ¹Šå€¼ï¹¢å–æ¨¡ã€‚</p>
<h3><a class="header" href="#é¸æ“‡é›œæ¹Šå‡½æ•¸" id="é¸æ“‡é›œæ¹Šå‡½æ•¸">é¸æ“‡é›œæ¹Šå‡½æ•¸</a></h3>
<p>æ¥ä¸‹ä¾†ï¼Œä½ æœƒç·Šæ¥è‘—å‘å•ç¬¬äºŒå€‹å•é¡Œã€Œå‡½æ•¸è¨ˆç®—å‡ºç›¸åŒç´¢å¼•å€¼è©²æ€éº¼è¾¦ï¼Ÿã€ä¸åŒè¼¸å…¥ç”¢ç”Ÿç›¸åŒé›œæ¹Šå€¼ï¼Œå¤šå€‹å€¼æ˜ å°„åˆ°åŒå€‹ç´¢å¼•ä¸Šï¼Œé€™ç¨®ç‹€æ³ç§‘å­¸å®¶ç¨±ä¹‹<strong>é›œæ¹Šç¢°æ’ï¼ˆhash collisionï¼‰</strong>ã€‚</p>
<p>é¦–å…ˆï¼Œè¦ç­è§£é›œæ¹Šå‡½æ•¸æœ¬èº«å°±æ˜¯æ™‚ç©ºé–“çš„æ¬Šè¡¡ï¼Œå¦‚æœè¨˜æ†¶é«”ç©ºé–“å¤ å¤šï¼Œé‚£è®“è¼¸å…¥å€¼èˆ‡é›œæ¹Šå€¼å‘ˆä¸€å°ä¸€çš„å®Œç¾é—œä¿‚ï¼Œå°±ä¸æœƒå‡ºç¾ç¢°æ’ï¼›å¤§å¤šæ•¸æƒ…æ³ï¼Œå°¤å…¶æ˜¯å¯¦ä½œæ³›ç”¨çš„é›œæ¹Šå‡½å¼åº«ï¼Œç„¡æ³•é æœŸè¼¸å…¥è³‡æ–™çš„ç¯„åœï¼Œå¯¦å‹™ä¸Šæœƒé–å®šä¸€å€‹è¼¸å‡ºé›œæ¹Šå€¼çš„ç¯„åœï¼Œåƒ§å¤šç²¥å°‘ï¼Œé›£å…ç¢°æ’ã€‚</p>
<p>å¥½çš„é›œæ¹Šå‡½æ•¸é‚„å¿…é ˆç¬¦åˆä¸€äº›æ¢ä»¶ï¼š</p>
<ol>
<li>åŒä¸€ç­†è¼¸å…¥è³‡æ–™ï¼Œå¿…é ˆå¾—åˆ°ç›¸åŒçš„é›œæ¹Šå€¼ã€‚</li>
<li>çµæœå¿…é ˆèƒ½å¤ é«˜æ•ˆçš„è¨ˆç®—å‡ºä¾†ï¼ˆé æœŸç‚ºå¸¸æ•¸æ™‚é–“ï¼‰ã€‚</li>
<li>ä»»æ„è¼¸å…¥è³‡æ–™æ‰€å¾—ä¹‹é›œæ¹Šå€¼åœ¨å€¼åŸŸå…§éœ€æ¥è¿‘<a href="https://en.wikipedia.org/wiki/Uniform_distribution_(continuous)">å‡å‹»åˆ†ä½ˆï¼ˆuniform distributionï¼‰</a>ï¼Œæ‰èƒ½æ¸›å°‘ç¢°æ’æ©Ÿç‡ã€‚</li>
</ol>
<p>ä½†ç¸½æ­¸ä¸€å¥ï¼Œæ¬²é”æˆä¸Šè¿°æ¢ä»¶ï¼Œå°±æ˜¯ä¸€ç¨®æ¬Šè¡¡å–æ¨ï¼Œä¾‹å¦‚ï¼Œ<a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">åŠ å¯†é›œæ¹Šå‡½æ•¸ï¼ˆcryptographic hash functionï¼‰</a>å³æ˜¯éå¸¸å„ªç§€çš„é›œæ¹Šå‡½æ•¸ï¼Œä½†ç›¸å°éœ€ä»˜å‡ºæ›´é«˜çš„è¨ˆç®—æˆæœ¬ã€‚</p>
<p>æ›´å¤šé›œæ¹Šå‡½æ•¸ç›¸é—œçš„è¨è«–ï¼Œæœƒå¦æ’°<a href="../../hash">å°ˆæ–‡</a>ã€‚</p>
<h3><a class="header" href="#è™•ç†é›œæ¹Šç¢°æ’" id="è™•ç†é›œæ¹Šç¢°æ’">è™•ç†é›œæ¹Šç¢°æ’</a></h3>
<p>æ—¢ç„¶é›œæ¹Šå‡½æ•¸äººç”Ÿåœ¨ä¸–é›£å…ç¢°æ’ï¼Œç§‘å­¸å®¶ä¹Ÿç ”ç©¶å¹¾å€‹è™•ç†é›œæ¹Šç¢°æ’çš„ç­–ç•¥ï¼Œåˆ†åˆ¥æ˜¯ separate chaining èˆ‡ open addressingã€‚</p>
<p><strong>Separate chaining</strong> å¯ä»¥èªªæ˜¯æœ€ç›´è§€çš„åšæ³•ï¼Œå°±æ˜¯è¨­æ³•è®“åŒä¸€å€‹ç´¢å¼•ä¸‹ï¼Œå¯ä»¥å„²å­˜å¤šå€‹ç¢°æ’çš„å€¼ã€‚ä¾æ“šå„²å­˜è³‡æ–™çš„å½¢å¼ï¼Œå¯åˆ†ç‚ºå¹¾ç¨®å¯¦ä½œï¼š</p>
<ul>
<li><strong>éˆçµä¸²åˆ—</strong>ï¼šä»¥<a href="../linked_list">éˆçµä¸²åˆ—ï¼ˆlinked listï¼‰</a>å„²å­˜å…ƒç´ ã€‚ç™¼ç”Ÿç¢°æ’æ™‚ï¼Œæ–°çš„å…ƒç´ ä¸²æ¥åœ¨æ—¢æœ‰å…ƒç´ ä¹‹å¾Œã€‚</li>
<li><strong>å‹•æ…‹é™£åˆ—</strong>ï¼šæ–°å¢å…ƒç´ æ™‚ï¼Œåœ¨è©²ä½å€é…ç½®<a href="../dynamic_array">å‹•æ…‹é™£åˆ—ï¼ˆdynamic arrayï¼‰</a>å„²å­˜å…ƒç´ ã€‚ç™¼ç”Ÿç¢°æ’æ™‚ï¼Œç›´æ¥å°‡æ–°å…ƒç´ åŠ åœ¨é™£åˆ—å°¾ç«¯ã€‚</li>
</ul>
<p>ä¸åŒå¯¦ä½œæ–¹å¼æœ‰å„è‡ªå„ªç¼ºé»ï¼Œä¾‹å¦‚ä¸²åˆ—ç‰ˆæœ¬å®¹æ˜“å¯¦ä½œï¼Œä½†éœ€é¡å¤–å„²å­˜æŒ‡æ¨™è³‡è¨Šï¼›ç”¨å‹•æ…‹é™£åˆ—ï¼Œå‰‡æœƒæœ‰æ›´å¥½çš„ CPU cachingï¼Œä½†ç›¸å°åœ°ç¢°æ’éå¤šå‰‡éœ€è¦é‡é…ç½®é™£åˆ—ã€‚</p>
<p>ä»¥ ASCII è¡¨è¿°ä½¿ç”¨ä¸²åˆ—å¯¦ä½œ separate chaining ç¤ºæ„åœ–å¦‚ä¸‹ï¼š</p>
<pre><code>... assumed hash values of Gimli and Gollum collided.

                          +----------------+
                      +-&gt; |Gollum, 00-0-000| (linked list)
                      |   +----------------+
                      |            |
Gimli -+              |            v
       |              |   +---------------+
       |  +--------+  |   |Gimli, 99-9-999|
Gollum --&gt;|0: ptr  |--+   +---------------+
          +--------+
Frodo  --&gt;|1: ptr  |----&gt; +---------------+ 
          +--------+      |Frodo, 88-7-666|
Sam    --&gt;|2: ptr  |--+   +---------------+
          +--------+  |
          |3: null |  +-&gt; +---------------+
          +--------+      | Sam, 11-2-333 |
     (main bucket array)  +---------------+
</code></pre>
<p>è€Œé€™é‚Šä¹Ÿæœ‰ç²¾ç¾çš„å¯¦ä½œç¤ºæ„åœ–ï¼Œå°‡ä¸²åˆ—é¦–å€‹å…ƒç´  head ç›´æ¥æ”¾ç½®åœ¨ slot ä¸­çš„ä½œæ³•ï¼Œæ¸›å°‘ä¸€æ¬¡æŒ‡æ¨™æ“ä½œã€‚</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Hash_table_5_0_1_1_1_1_0_LL.svg/1280px-Hash_table_5_0_1_1_1_1_0_LL.svg.png" alt="" /></p>
<p><em>(åˆ©ç”¨ separate chaining å¯¦ä½œçš„é›œæ¹Šè¡¨ï¼Œä¸¦å°‡ä¸²åˆ—ç¬¬ä¸€å€‹å…ƒç´ æ”¾åœ¨ bucket array ä¸­)</em></p>
<p>å¦ä¸€æ–¹é¢ <strong>Open addressing</strong> å‰‡èµ°å®Œå…¨ä¸åŒçš„å¥—è·¯ï¼Œä¸é¡å¤–é…ç½®å„²å­˜ç©ºé–“çµ¦ç¢°æ’çš„å…ƒç´ ï¼Œè€Œæ˜¯ç¹¼çºŒåœ¨åŒå€‹é™£åˆ—å…§ã€Œæ¢æ¸¬ã€å…¶ä»–å¯ç”¨çš„ slotï¼Œå†æŠŠè³‡æ–™å¡é€²å°šæœªè¢«ä½”æ“šçš„ slot ä¸­ã€‚è€Œ Open addressing ä¾æ“šä¸åŒæ¢æ¸¬åºåˆ—ï¼ˆprobe sequenceï¼‰æœ‰ä¸åŒå¯¦ä½œï¼Œå¸¸è¦‹çš„æœ‰ï¼š</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Linear_probing"><strong>Linear probing</strong></a>ï¼šå¾ç™¼ç”Ÿç¢°æ’ç´¢å¼•é–‹å§‹ï¼Œä¾åºå¾€ä¸‹ä¸€å€‹ slot æ¢æ¸¬æ˜¯å¦å¯ç”¨ï¼Œå› æ­¤å¾—åã€Œç·šæ€§ã€ã€‚</li>
<li><a href="https://en.wikipedia.org/wiki/Quadratic_probing"><strong>Quadratic probing</strong></a>ï¼šå¾ç¢°æ’ç´¢å¼•é–‹å§‹ï¼Œé–“éš”ä»¥äºŒæ¬¡å¼å¢åŠ å¾€ä¸‹æ¢æ¸¬å¯ç”¨ slotï¼Œå¦‚ $i + 1^2, i + 2^2, i + 3^2$ã€‚</li>
<li><a href="https://en.wikipedia.org/wiki/Double_hashing"><strong>Double hashing</strong></a>ï¼šä»¥å›ºå®šé–“éš”å¤§å° $k$ï¼ˆprobe distanceï¼‰ï¼Œä¾åºæ¢æ¸¬ $i + k, i + k \cdot 2 ...$ çš„ slot æ˜¯å¦ç‚ºç©ºã€‚è€Œé€™å€‹é–“éš”æ˜¯ä»¥å¦å¤–ä¸€å€‹é›œæ¹Šå‡½æ•¸è¨ˆç®—æ‰€å¾—ï¼Œå› æ­¤å¾—åã€Œé›™é›œæ¹Šã€ã€‚</li>
</ul>
<blockquote>
<p>$i$ ç‚ºç™¼ç”Ÿç¢°æ’çš„ç´¢å¼•ä½ç½®ã€‚</p>
</blockquote>
<p>é€™äº›æ–¹æ³•çš„å·®ç•°ä¸»è¦åœ¨æ–¼ CPU caching çš„æ•ˆèƒ½ï¼Œä»¥åŠ HashMap è³‡æ–™çš„ç¾¤èšæ•ˆæ‡‰ï¼ˆclusteringï¼‰çš„æ•æ„Ÿç¨‹åº¦ã€‚ç•¶ç„¶ï¼Œè«– caching çµ•å°é linear probing è«å±¬ï¼Œä½† linear probing ä»¥ç·šæ€§ä¸€å€‹æŒ¨ä¸€å€‹æ¢å‹˜ï¼Œæ•ˆèƒ½è¼ƒå®¹æ˜“å—é›œæ¹Šå€¼ç¾¤èšå½±éŸ¿ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ linear probingï¼ˆé–“éš” = 1ï¼‰çš„ç¤ºæ„åœ–ã€‚</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/HASHTB12.svg/1280px-HASHTB12.svg.png" alt="" /></p>
<h3><a class="header" href="#å‹•æ…‹èª¿æ•´é›œæ¹Šè¡¨å¤§å°" id="å‹•æ…‹èª¿æ•´é›œæ¹Šè¡¨å¤§å°">å‹•æ…‹èª¿æ•´é›œæ¹Šè¡¨å¤§å°</a></h3>
<p>è‹¥è³‡æ–™çš„ç­†æ•¸å·²çŸ¥ï¼Œé‚£åˆå§‹é…ç½®çš„é™£åˆ—å¤§å°è¨­å®šèˆ‡è³‡æ–™ç­†æ•¸æˆæ¯”ä¾‹ï¼Œå°±ä¸å¿…æ“”å¿ƒé›œæ¹Šè¡¨ç©ºé–“ä¸å¤ ï¼Œéœ€è¦é‡æ–°é…ç½®ï¼ˆreallocateï¼‰å„²å­˜ç©ºé–“çš„å›°æ“¾ã€‚å€˜è‹¥è³‡æ–™é‡æœªçŸ¥ï¼Œè€Œæœ€åˆé…ç½®çš„ bucket array æ»¿äº†ï¼Œè©²å¦‚ä½•é‡æ–°é…ç½®å‘¢ï¼Ÿ</p>
<p>å‹•æ…‹èª¿æ•´å¤§å°å°é›œæ¹Šè¡¨ä¾†èªªï¼Œä¸åŒæ–¼ä¸€èˆ¬å‹•æ…‹é™£åˆ—ï¼ŒèˆŠçš„é›œæ¹Šè¡¨è‹¥è¦å°æ‡‰åˆ°æ–°é›œæ¹Šè¡¨ï¼Œæ˜¯æ¯å€‹éµéƒ½éœ€è¦é‡æ–°è¨ˆç®—é›œæ¹Šå€¼ï¼ˆrehashï¼‰ï¼Œæˆæœ¬ç›¸å°è¼ƒé«˜ã€‚å› æ­¤ï¼Œæ¸›å°‘å‹•æ…‹èª¿æ•´çš„æ¬¡æ•¸ï¼Œå¯èªªæ˜¯èª¿æ•™é›œæ¹Šè¡¨çš„é‡é»ä¹‹ä¸€ã€‚èªªåˆ°èª¿æ•™é›œæ¹Šè¡¨ï¼Œå¿…å®šè¦ç­è§£ä¸€å€‹é‡è¦æŒ‡æ¨™ï¼š<em>load factor</em>ã€‚</p>
<p>$$\text{load factor} = \frac{n}{k}$$</p>
<blockquote>
<p>$n$ï¼šå·²æ”¾å…¥é›œæ¹Šè¡¨å…§çš„è³‡æ–™ç¸½æ•¸ã€‚<br />
$k$ï¼šé›œæ¹Šè¡¨é…ç½®çš„å„²å­˜ç©ºé–“ï¼ˆbucket ç¸½æ•¸ï¼‰ã€‚</p>
</blockquote>
<p>Load factor ä»£è¡¨ç›®å‰é›œæ¹Šè¡¨çš„ã€Œä½¿ç”¨ç‡ã€ï¼Œè‹¥ä¸‰ç­†è³‡æ–™æ”¾åœ¨å››å€‹ bucket å…§ï¼Œå‰‡ load factor ç‚º $3/4 = 75%$ã€‚Load factor å¤ªå¤§æœƒæ›´å®¹æ˜“ç¢°æ’ï¼Œæœƒæœ‰æ•ˆèƒ½ä¸Šçš„å½±éŸ¿ï¼›å¤ªå°å‰‡ä»£è¡¨éå¤šå†—é¤˜ç©ºé–“æ²’æœ‰ä½¿ç”¨ã€‚å¦‚ä½•ç¶­æŒ load factor åœ¨ä¸€å®šç¯„åœå…§è‡³é—œé‡è¦ã€‚ä¸€èˆ¬ä¾†èªªï¼Œ75% çš„ load factor å°±å¯ä»¥æº–å‚™é‡æ–°é…ç½®é›œæ¹Šè¡¨äº†ï¼Œç•¶ç„¶ï¼Œé€™å€‹é–€æª»ä»è¦ä»¥å¯¦ä½œç¶“é©—ç‚ºä¸»ï¼Œä¾‹å¦‚ Rust çš„ <a href="https://doc.rust-lang.org/stable/std/collections/hash_map/index.html"><code>HashMap</code></a> ä½¿ç”¨äº† <a href="https://github.com/rust-lang/rust/blob/1.29.0/src/libstd/collections/hash/map.rs#L82-L103">Robin Hood Hashing</a>ï¼Œå°‡ load factor èª¿æ•™åˆ° 90%ã€‚</p>
<p>é‡é…ç½®é›œæ¹Šè¡¨èˆ‡å‹•æ…‹é™£åˆ—çš„å‹•æ…‹èª¿æ•´å¤§å°é›·åŒï¼Œé”åˆ°æŸå€‹é–€æª»å€¼ï¼Œå°±æœƒå°‡åº•å±¤é™£åˆ—å¤§å°ç¿»å€ã€‚ç‚ºäº†é¿å…é–‹éŠ·éé«˜ï¼Œé€šå¸¸å…ƒç´ æ¸›å°‘æ™‚ï¼Œä¸æœƒä¸»å‹•èª¿æ•´å¤§å°ï¼Œè€Œæ˜¯æä¾›ä¸€å€‹ <code>shrink_to_fit</code> ä¸€é¡çš„æ–¹æ³•ï¼Œè®“å‘¼å«ç«¯è‡ªè¡Œæ±ºå®šé‡‹æ”¾å¤šé¤˜ç©ºé–“çš„æ™‚æ©Ÿã€‚</p>
<h2><a class="header" href="#æ¶æ§‹è¨­è¨ˆ" id="æ¶æ§‹è¨­è¨ˆ">æ¶æ§‹è¨­è¨ˆ</a></h2>
<p>åœ¨ä»‹ç´¹æ¶æ§‹è¨­è¨ˆä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä¾†ç­è§£ Rust é›œæ¹Šç›¸é—œçš„è§€å¿µèˆ‡ traitã€‚</p>
<h3><a class="header" href="#hash-and-eq" id="hash-and-eq">Hash and Eq</a></h3>
<p>è¦å¯¦ä½œé›œæ¹Šå‡½æ•¸ï¼Œç•¶ç„¶å¯ä»¥è‡ªå¹¹è¨ˆç®—é›œæ¹Šå€¼çš„å‡½å¼ä¾†ç”¨ï¼Œé‚£ç‚ºä»€éº¼é‚„è¦ä½¿ç”¨ Rust å®šç¾©å¥½çš„ <a href="https://doc.rust-lang.org/std/hash/trait.Hash.html"><code>Hash</code></a> å‘¢ï¼Ÿç•¶ç„¶æ˜¯å¸Œæœ›å°‡é›œæ¹Šçš„ä»‹é¢æŠ½è±¡åŒ–ï¼Œåªè¦å‹åˆ¥å®£å‘Šç¬¦åˆ <code>Hash</code> traitï¼Œä»»ä½•äººéƒ½å¯ä»¥è¼•é¬†è¨ˆç®—é›œæ¹Šå€¼ã€‚è€Œå¯¦ä½œ <a href="https://doc.rust-lang.org/std/hash/trait.Hash.html"><code>Hash</code></a> å¾ˆç°¡å–®ï¼Œåªè¦å¯«ä¸€å€‹ <code>fn hash()</code>ï¼Œå‘¼å«ç«¯å°±èƒ½é€éå®ƒè¨ˆç®—é›œæ¹Šï¼Œä¾‹å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::hash::{Hash, Hasher};

struct Car {
  brand: String,
}

impl Hash for Car {
    fn hash&lt;H: Hasher&gt;(&amp;self, state: &amp;mut H) {
        self.brand.hash(state);
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>å…‰æ˜¯è¨ˆç®—é›œæ¹Šå€¼é‚„ä¸å¤ ï¼Œè¦ç¢ºå®šã€Œç•¶éµç›¸ç­‰æ™‚ï¼Œå…¶é›œæ¹Šå€¼ä¹Ÿç›¸ç­‰ã€é€™æ¥µç‚ºé‡è¦çš„é›œæ¹Šç‰¹æ€§ï¼Œé€™æ™‚å€™é™¤äº†å¯¦ä½œ <code>Hash</code> traitï¼Œ<code>Eq</code> trait ä¹Ÿè¦åŒæ™‚å¯¦ä½œï¼Œè©²å‹åˆ¥æ‰èƒ½å¤ ã€Œè¢«æ¯”è¼ƒã€ï¼Œæ¨™æº–å‡½å¼åº«çš„ <code>HashMap</code> çš„éµå°±æ˜¯å¯¦ä½œ <code>Hash + Eq</code> çš„å‹åˆ¥ï¼Œè©³æƒ…è«‹åƒé–± trait çš„æ–‡ä»¶èªªæ˜ã€‚</p>
<p>ç¶œåˆä»¥ä¸Šï¼Œå¯ä»¥å¤§è†½å®šè«–ï¼Œæˆ‘å€‘å°‡å¯¦ä½œçš„é›œæ¹Šè¡¨çš„ key ä¸€å®šç¬¦åˆ <code>K: Hash + Eq</code>ï¼Œkey æœ¬èº«æ‰èƒ½ç›¸äº’æ¯”è¼ƒï¼ˆå¯¦ä½œ <code>Eq</code>ï¼‰ï¼Œä¸¦é–‹æ”¾å‘¼å«ç«¯è‡ªå®šç¾©å‹åˆ¥å¯¦ä½œä¸åŒçš„é›œæ¹Šè¨ˆç®—æ–¹å¼ï¼ˆå¯¦ä½œ <code>Hash</code>ï¼‰ã€‚</p>
<p>ç‚ºäº†æ–¹ä¾¿è¨ˆç®—é›œæ¹Šå€¼ï¼Œæˆ‘å€‘å¯«äº†ä¸€å€‹è¼”åŠ©å‡½å¼ï¼Œä»¥é”æˆé›œæ¹Šå…©æ­¥é©Ÿï¼š<strong>è¨ˆç®—é›œæ¹Šå€¼ï¹¢å–æ¨¡</strong>ã€‚å…¶ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨äº† Rust é è¨­çš„é›œæ¹Šæ¼”ç®—æ³• <a href="https://doc.rust-lang.org/std/collections/hash_map/struct.DefaultHasher.html">DefaultHasher</a>ï¼Œçœä¸‹å¯¦ä½œé›œæ¹Šå‡½æ•¸çš„åŠŸå¤«ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn make_hash&lt;X&gt;(x: &amp;X, len: usize) -&gt; Option&lt;usize&gt;
    where X: Hash + ?Sized,                   // 1
{
    if len == 0 { return None; }              // 2
    let mut hasher = DefaultHasher::new();    // 3
    x.hash(&amp;mut hasher);
    Some(hasher.finish() as usize % len)
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li><code>X</code> æ³›å‹åƒæ•¸é™¤äº† <code>Hash</code>ï¼Œé‚„å¿…é ˆæ˜¯ <a href="https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait">Dynamically Sized Type</a>ï¼ˆDSTï¼Œå‹åˆ¥è¨˜ä½œ <code>?Sized</code>ï¼‰</li>
<li>é˜²æ­¢ä»¥ 0 å–æ¨¡ï¼ˆ<code>%</code> moduloï¼‰ï¼Œé™¤æ•¸ä¸èƒ½ç‚º 0ã€‚</li>
<li>Rust çš„ hasher æ˜¯ä¸€ç‹€æ…‹æ©Ÿï¼Œæ¯é¤µä»–åƒè³‡æ–™ï¼Œ<code>hasher.finish()</code> ç”¢ç”Ÿçš„é›œæ¹Šå€¼å°±ä¸åŒï¼Œç‚ºäº†ç¢ºä¿é›œæ¹Šç›¸åŒï¼Œé€™è£¡æ¯æ¬¡å‘¼å«å°±å»ºç«‹ä¸€å€‹å…¨æ–°çš„ hasherã€‚</li>
</ol>
<blockquote>
<p>æ‰€è¬‚ <strong>Dynamically Sized Typesï¼ˆDSTsï¼‰</strong> æ˜¯æŒ‡ç„¡æ³•éœæ…‹å¾—çŸ¥å¤§å°çš„å‹åˆ¥ï¼Œä¾‹å¦‚ sliceï¼Œæˆ–æ˜¯ä¸€å€‹å‡½å¼çš„åƒæ•¸æ¥å—å¯¦ä½œæŸå€‹ trait å‹åˆ¥ï¼ˆ<a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html">trait object</a>ï¼‰ï¼Œè€Œåœ¨ Rust å¹¾ä¹æ‰€æœ‰åŸºç¤å‹åˆ¥é è¨­éƒ½æ˜¯ <code>Sized</code> ç·¨è­¯æœŸå°±å¯å¾—çŸ¥å¤§å°ã€‚è€Œåœ¨é€™è£¡æˆ‘å€‘ä¸é—œå¿ƒçŸ¥é“å¯¦ä½œè©²å‹åˆ¥å¯å¦éœæ…‹æ±ºå®šå¤§å°ï¼Œåªéœ€çŸ¥é“å®ƒæ˜¯å¦å¯¦ä½œ <code>Hash</code>ï¼Œæ‰€ä»¥æ˜ç¢ºæ·»åŠ  <code>?Sized</code> è¡¨ç¤ºæ¥å— DSTsã€‚</p>
</blockquote>
<h3><a class="header" href="#è¨˜æ†¶é«”ä½ˆå±€" id="è¨˜æ†¶é«”ä½ˆå±€">è¨˜æ†¶é«”ä½ˆå±€</a></h3>
<p>æˆ‘å€‘å˜—è©¦å»ºç«‹å¯ä»¥å„²å­˜ key-value pair çš„çµæ§‹é«”ï¼Œè£¡é¢é…ç½®ä¸€å€‹ bucket array <code>buckets</code>ã€‚å…¶ä¸­ <code>K</code> æ³›å‹åƒæ•¸æ˜¯æº–å‚™è¨ˆç®—é›œæ¹Šçš„éµï¼Œè€Œ <code>V</code> å‰‡æ˜¯èˆ‡éµé…å°çš„è³‡æ–™ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct HashMap&lt;K, V&gt; where K: Hash + Eq {
    buckets: Vec&lt;(K, V)&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>å¯æ˜¯ï¼Œç”¨å–®ä¸€ <code>Vec</code> å„²å­˜æ‰€æœ‰è³‡æ–™ï¼Œè¬ä¸€é›œæ¹Šç¢°æ’ï¼Œä¸åŒéµæŒ‡å‘åŒå€‹ç´¢å¼•å€¼è©²å¦‚ä½•ï¼Ÿé€™æ¬¡å…ˆæŒ‘é¸ç›¸å°å®¹æ˜“çš„æ–¹æ¡ˆ separate chaining è™•ç†ç¢°æ’ï¼Œä¸¦ä»¥ <code>Vec</code> å‹•æ…‹é™£åˆ—ä½œç‚ºæ¯å€‹ bucket å„²å­˜ç¢°æ’å…ƒç´ çš„å®¹å™¨ï¼Œå› æ­¤ï¼Œ<code>buckets</code> é™£åˆ—è£¡é¢æ”¹å­˜ <code>Bucket</code> é™£åˆ—ï¼Œè€Œ <code>Bucket</code> å‰‡å„²å­˜çœŸæ­£çš„ key-value pairã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>type Bucket&lt;K, V&gt; = Vec&lt;(K, V)&gt;;              // 1

pub struct HashMap&lt;K, V&gt; where K: Hash + Eq {
   buckets: Vec&lt;Bucket&lt;K, V&gt;&gt;,                // 2
   len: usize,                                // 3
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å®£å‘Š bucket çš„å‹åˆ¥ <code>Bucket</code>ï¼Œå¯¦éš›ä¸Šæ˜¯ä¸€å€‹ type alias æŒ‡å‘å„²å­˜éµå€¼ <code>(K, V)</code> çš„å‹•æ…‹é™£åˆ—ã€‚</li>
<li>å°‡ <code>HashMap.buckets</code> æ”¹ç‚ºå„²å­˜ <code>Bucket</code> çš„å‹•æ…‹é™£åˆ—ã€‚</li>
<li>æ–°å¢ <code>len</code> è¨˜éŒ„å®¹å™¨ç•¶å‰éµå€¼å°æ•¸ç›®ï¼Œåœ¨å¢åˆªè³‡æ–™æ™‚ï¼Œ <code>len</code> éƒ½æœƒåŒæ­¥æ›´æ–°ã€‚</li>
</ol>
<p>ä¹‹æ‰€ä»¥ä½¿ç”¨é¡å¤–çš„æˆå“¡è¨˜éŒ„è³‡æ–™æ•¸ç›®ï¼Œæ˜¯ç‚ºäº†è¨ˆç®—æ•¸ç›®èƒ½åœ¨ O(1) æ™‚é–“å…§å®Œæˆï¼Œnested array å‹•æ…‹è¿­ä»£æ¯å€‹ <code>Bucket</code> è¨ˆç®—çš„æˆæœ¬å¤ªé«˜ã€‚</p>
<p>é€™å°±æ˜¯ <strong>Vector-based separate chaining HashMap</strong> çš„è¨˜æ†¶é«”ä½ˆå±€ï¼Œä¾†çœ‹å¼µç²¾ç¾çš„é›œæ¹Šè¡¨æ¶æ§‹ä½ˆå±€åœ–å§ï¼</p>
<p><img src="layout.svg" alt="" /></p>
<h2><a class="header" href="#åŸºæœ¬æ“ä½œ" id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</a></h2>
<p>é›œæ¹Šè¡¨æœ‰ä»¥ä¸‹å¹¾å€‹åŸºæœ¬æ“ä½œï¼š</p>
<ul>
<li><code>new</code>ï¼šåˆå§‹åŒ–ä¸€å€‹ç©ºé›œæ¹Šè¡¨ã€‚</li>
<li><code>with_capacity</code>ï¼šé…ç½®ç‰¹å®šæ•¸é‡ bucket çš„é›œæ¹Šè¡¨ã€‚</li>
<li><code>get</code>ï¼šå–å¾—æŒ‡å®šéµå°æ‡‰çš„è³‡æ–™ã€‚</li>
<li><code>get_mut</code>ï¼šå–å¾—æŒ‡å®šéµå°æ‡‰çš„è³‡æ–™ï¼Œä¸¦å¯å¯«å…¥ä¿®æ”¹ï¼ˆmutableï¼‰ã€‚</li>
<li><code>insert</code>ï¼šåœ¨ä»»æ„ä½ç½®æ’å…¥ä¸€çµ„éµå€¼å°ã€‚</li>
<li><code>remove</code>ï¼šç§»é™¤ä»»æ„ä½ç½®ä¸‹çš„éµå€¼å°ã€‚</li>
<li><code>clear</code>ï¼šæ¸…é™¤æ‰€æœ‰éµå€¼å°ã€‚</li>
<li><code>is_empty</code>ï¼šæª¢æŸ¥é›œæ¹Šè¡¨æ˜¯å¦æ²’æœ‰ä»»ä½•éµå€¼å°ã€‚</li>
<li><code>len</code>ï¼šæª¢æŸ¥ç›®å‰éµå€¼å°çš„æ•¸ç›®ã€‚</li>
<li><code>bucket_count</code>ï¼šæª¢æŸ¥ç›®å‰ bucket çš„æ•¸ç›®ã€‚</li>
</ul>
<p>ä»¥åŠå¹¾å€‹å…§éƒ¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>try_resize</code>ï¼šæ ¹æ“šçµ¦å®šæ¢ä»¶ï¼Œæ±ºå®šèª¿æ•´ bucket æ•¸ç›®çš„æ™‚æ©Ÿï¼Œè®“ load factor ç¶­æŒæœ€é©ç‹€æ…‹ã€‚</li>
<li><code>make_hash</code>ï¼šå¾è¼¸å…¥è³‡æ–™ç”¢ç”Ÿé›œæ¹Šå€¼ï¼Œå†æ¨¡é™¤ bucket æ•¸ï¼Œå¾—åˆ°è¼¸å…¥è³‡æ–™å°æ‡‰çš„ç´¢å¼•ä½ç½®ã€‚</li>
</ul>
<p>æ¥ä¸‹ä¾†è§£é‡‹å¯¦ä½œçš„é‡é»ã€‚</p>
<h3><a class="header" href="#åˆå§‹åŒ–èˆ‡é è¨­å€¼" id="åˆå§‹åŒ–èˆ‡é è¨­å€¼">åˆå§‹åŒ–èˆ‡é è¨­å€¼</a></h3>
<p>é›œæ¹Šè¡¨åˆå§‹åŒ–ç›¸å°å®¹æ˜“ï¼Œä¸€æ¨£æ…£ä¾‹ä½¿ç”¨ <code>new</code>ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;K, V&gt; HashMap&lt;K, V&gt; where K: Hash + Eq {
    pub fn new() -&gt; Self {
        Default::default()
    }
    /// ...
}

impl&lt;K, V&gt; Default for HashMap&lt;K, V&gt; 
    where K: Hash + Eq 
{
    fn default() -&gt; Self { 
        Self { buckets: Vec::&lt;Bucket&lt;K, V&gt;&gt;::new(), len: 0 }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>é€™è£¡ç‚ºäº†ç¬¦åˆäººå› å·¥ç¨‹ï¼Œä½¿ç”¨äº† <a href="https://doc.rust-lang.org/std/default/trait.Default.html"><code>Default</code></a> trait è¨­å®šåˆå§‹å€¼ã€‚æ­¤å¤–ï¼Œç”±æ–¼ Rust çš„å®¹å™¨å‹åˆ¥æ…£ä¾‹ä¸Šæ²’æœ‰ä»»ä½•å…ƒç´ æ™‚ï¼Œä¸æœƒé…ç½®ä»»ä½•è¨˜æ†¶é«”ç©ºé–“ï¼Œåƒ…æœ‰åˆå§‹çš„ pointerã€‚ HashMap åˆå§‹åŒ–å¾Œï¼Œè¨˜æ†¶é«”ç©ºé–“åƒ…éœ€</p>
<ul>
<li><code>buckets</code> çš„ <code>Vec</code> ä½”æ“š 3 å€‹ usize å¤§å°ï¼ˆä¸€å€‹ heap æŒ‡æ¨™ï¼Œå…©å€‹è¨˜éŒ„å®¹é‡èˆ‡é•·åº¦çš„ usizeã€‚</li>
<li><code>len</code> æœ¬èº«ä½”æ“š 1 å€‹ usize å¤§å°ã€‚</li>
</ul>
<p>æ‰€ä»¥é è¨­åˆå§‹åŒ–çš„ HashMap åœ¨ 64bit machine ä¸Šä½” 4 * usize = 32 bytesã€‚</p>
<p>ç‚ºäº†å¾ŒçºŒå¯¦ä½œ resize å®¹æ˜“äº›ï¼ŒåŒæ™‚å¯¦ä½œäº†æŒ‡å®š bucket æ•¸ç›®çš„å»ºæ§‹å¼ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn with_capacity(cap: usize) -&gt; Self {
    let mut buckets: Vec&lt;Bucket&lt;K, V&gt;&gt; =  Vec::new();
    for _ in 0..cap {
        buckets.push(Bucket::new());
    }
    Self { buckets, len: 0 }
} 
<span class="boring">}
</span></code></pre></pre>
<p>å¾ˆæ¸…æ¥šåœ°ï¼ŒåŒæ¨£å»ºç«‹ä¸€å€‹ç©ºçš„ bucket arrayï¼Œå†é å…ˆé…ç½®çµ¦å®šæ•¸é‡çš„ <code>Bucket</code> ã€‚<code>len</code> å‰‡å› ç‚ºæ²’æœ‰é–‹å§‹å¢åŠ æ–°å€¼ï¼Œè€Œè¨­å®šç‚º 0ã€‚</p>
<h3><a class="header" href="#å­˜å–å–®ä¸€å…ƒç´ " id="å­˜å–å–®ä¸€å…ƒç´ ">å­˜å–å–®ä¸€å…ƒç´ </a></h3>
<p>å­˜å–å…ƒç´ çš„å¯¦ä½œä¹Ÿéå¸¸ç›´è§€ï¼Œ</p>
<ol>
<li>ä½¿ç”¨ <code>make_hash</code> è¨ˆç®—å‡º key å°æ‡‰çš„ç´¢å¼•ä½ç½®ï¼Œ</li>
<li>å†é€é <code>Vec::get</code> å–å¾—è©²ç´¢å¼•ä¸‹çš„ bucketï¼Œæ‰¾ä¸åˆ°æ™‚å‰‡è¿”å› <code>None</code>ï¼Œ</li>
<li>æ‰¾åˆ° bucket å¾Œå‰‡å°æ•´å€‹ bucket ç·šæ€§æœç´¢èˆ‡ key ç›¸åŒçš„éµå€¼å°ã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn get(&amp;self, key: &amp;K) -&gt; Option&lt;&amp;V&gt; {
    let index = self.make_hash(key)?;
    self.buckets.get(index).and_then(|bucket|
        bucket.iter()
            .find(|(k, _)| *k == *key)
            .map(|(_, v)| v)
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>äº‹å¯¦ä¸Šï¼Œé€™å€‹ <code>get</code> ä¸æ˜¯éå¸¸æ–¹ä¾¿ä½¿ç”¨ï¼Œç•¶æˆ‘å€‘é€é <code>HashMep::get</code> æœå°‹ç‰¹å®šéµæ™‚ï¼Œå¿…é ˆå‚³å…¥ä¸€æ¨¡ä¸€æ¨£çš„å‹åˆ¥ï¼Œä¾‹å¦‚ <code>HashMap&lt;&amp;str, u8&gt;</code> å°±åªèƒ½é€éç›¸åŒçš„ borrowed value <code>&amp;str</code> æœç´¢ï¼Œè€Œä¸èƒ½é€é owned value <code>&amp;String</code> å°‹æ‰¾ï¼Œå°±ç®—å…©å€‹å‹åˆ¥å¯ç„¡ç—›è½‰æ›ä¹Ÿç„¡æ³•ã€‚</p>
<p>å› æ­¤æˆ‘å€‘å¯ä»¥åƒè€ƒ Rust æ¨™æº–å‡½å¼åº«ç‚ºæ³›å‹åƒæ•¸ <code>K</code> å¯¦ä½œ <a href="https://doc.rust-lang.org/stable/std/borrow/trait.Borrow.html">Borrow</a> traitï¼ŒæŠ½è±¡åŒ– owned èˆ‡ borrowed é–“çš„å‹åˆ¥ï¼Œè®“å‘¼å«ç«¯ç„¡è«–å‚³ owned æˆ– borrowed å‹åˆ¥éƒ½å¯ä»¥æœ‰ç›¸åŒçš„è¡Œç‚ºã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn get&lt;Q&gt;(&amp;self, q: &amp;Q) -&gt; Option&lt;&amp;V&gt;
    where
        K: Borrow&lt;Q&gt;,
        Q: Hash + Eq + ?Sized
{
    let index = self.make_hash(q)?;
    self.buckets.get(index).and_then(|bucket|
        bucket.iter()
            .find(|(k, _)| q == k.borrow())
            .map(|(_, v)| v)
    )
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p><code>fn get_mut()</code> èˆ‡ <code>fn get()</code> çš„å·®ç•°åªåœ¨æ–¼å‘¼å«äº† <code>self.bucket.get_mut</code> å–å¾— mutable referenceï¼Œé€™è£¡å°±ä¸å¤šåšèªªæ˜ã€‚</p>
</blockquote>
<h3><a class="header" href="#æ’å…¥èˆ‡åˆªé™¤å…ƒç´ " id="æ’å…¥èˆ‡åˆªé™¤å…ƒç´ ">æ’å…¥èˆ‡åˆªé™¤å…ƒç´ </a></h3>
<p>æ’å…¥èˆ‡åˆªé™¤æ¯”è¼ƒç‰¹åˆ¥ï¼Œéœ€è¦åšäº›é¡å¤–çš„åŠŸå¤«ï¼š</p>
<ul>
<li>åœ¨æ“ä½œå®Œæˆä¹‹å¾Œéœ€ä¾æ“šæ“ä½œçµæœå¢æ¸› <code>HashMap.len</code>ï¼Œç¢ºä¿ <code>len</code> æ°¸é è¨˜éŒ„æ­£ç¢ºçš„éµå€¼å°æ•¸ç›®ã€‚</li>
<li>åœ¨åŸ·è¡Œæ’å…¥ä¹‹å‰ï¼Œéœ€é¡å¤–ã€Œå‹•æ…‹èª¿æ•´ã€å„²å­˜ç©ºé–“ï¼Œç¢ºä¿è¨˜æ†¶é«”é…ç½®è¶³å¤ ç©ºé–“æ–°å¢å…ƒç´ ã€‚</li>
</ul>
<p>å…ˆä¾†çœ‹çœ‹åˆªé™¤æ€éº¼å¯¦ä½œã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn remove&lt;Q&gt;(&amp;mut self, q: &amp;Q) -&gt; Option&lt;V&gt;
    where
        K: Borrow&lt;Q&gt;,
        Q: Hash + Eq + ?Sized
{
    let index = self.make_hash(q)?;                     // 1
    self.buckets.get_mut(index).and_then(|bucket| {     // 2
        bucket.iter_mut()
            .position(|(k, _)| q == (*k).borrow())
            .map(|index| bucket.swap_remove(index).1)
    }).map(|v| {                                        // 3
        self.len -= 1; // Length decreases by one.
        v
    })
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>æ‰€æœ‰æ¶‰åŠæœå°‹çš„æ“ä½œï¼Œç¬¬ä¸€æ­¥ä¸€å®šæ˜¯è¨ˆç®—é›œæ¹Šå€¼ã€‚</li>
<li>å»ºç«‹ mutable çš„è¿­ä»£å™¨ï¼Œåˆ©ç”¨ <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.position"><code>posiion</code></a> æ‰¾åˆ°å°æ‡‰çš„éµå€¼å°ï¼Œå†å‘¼å« <code>Vec::swap_remove</code> ç§»é™¤ã€‚</li>
<li>å‰ä¸€æ­¥é©Ÿè‹¥æœ‰ return value ç”¢ç”Ÿï¼Œè¡¨ç¤ºç§»é™¤ä¸€å€‹å…ƒç´ ï¼Œå› æ­¤ <code>self.len</code> éœ€æ‰‹å‹•æ¸›ä¸€ã€‚</li>
</ol>
<blockquote>
<p><code>Vec::swap_remove</code> ä¸éœ€è¦ resize arrayï¼Œè€Œæ˜¯å–å¾—æœ€å¾Œä¸€å€‹å…ƒç´ å¡«è£œè©²ç©ºé–“ï¼Œç”±æ–¼é›œæ¹Šè¡¨çš„æ’åºä¸é‡è¦ï¼Œæˆ‘å€‘é¸æ“‡ <code>swap_remove</code> æ¸›å°‘ä¸€é»é–‹éŠ·ã€‚</p>
</blockquote>
<p>è€Œæ’å…¥èˆ‡ç§»é™¤éå¸¸ç›¸ä¼¼ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn insert(&amp;mut self, key: K, value: V) -&gt; Option&lt;V&gt; {
    self.try_resize();                                      // 1
    let index = self                                        // 2
        .make_hash(&amp;key)
        .expect(&quot;Failed to make a hash while insertion&quot;);
    let bucket = self.buckets
        .get_mut(index)
        .expect(&amp;format!(&quot;Failed to get bucket[{}] while insetion&quot;, index));
    match bucket.iter_mut().find(|(k, _)| *k == key) {      // 3
        Some((_ , v)) =&gt;  Some(mem::replace(v, value)),     // 3.1
        None =&gt; {
            bucket.push((key , value));                     // 3.2
            self.len += 1;
            None
        }
    }                                                       // 4
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å˜—è©¦èª¿æ•´é›œæ¹Šè¡¨å¤§å°ï¼Œä»¥ç¢ºä¿ load factor åœ¨é–¾å€¼ä¹‹é–“ã€‚</li>
<li>åŒæ¨£åœ°ï¼Œæ ¹æ“šéµè¨ˆç®—é›œæ¹Šå€¼ï¼Œä»¥å–å¾—å°æ‡‰çš„å…§éƒ¨ bucket ä½ç½®ã€‚</li>
<li>è¿­ä»£æ•´å€‹ bucket å°‹æ‰¾éµç›¸åŒçš„éµå€¼å°ã€‚
<ol>
<li>è‹¥æ‰¾åˆ°ï¼Œä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/mem/fn.replace.html"><code>mem::replace</code></a> è³‡æ–™éƒ¨åˆ†ï¼Œä¸éœ€å–ä»£æ•´å€‹éµå€¼å°ã€‚</li>
<li>è‹¥æ‰¾ç„¡ï¼Œå‰‡æ–°å¢ä¸€çµ„æ–°éµå€¼å°åˆ°è©² bucket ä¸­ï¼Œä¸¦å°‡é•·åº¦åŠ ä¸€ã€‚</li>
</ol>
</li>
<li>è‹¥æ’å…¥æ“ä½œå¯¦éš›ä¸Šæ˜¯æ›´æ–°åŸæœ‰è³‡æ–™ï¼Œå‰‡å›å‚³è¢«æ›´æ–°å‰çš„èˆŠè³‡æ–™ <code>Some((K, V))</code>ï¼Œåä¹‹å‰‡å›å‚³ <code>None</code>ã€‚</li>
</ol>
<blockquote>
<ul>
<li>åŸå‰‡ä¸Šã€Œå‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ã€æ­£ç¢ºå¯¦ä½œä¸‹ï¼Œæ­¥é©ŸäºŒçš„ <code>expect</code> ä¸æœƒç™¼ç”Ÿ panicã€‚</li>
<li><code>mem::replace</code> å¯ç•¶ä½œå°‡åŒå‹åˆ¥å…©è®Šæ•¸çš„è¨˜æ†¶é«”ä½ç½®äº’æ›ï¼Œä¹Ÿå°±åŒæ™‚æ›´æ–°äº†åŸå§‹è³‡æ–™ã€‚</li>
</ul>
</blockquote>
<h3><a class="header" href="#å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“" id="å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“">å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“</a></h3>
<p>å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“å¤§æ¦‚æ˜¯æ•´å€‹å¯¦ä½œä¸­æœ€è©­è­çš„ä¸€éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦çŸ¥é“</p>
<ul>
<li>å®¹å™¨å…§éµå€¼å°çš„ç¸½æ•¸ï¼šé€é <code>self.len</code>ï¼Œæˆ‘å€‘å°‡å–å¾— <code>self.len</code> çš„é‚è¼¯åŒ…è£åœ¨ <code>fn len(&amp;self)</code>ï¼Œä»¥å…æœªä¾†é•·åº¦ç§»å‹•è‡³åˆ¥è™•å„²å­˜è¨ˆç®—ã€‚</li>
<li>å®¹å™¨å…§ bucket çš„ç¸½æ•¸ï¼šè¨ˆç®— <code>self.bucket.len()</code>ï¼ŒåŒæ¨£åœ°ï¼Œå°‡ä¹‹åŒ…è£åœ¨ <code>fn bucket_count(&amp;self)</code>ï¼Œä¸¦é–‹æ”¾çµ¦å¤–ç•Œå‘¼å«ã€‚</li>
<li>Load factor é–¾å€¼ï¼šè¨˜éŒ„åœ¨ <code>const LOAD_FACTOR</code>ï¼Œè¨­å®šç‚º 0.75ã€‚</li>
</ul>
<p>å‰æƒ…æè¦å®Œç•¢ï¼Œæ¥ä¸‹ä¾†å°±æ˜¯ç¨‹å¼ç¢¼çš„éƒ¨åˆ†äº†ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn try_resize(&amp;mut self) {
    let entry_count = self.len();                               // 1
    let capacity = self.bucket_count();

    // Initialization.
    if capacity == 0 {                                          // 2
        self.buckets.push(Bucket::new());
        return
    }

    if entry_count as f64 / capacity as f64 &gt; LOAD_FACTOR {     // 3
        // Resize. Rehash. Reallocate!
        let mut new_map = Self::with_capacity(capacity &lt;&lt; 1);   // 4
        self.buckets.iter_mut()                                 // 5
            .flat_map(|bucket| mem::replace(bucket, vec![]))
            .for_each(|(k, v)| { new_map.insert(k, v); });
        *self = new_map;                                        // 6
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å–å¾—æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„é•·åº¦è³‡æ–™ã€‚</li>
<li>è‹¥ç•¶å‰å®¹é‡ç‚º 0ï¼Œè¡¨ç¤ºå°šæœªæ–°å¢ä»»ä½•å…ƒç´ ï¼Œæˆ‘å€‘ push ä¸€å€‹ç©º bucket é€²å»ï¼Œè®“å…¶ä»–æ“ä½œå¯ä»¥æ­£å¸¸æ–°å¢éµå€¼å°ã€‚</li>
<li>åˆ¤æ–· load factorï¼Œæ±ºå®šéœ€ä¸éœ€è¦å‹•æ…‹èª¿æ•´å¤§å°ã€‚</li>
<li>é€é <code>HashMap::with_capacity</code> å»ºç«‹å®¹é‡å…©å€å¤§çš„ç©ºé›œæ¹Šè¡¨ã€‚</li>
<li>é–‹å§‹è¿­ä»£èˆŠçš„ bucketï¼Œä¸¦åˆ©ç”¨ <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.flat_map"><code>flat_map</code></a> æ‰“å¹³ nested vectorï¼Œå†åˆ©ç”¨ <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.for_each"><code>for_each</code></a> å°‡æ¯å€‹å…ƒç´ é‡æ–° insert åˆ°æ–°é›œæ¹Šè¡¨ã€‚</li>
<li>æŠŠ <code>self</code> çš„å€¼æŒ‡å‘æ–°é›œæ¹Šè¡¨ï¼ŒèˆŠé›œæ¹Šè¡¨çš„è¨˜æ†¶é«”ç©ºé–“æœƒè¢«é‡‹æ”¾ã€‚</li>
</ol>
<h3><a class="header" href="#å¯¦ä½œè¿­ä»£å™¨æ–¹æ³•" id="å¯¦ä½œè¿­ä»£å™¨æ–¹æ³•">å¯¦ä½œè¿­ä»£å™¨æ–¹æ³•</a></h3>
<p>ä¸€å€‹é›†åˆå‹åˆ¥ç•¶ç„¶å°‘ä¸äº†ç°¡æ˜“çš„ç”¢ç”Ÿè¿­ä»£å™¨å¯¦ä½œã€‚</p>
<p>æ ¹æ“šä¹‹å‰å…¶ä»–æ–¹æ³•çš„å¯¦ä½œï¼Œè¦è¿­ä»£æ•´å€‹é›œæ¹Šè¡¨éå¸¸ç°¡å–®ï¼Œå°±æ˜¯è¿­ä»£æ‰€æœ‰ bucketï¼Œä¸¦åˆ©ç”¨ <code>flat_map</code> æ‰“å¹³ nested vectorã€‚ç°¡å–®å¯¦ä½œå¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn iter() -&gt; std::slice::Iter&lt;(&amp;k, &amp;v)&gt; {
    self.buckets.iter_mut()
        .flat_map(|b| b)
        .map(|(k, v)| (k, v))
}
<span class="boring">}
</span></code></pre></pre>
<p>ä½†æœ€çµ‚æœƒç™¼ç¾ï¼Œæˆ‘å€‘çš„ç¨‹å¼å®Œå…¨ç„¡æ³•ç·¨è­¯ï¼Œä¹Ÿç„¡æ³•ç†è§£é€™éº¼é•·çš„é–‰åŒ…ï¼ˆclosureï¼‰ç©¶ç«Ÿè¦å¦‚ä½•å¯«æ³›å‹å‹åˆ¥ã€‚å¾—äº†å§ Rustï¼Œè€å­å­¸ä¸å‹•äº†ï¼</p>
<pre><code>error[E0308]: mismatched types
   --&gt; src/collections/hash_map/mod.rs:253:9
    |
253 | /         self.buckets.iter()
254 | |             .flat_map(|b| b)
255 | |             .map(|(k, v)| (k, v))
    | |_________________________________^ expected struct `std::slice::Iter`, found struct `std::iter::Map`
    |
    = note: expected type `std::slice::Iter&lt;'_, (&amp;K, &amp;V)&gt;`
               found type `std::iter::Map&lt;std::iter::FlatMap&lt;std::slice::Iter&lt;'_, std::vec::Vec&lt;(K, V)&gt;&gt;, &amp;std::vec::Vec&lt;(K, V)&gt;, [closure@src/collections/hash_map/mod.rs:254:23: 254:28]&gt;, [closure@src/collections/hash_map/mod.rs:255:18: 255:33]&gt;`
</code></pre>
<p>å¹¸å¥½ï¼Œåœ¨ Rust 1.26 é‡‹å‡ºæ™‚ï¼Œå¤§å®¶æœŸå¾…å·²ä¹…çš„ <strong>impl trait</strong> ç©©å®šäº†ã€‚å¦‚åŒå­—é¢ä¸Šçš„æ„æ€ï¼Œimpl trait å¯ä»¥ç”¨åœ¨å‡½å¼åƒæ•¸èˆ‡å›å‚³å‹åˆ¥çš„å®£å‘Šä¸­ã€‚ä»£è¡¨é€™å€‹å‹åˆ¥æœ‰ impl å°æ‡‰çš„ traitï¼Œæ‰€ä»¥ä¸å¿…å†å¯«å‡ºè½è½é•·çš„ Iterator æ³›å‹å‹åˆ¥ã€‚impl trait æœ‰å¦ä¸€å€‹ç‰¹é»æ˜¯ä»¥éœæ…‹åˆ†æ´¾ï¼ˆstatic dispatchï¼‰ä¾†å‘¼å«å‡½å¼ï¼Œç›¸è¼ƒæ–¼ trait object çš„<a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">å‹•æ…‹åˆ†æ´¾ï¼ˆdynamic dispatchï¼‰</a>ï¼Œimpl trait æ¯«ç„¡æ•ˆèƒ½æå¤±ã€‚</p>
<p>å¯¦ä½œå¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn iter(&amp;self) -&gt; impl Iterator&lt;Item = (&amp;K, &amp;V)&gt; {
    self.buckets.iter()
        .flat_map(|b| b)
        .map(|(k, v)| (k, v))
}
<span class="boring">}
</span></code></pre></pre>
<p>æ›´å¤š impl trait ç›¸é—œè³‡è¨Šå¯ä»¥åƒè€ƒï¼š</p>
<ul>
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1522-conservative-impl-trait.md">Rust RFC: impl trait</a></li>
<li><a href="https://blog.rust-lang.org/2018/05/10/Rust-1.26.html#impl-trait">Rust 1.26: impl trait</a></li>
<li><a href="https://doc.rust-lang.org/reference/types.html#trait-objects">Rust Reference: Trait objects</a></li>
<li><a href="https://doc.rust-lang.org/book/ch17-02-trait-objects.html">The Rust Programming Language: Trait objects</a></li>
</ul>
<h2><a class="header" href="#æ•ˆèƒ½" id="æ•ˆèƒ½">æ•ˆèƒ½</a></h2>
<p>ä»¥é™£åˆ—å¯¦ä½œçš„é›œæ¹Šè¡¨å„æ“ä½œè¤‡é›œåº¦å¦‚ä¸‹</p>
<table><thead><tr><th>Operation</th><th>Best case</th><th>Worst case</th></tr></thead><tbody>
<tr><td>add(k, v)</td><td>$O(1)$~</td><td>$O(n)$</td></tr>
<tr><td>update(k, v)</td><td>$O(1)$</td><td>$O(n)$</td></tr>
<tr><td>remove(k)</td><td>$O(1)$~</td><td>$O(n)$</td></tr>
<tr><td>search(k)</td><td>$O(1)$</td><td>$O(n)$</td></tr>
</tbody></table>
<blockquote>
<p>$n$ï¼šè³‡æ–™ç­†æ•¸ã€‚<br />
$k$ï¼šæ¬²ç¶å®šè³‡æ–™çš„éµã€‚<br />
$v$ï¼šæ¬²èˆ‡éµç¶å®šçš„è³‡æ–™ã€‚<br />
<strong>~</strong>ï¼šå¹³æ”¤å¾Œçš„è¤‡é›œåº¦ï¼ˆamortizedï¼‰ã€‚</p>
</blockquote>
<h3><a class="header" href="#æ™‚é–“è¤‡é›œåº¦" id="æ™‚é–“è¤‡é›œåº¦">æ™‚é–“è¤‡é›œåº¦</a></h3>
<p>åœ¨é æœŸæƒ…æ³ä¸‹ï¼Œåªè¦é›œæ¹Šå‡½æ•¸å“è³ªç©©å®šï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½å¯é”åˆ°åœ¨å¸¸æ•¸æ™‚é–“ï¼Œ ä½†ç”±æ–¼éƒ¨åˆ†æ“ä½œï¼Œå°¤å…¶æ˜¯æ–°å¢æˆ–åˆªé™¤å…ƒç´ çš„æ“ä½œï¼Œæœƒéœ€è¦èª¿æ•´ bucket array çš„ç©ºé–“ï¼Œé‡æ–°é…ç½®è¨˜æ†¶é«”ç©ºé–“ï¼Œæ‰€ä»¥éœ€è¦å¹³æ”¤è¨ˆç®—è¤‡é›œåº¦ã€‚</p>
<p>è€Œæœ€å·®è¤‡é›œåº¦å‡ºç¾åœ¨æ¯å€‹å…ƒç´ éƒ½ç™¼ç”Ÿé›œæ¹Šç¢°æ’ã€‚è‹¥ä½¿ç”¨ open addressing è™•ç†ç¢°æ’ï¼Œå‰‡æœƒæŠŠé›œæ¹Šè¡¨é…ç½®çš„æ¯å€‹ä½ç½®éƒ½å¡«æ»¿ï¼Œè€Œæ‰€æœ‰æ“ä½œéƒ½å¾åŒå€‹ä½ç½®é–‹å§‹ï¼Œæœå°‹å°æ‡‰çš„éµï¼Œè¤‡é›œåº¦èˆ‡é™£åˆ—çš„ç·šæ€§æœç´¢ç›¸åŒç‚º $O(n)$ï¼›è‹¥ä½¿ç”¨ separate chainingï¼Œç¢°æ’ä»£è¡¨æ‰€æœ‰å…ƒç´ éƒ½æœƒåœ¨åŒä¸€å€‹ bucket è£¡é¢ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€å€‹ bucket ä¸Šæœƒæœ‰ä¸€å€‹é•·åº¦ç‚º <em>n</em> ï¼Œè¢«å¡æ»¿çš„é™£åˆ—æˆ–éˆçµä¸²åˆ—ï¼ŒçµæœåŒæ¨£æ˜¯ç·šæ€§æœç´¢çš„ $O(n)$ã€‚</p>
<p>æˆ‘å€‘å˜—è©¦ä½¿ç”¨æ•¸å­¸è¡¨ç¤ºæœç´¢çš„è¤‡é›œåº¦ã€‚å¦</p>
<ul>
<li>$n$ï¼šå·²æ”¾å…¥é›œæ¹Šè¡¨å…§çš„è³‡æ–™ç¸½æ•¸ã€‚</li>
<li>$k$ï¼šé›œæ¹Šè¡¨é…ç½®çš„å„²å­˜ç©ºé–“ï¼ˆbucket ç¸½æ•¸ï¼‰ã€‚</li>
<li>$\text{load factor} = \frac{n}{k}$ï¼šé æœŸæ¯å€‹ bucket å„²å­˜çš„è³‡æ–™ç­†æ•¸ã€‚</li>
</ul>
<p>å‰‡é æœŸåŸ·è¡Œæ™‚é–“ç‚º </p>
<p>$$\Theta(1+\frac{n}{k}) = O(1) \ \text{ if } \frac{n}{k} = O(1)$$</p>
<p>è€Œ <strong>1</strong> ç‚ºè¨ˆç®—é›œæ¹Šèˆ‡å–å¾—ç´¢å¼•ï¼ˆrandom accessï¼‰çš„åŸ·è¡Œæ™‚é–“ï¼Œ$\frac{n}{k}$ å‰‡æ˜¯æœå°‹é™£åˆ—çš„åŸ·è¡Œæ™‚é–“ã€‚åªè¦ load factor è¶Šæ¥è¿‘ $n$ï¼ŒåŸ·è¡Œæ™‚é–“å°±ç›¸å°å¢åŠ ã€‚</p>
<h3><a class="header" href="#ç©ºé–“è¤‡é›œåº¦" id="ç©ºé–“è¤‡é›œåº¦">ç©ºé–“è¤‡é›œåº¦</a></h3>
<p>é›œæ¹Šè¡¨çš„ç©ºé–“è¤‡é›œåº¦å–æ±ºæ–¼å¯¦ä½œé å…ˆé…ç½®çš„é™£åˆ—å¤§å°ï¼Œä¸¦èˆ‡ç¶­æŒ <em>load factor</em> æ¯æ¯ç›¸é—œã€‚ä¸€èˆ¬ä¾†èªªï¼Œä»èˆ‡è³‡æ–™ç­†æ•¸æˆç·šæ€§é—œä¿‚ï¼Œå› æ­¤ç©ºé–“è¤‡é›œåº¦åªæœ‰è³‡æ–™æœ¬èº« $O(n)$ã€‚è€Œä»¥ separate chaining æœƒé¡å¤–é…ç½®é™£åˆ—æˆ–éˆçµä¸²åˆ—å„²å­˜ç¢°æ’å…ƒç´ ï¼Œç†è«–ä¸Šéœ€è² æ“”æ›´å¤šé¡å¤–çš„æŒ‡æ¨™å„²å­˜ç©ºé–“ã€‚</p>
<h2><a class="header" href="#åƒè€ƒè³‡æ–™" id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</a></h2>
<ul>
<li><a href="https://doc.rust-lang.org/stable/std/collections/hash_map/index.html">Rust Documentation: HashMap</a></li>
<li><a href="https://en.wikipedia.org/wiki/Hash_table">Wiki: Hash table</a></li>
<li><a href="https://en.wikipedia.org/wiki/Open_addressing">Wiki: Open addressing</a></li>
<li><a href="https://algs4.cs.princeton.edu/34hash/">Algorithms, 4th Edition by R. Sedgewick and K. Wayne: 3.4 Hash Tables</a></li>
<li><a href="https://courses.csail.mit.edu/6.006/fall11/notes.shtml">MIT 6.006: Introduction to Algorithms, fall 2011: Unit 3 Hashing</a></li>
<li>Map graph by Jorge Stolfi <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA-3.0</a> via Wikimedia Commons.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../collections/associative-container/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../collections/set/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../collections/associative-container/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../collections/set/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../theme/custom.js"></script>
        

        

    </body>
</html>
