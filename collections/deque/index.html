<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>é›™ç«¯ä½‡åˆ— Deque - Rust Algorithm Club</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn algorithms and data structures with Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Rust Algorithm Club</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ’¡ åŸºç¤æ¦‚å¿µ</li><li class="chapter-item expanded "><a href="../../concepts/asymptotic-notation/index.html">æ¼¸é€²ç¬¦è™Ÿ Asymptotic Notation</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ” æœå°‹</li><li class="chapter-item expanded "><a href="../../searching/linear_search/index.html">ç·šæ€§æœå°‹ Linear search</a></li><li class="chapter-item expanded "><a href="../../searching/binary_search/index.html">äºŒå…ƒæœå°‹ Binary search</a></li><li class="chapter-item expanded "><a href="../../searching/interpolation_search/index.html">å…§æ’æœå°‹ Interpolation search</a></li><li class="chapter-item expanded "><a href="../../searching/exponential_search/index.html">æŒ‡æ•¸æœå°‹ Exponential search</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ“š æ’åº</li><li class="chapter-item expanded affix "><li class="part-title">ç°¡å–®æ’åº</li><li class="chapter-item expanded "><a href="../../sorting/insertion_sort/index.html">æ’å…¥æ’åº Insertion sort</a></li><li class="chapter-item expanded "><a href="../../sorting/selection_sort/index.html">é¸æ“‡æ’åº Selection sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bubble_sort/index.html">æ°£æ³¡æ’åº Bubble sort</a></li><li class="chapter-item expanded "><a href="../../sorting/shellsort/index.html">å¸Œçˆ¾æ’åº Shellsort</a></li><li class="chapter-item expanded affix "><li class="part-title">é«˜æ•ˆæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/heapsort/index.html">å †ç©æ’åº Heapsort</a></li><li class="chapter-item expanded "><a href="../../sorting/quicksort/index.html">å¿«é€Ÿæ’åº Quicksort</a></li><li class="chapter-item expanded "><a href="../../sorting/mergesort/index.html">åˆä½µæ’åº Mergesort</a></li><li class="chapter-item expanded affix "><li class="part-title">æ··åˆæ’åº</li><li class="chapter-item expanded "><div>ğŸš§ å…§çœæ’åº Introsort</div></li><li class="chapter-item expanded "><div>ğŸš§ è‡ªé©æ‡‰åˆä½µæ’åº Timsort</div></li><li class="chapter-item expanded "><div>ğŸš§ æ¨¡å¼æ¶ˆé™¤å¿«é€Ÿæ’åº Pdqsort</div></li><li class="chapter-item expanded affix "><li class="part-title">ç‰¹æ®Šæ’åº</li><li class="chapter-item expanded "><a href="../../sorting/counting_sort/index.html">è¨ˆæ•¸æ’åº Counting sort</a></li><li class="chapter-item expanded "><a href="../../sorting/bucket_sort/index.html">æ¡¶æ’åº Bucket sort</a></li><li class="chapter-item expanded "><a href="../../sorting/radix_sort/index.html">åŸºæ•¸æ’åº Radix sort</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ  è³‡æ–™çµæ§‹</li><li class="chapter-item expanded affix "><li class="part-title">å †ç–Šèˆ‡ä½‡åˆ—</li><li class="chapter-item expanded "><a href="../../collections/stack/index.html">å †ç–Š Stack</a></li><li class="chapter-item expanded "><a href="../../collections/queue/index.html">ä½‡åˆ— Queue</a></li><li class="chapter-item expanded "><a href="../../collections/deque/index.html" class="active">é›™ç«¯ä½‡åˆ— Deque</a></li><li class="chapter-item expanded affix "><li class="part-title">éˆçµä¸²åˆ—</li><li class="chapter-item expanded "><a href="../../collections/linked_list/index.html">éˆçµä¸²åˆ—æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/singly_linked_list/index.html">å–®å‘éˆçµä¸²åˆ— Singly linked list</a></li><li class="chapter-item expanded "><div>ğŸš§ é›™å‘éˆçµä¸²åˆ— Doubly linked list</div></li><li class="chapter-item expanded "><div>ğŸš§ å¾ªç’°éˆçµä¸²åˆ— Circular linked list</div></li><li class="chapter-item expanded affix "><li class="part-title">é—œè¯å®¹å™¨</li><li class="chapter-item expanded "><a href="../../collections/associative-container/index.html">é—œè¯å®¹å™¨æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="../../collections/hash_map/index.html">é›œæ¹Šè¡¨ Hash map</a></li><li class="chapter-item expanded "><div>ğŸš§ æœ‰åºæ˜ å°„è¡¨ Ordered map</div></li><li class="chapter-item expanded "><div>ğŸš§ å¤šé‡æ˜ å°„è¡¨ Multimap</div></li><li class="chapter-item expanded "><a href="../../collections/set/index.html">é›†åˆ Set</a></li><li class="chapter-item expanded "><a href="../../collections/bloom_filter/index.html">å¸ƒéš†éæ¿¾å™¨ Bloom filter</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ§µ å­—ä¸²è™•ç†</li><li class="chapter-item expanded "><a href="../../hamming_distance/index.html">æ¼¢æ˜è·é›¢ Hamming distance</a></li><li class="chapter-item expanded "><a href="../../levenshtein_distance/index.html">èŠæ–‡æ–¯å¦è·é›¢ Levenshtein distance</a></li><li class="chapter-item expanded "><div>ğŸš§ æœ€é•·å…±åŒå­å­—ä¸² Longest common substring</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../CONTRIBUTING.html">è²¢ç»æŒ‡å—</a></li><li class="chapter-item expanded affix "><a href="../../404.html">404</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust Algorithm Club</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/weihanglo/rust-algorithm-club" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#é›™ç«¯ä½‡åˆ—-deque" id="é›™ç«¯ä½‡åˆ—-deque">é›™ç«¯ä½‡åˆ— Deque</a></h1>
<p>é›™ç«¯ä½‡åˆ—ï¼ˆdouble-ended queueï¼Œé€šå¸¸ç¸®å¯«ç‚º dequeï¼‰æ˜¯ä¸€èˆ¬åŒ–ï¼ˆgeneralizeï¼‰çš„<a href="../queue">ä½‡åˆ—</a>æˆ–<a href="../stack">å †ç–Š</a>ã€‚æ¯”èµ·ä½‡åˆ—åªèƒ½ã€Œå…ˆé€²å…ˆå‡º FIFOã€ï¼Œä»¥åŠå †ç–Šåªæœ‰ã€Œå¾Œé€²å…ˆå‡º LIFOã€ï¼Œé›™ç«¯ä½‡åˆ—å¯ä»¥å¾æœ€å‰ç«¯æˆ–æœ€æœ«ç«¯ä»»æ„æ–¹å‘ï¼Œåœ¨å¸¸æ•¸æ™‚é–“è¤‡é›œåº¦å…§å¢åˆªå…ƒç´ ï¼Œæ›´ç‚ºæ–¹ä¾¿ã€‚</p>
<p>é›™ç«¯ä½‡åˆ—å¸¸è¦‹ç”¨å‹•æ…‹é™£åˆ—æˆ–æ˜¯éˆçµä¸²åˆ—å¯¦ä½œï¼Œå‹•æ…‹é™£åˆ—çš„å¯¦ä½œæœƒå› ç©ºé–“ä¸å¤ ï¼Œéœ€è¦é‡æ–°é…ç½®è¨˜æ†¶é«”ï¼Œä½†é€šå¸¸æœƒæ”¯æ´éš¨æ©Ÿå­˜å–ï¼ˆrandom accessï¼‰ï¼›éˆçµä¸²åˆ—çš„å¯¦ä½œç‰ˆæœ¬é›–ç„¡æ³•éš¨æ©Ÿå­˜å–ï¼Œç›¸å°åœ°å¢åˆªå…ƒç´ ä¸éœ€è¨˜æ†¶é«”é‡é…ç½®ã€‚</p>
<p>é›™ç«¯ä½‡åˆ—é¡¯è‘—çš„ç¼ºé»æ˜¯ï¼šç„¡è«–ä»¥å‹•æ…‹é™£åˆ—æˆ–é€£çµä¸²åˆ—å¯¦ä½œï¼ŒåŸºæœ¬æ¬¾å¯¦ä½œé€šå¸¸ç„¡æ³•åœ¨ $O(k)$ æ™‚é–“è¤‡é›œåº¦çš„æƒ…æ³ä¸‹ï¼Œé¸å®šç¯„åœå…§ k å€‹å…ƒç´ ä¸¦å–å¾—å–®ä¸€åˆ‡ç‰‡ï¼ˆsliceï¼‰ã€‚é€™è‚‡å› æ–¼å‹•æ…‹é™£åˆ—çš„å¯¦ä½œé€šå¸¸å…§éƒ¨å„²å­˜ç©ºé–“ç¶“éå¤šæ¬¡å¢åˆªï¼Œç©ºé–“åˆ©ç”¨æœƒä¸é€£çºŒï¼›è€Œç”¨éˆçµä¸²åˆ—å¯¦ä½œè€…ï¼Œå‰‡å› ä¸æ”¯æ´éš¨æ©Ÿå­˜å–è€Œç„¡æ³•é”åˆ°ç›¸æ‡‰çš„è¤‡é›œåº¦ã€‚</p>
<blockquote>
<p>æœ¬æ¬¡å¯¦ä½œçš„ç¨‹å¼ç¢¼ç½®æ–¼åœ¨ <a href="/doc/rust_algorithm_club/collections/struct.Deque.html"><code>rust_algorithm_club::collections::Deque</code></a> API æ–‡ä»¶ä¸­ã€‚</p>
</blockquote>
<h2><a class="header" href="#æ¶æ§‹è¨­è¨ˆ" id="æ¶æ§‹è¨­è¨ˆ">æ¶æ§‹è¨­è¨ˆ</a></h2>
<p>é›™ç«¯ä½‡åˆ—æœ‰å€‹å¯¦ä½œé‡é»ï¼šå¯åœ¨<strong>å¸¸æ•¸æ™‚é–“</strong>å¾é ­å°¾å…©ç«¯å¢åˆªå…ƒç´ ã€‚åœ¨è³‡æ–™çµæ§‹è¨­è¨ˆä¸Šï¼Œæœƒå„²å­˜åˆ†åˆ¥æŒ‡å‘é ­å°¾çš„å…©å€‹æŒ‡æ¨™ï¼Œé•·ç›¸å¯èƒ½å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Deque {
    head: usize,
    tail: usize,
    storage: SomeStorageType,
}
<span class="boring">}
</span></code></pre></pre>
<p>ç¬¬ä¸€ç›´è¦ºè‚¯å®šæ˜¯é¸ç”¨<a href="../doubly_linked_list">é›™å‘éˆçµä¸²åˆ—</a>å¯ä»¥é›™å‘å¢åˆªç¯€é»çš„ç‰¹æ€§ï¼Œä½œç‚ºè§£æ±ºæ–¹æ¡ˆã€‚ä¸éé€™è£¡æˆ‘å€‘æ¡ç”¨å‹•æ…‹é™£åˆ—å¯¦ä½œï¼Œæ›´ç²¾ç¢ºä¾†èªªï¼Œåº•å±¤å„²å­˜å®¹å™¨åŒæ¨£æ˜¯æœ‰å…©å€‹åˆ†åˆ¥æŒ‡å‘é ­å°¾çš„æŒ‡æ¨™çš„ã€Œç’°å½¢ç·©è¡å€ï¼ˆRing bufferï¼‰ã€ã€‚</p>
<h3><a class="header" href="#ç’°å½¢ç·©è¡å€" id="ç’°å½¢ç·©è¡å€">ç’°å½¢ç·©è¡å€</a></h3>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Circular_buffer.svg/240px-Circular_buffer.svg.png" alt="" /></p>
<p><a href="https://en.wikipedia.org/wiki/Circular_buffer">ç’°å½¢ç·©è¡å€ï¼ˆRing bufferï¼‰</a> æ˜¯ä¸€å€‹é•·åº¦å¤§å°å›ºå®šçš„ç·©è¡å€ï¼Œå¯ä»¥è¦–ç‚ºé ­å°¾ç›¸é€£çš„è¨˜æ†¶é«”å€å¡Šï¼Œä¸Šåœ–é›–ä»¥ç’°ç‹€å‘ˆç¾ï¼Œä½†åœ¨è¨ˆç®—æ©Ÿæ¶æ§‹ä¸­å„²å­˜æ–¹å¼é€šå¸¸æ˜¯ç·šæ€§é™£åˆ—ï¼Œå†æ­é…æŒ‡å‘é ­ç«¯çš„ <code>head</code> èˆ‡æŒ‡å‘å°¾ç«¯çš„ <code>tail</code> å…©å€‹æŒ‡æ¨™æ§‹æˆã€‚</p>
<p>ç’°å½¢ç·©è¡å€æœ‰åˆ†å…©ç¨®ï¼Œä¸€ç¨®æ˜¯æœ‰å¾ªç’°çš„ï¼Œç·©è¡å€å¯«æ»¿äº†å°±è¦†è“‹å°¾ç«¯èˆŠçš„è³‡æ–™ï¼Œå¦ä¸€ç¨®æ˜¯ä¸æœƒå¾ªç’°ï¼Œç·©è¡å€æœƒæ”¾æ»¿çš„ï¼Œå¾Œè€…å°±æ˜¯æœ¬æ¬¡å¯¦ä½œæœƒç”¨åˆ°çš„ï¼Œä»¥ä¸‹å°‡ä¾†æ¢è¨ï¼š</p>
<ul>
<li>å¦‚ä½•è¡¨ç¤ºç’°å½¢ç·©è¡å€ç‚ºç©º</li>
<li>å¦‚ä½•è¡¨ç¤ºç’°å½¢ç·©è¡å€å·²æ»¿</li>
<li>ç’°å½¢ç·©è¡å€å¦‚ä½•å¢åŠ å…ƒç´ </li>
</ul>
<p>é€™ç¯€ä»¥ ASCII chart è¡¨ç¤ºä¹‹ã€‚</p>
<ul>
<li><code>h</code>: head</li>
<li><code>t</code>: tail</li>
<li><code>x</code>: no data </li>
<li><code>[number]</code>: has data</li>
</ul>
<p>ä¸‹é¢ä¸€å€‹å®¹é‡ç‚º 8ï¼Œå°šæœªæœ‰ä»»ä½•å…ƒç´ å­˜å…¥çš„ç’°å½¢ç·©è¡å€ï¼Œé€™è£¡è§€å¯Ÿåˆ°ï¼Œè‹¥ head èˆ‡ tail æŒ‡å‘çš„å„²å­˜å–®å…ƒç›¸åŒï¼Œæ›å¥è©±èªª<strong>å…©è€…ç´¢å¼•å€¼ç›¸åŒï¼Œå‰‡ç·©è¡å€ç‚ºç©º</strong>ã€‚</p>
<pre><code>scenario: empty buffer

h
t
---------------
x x x x x x x x
---------------
</code></pre>
<p>å†ä¾†ï¼Œå¾é ­ç«¯å¢åŠ ä¸€å€‹å…ƒç´ ï¼Œæ­¤æ™‚ head æŒ‡å‘çš„å„²å­˜å–®å…ƒæœƒå­˜å…¥å…ƒç´ ï¼Œä¸¦ä¸” head ç´¢å¼•åŠ ä¸€ã€‚</p>
<pre><code>scenario: add one data onto head

t h
---------------
1 x x x x x x x
---------------
</code></pre>
<p>æˆ‘å€‘å†é€£çºŒåŠ å¹¾å€‹å…ƒç´ ï¼Œå¯ä»¥è§€å¯Ÿåˆ°ï¼Œhead æœ€çµ‚æŒ‡å‘çš„å„²å­˜å–®å…ƒæ°¸é ç‚ºç©ºï¼š</p>
<pre><code>scenario: add more data onto head

t   h
---------------
1 2 x x x x x x
---------------

t     h
---------------
1 2 3 x x x x x
---------------

t       h
---------------
1 2 3 4 x x x x
---------------
</code></pre>
<p>å†ä¾†ï¼Œæˆ‘å€‘å¾å°¾ç«¯å¢åŠ å…ƒç´ ï¼Œé¦–å…ˆ tail æ¸›ä¸€ï¼Œä¸¦åœ¨ç§»å‹•éå¾Œçš„ tail æŒ‡å‘çš„å„²å­˜å–®å…ƒæ”¾å…¥å…ƒç´ ã€‚å› ç‚º tail åŸæœ¬ç‚º 0ï¼Œæ¸›ä¸€ä¹‹å¾Œç‚º -1ï¼Œä½†ç´¢å¼•ä¸è©²æœ‰ -1ï¼Œæ‰€ä»¥æˆ‘å€‘æ¡å–é¡ä¼¼ç’°ç¹ç®—è¡“é‹ç®—ï¼ˆwrapping arithmetic operationï¼‰è™•ç†<a href="https://en.wikipedia.org/wiki/Integer_overflow">æ•´æ•¸æº¢ä½</a>ï¼Œå› æ­¤ tail ç´¢å¼•å¾ 0 è®Šæˆ 7ï¼ˆç¸½å…± 8 å€‹å„²å­˜å–®å…ƒï¼‰ã€‚</p>
<pre><code>scenario: add data onto tail

        h     t
---------------
1 2 3 4 x x x 5
---------------

</code></pre>
<blockquote>
<p>æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œç’°ç¹ç®—è¡“é‹ç®—å¯è¦‹æ–¼æ±½è»Šå„€éŒ¶æ¿æˆ–æ˜¯é›»éŒ¶ï¼Œ9999 è½‰éé ­å¾Œæœƒè‡ªå‹•è®Šæˆ 0000ï¼Œå¯ä»¥æƒ³åƒæˆåœ¨è¬åˆ†ä½é€²ä½äº†ï¼Œä½†æˆ‘å€‘çœ‹ä¸åˆ°ã€‚ä¸Šè¿°æ¸›ä¸€ä¹Ÿå¯ä»¥æƒ³åƒäºŒé€²ä½é€€ä¸€ä½ï¼Œä½†æˆ‘å€‘çœ‹ä¸åˆ°ï¼Œæ‰€ä»¥å¾ <code>0b000</code>ï¼ˆ0ï¼‰è®Šæˆäº† <code>0b111</code>ï¼ˆ7ï¼‰ã€‚</p>
<img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Odometer_rollover.jpg" width="300px">
</blockquote>
<p>æˆ‘å€‘å¾å°¾ç«¯åŠ æ›´å¤šè³‡æ–™åˆ°ç·©è¡å€ï¼š</p>
<pre><code>scenario: add more data onto tail

        h   t
---------------
1 2 3 4 x x 6 5
---------------

        h t
---------------
1 2 3 4 x 7 6 5 --&gt; full
---------------
</code></pre>
<p>æ¬¸ï¼Œæ€éº¼åŠ åˆ°ç¬¬ä¸ƒå€‹å°±åœäº†ï¼Ÿ</p>
<p>ç”±æ–¼ç›®å‰åƒ…æ¢è¨<strong>ä¸å¾ªç’°</strong>çš„ç’°å½¢ç·©è¡å€ï¼Œå·²ç¶“è¦ç¯„ <code>head = tail</code> ä»£è¡¨ç·©è¡å€ç‚ºç©ºï¼Œå¦‚æœè²¿ç„¶åŠ ä¸Šç¬¬å…«å€‹å…ƒç´ ï¼Œå°±ç„¡æ³•åˆ†è¾¨ç·©è¡å€æ˜¯ç©ºæ˜¯æ»¿ï¼Œæå°è‡´è½‰ç›ˆç‚ºç©ºã€‚æ‰€ä»¥ç•¶ç·©è¡å€å®¹é‡æ¸›å»å…ƒç´ å€‹æ•¸ç‚º 1 æ™‚ï¼Œæ›å¥è©±èªªå°±æ˜¯ç•¶å‰©é¤˜æœ€å¾Œä¸€å€‹ç©ºå„²å­˜å–®å…ƒæ™‚ï¼Œè¡¨ç¤ºè©²ç·©è¡å€å·²æ»¿ï¼Œä¸èƒ½å†å¢åŠ å…ƒç´ ã€‚ç”±æ­¤æ¨è«–ç’°å½¢ç·©è¡å€æ°¸é æœƒå‰©ä¸‹ä¸€å€‹æ²’ä½¿ç”¨çš„å„²å­˜å–®å…ƒã€‚</p>
<p>è‡³æ­¤ï¼Œç’°å½¢ç·©è¡å€çš„ç‰¹æ€§å¾ˆç¬¦åˆé›™ç«¯ä½‡åˆ—çš„éœ€æ±‚ï¼Œç¸½çµä¸€ä¸‹ï¼š</p>
<ol>
<li><code>head = tail</code> æ™‚ï¼Œè¡¨ç¤ºç·©è¡å€ç‚ºç©ºã€‚</li>
<li>å®¹é‡åƒ…å‰©ä¸€å€‹å„²å­˜å–®å…ƒæ™‚ï¼Œè¡¨ç¤ºç·©è¡å€å·²æ»¿ã€‚</li>
<li>head æ°¸é æŒ‡å‘ä¸€å€‹ç©ºçš„å„²å­˜å–®å…ƒã€‚</li>
<li>é‚è¼¯ç´¢å¼•çš„æ˜ å°„æœƒåˆ©ç”¨ç’°ç¹ç®—è¡“é‹ç®—é…åˆ<a href="https://en.wikipedia.org/wiki/Modulo_operation">æ¨¡é™¤é‹ç®—</a>ï¼Œå°‡ç´¢å¼•å€¼é™åˆ¶åœ¨ç·©è¡å€ç¯„åœå…§ã€‚</li>
</ol>
<p>ç¬¬å››é»å¾ˆé›£æ‡‚é½ï¼Ÿå…é©šï¼Œä¸‹é¢å¯¦ä½œç¯„ä¾‹ã€Œ<a href="#%E9%82%8F%E8%BC%AF%E7%B4%A2%E5%BC%95%E6%98%A0%E5%B0%84">é‚è¼¯ç´¢å¼•æ˜ å°„</a>ã€æ®µè½å°±æœƒè§£é‡‹çµ¦ä½ è½ï¼</p>
<h3><a class="header" href="#æ‰‹å‹•é…ç½®è¨˜æ†¶é«”" id="æ‰‹å‹•é…ç½®è¨˜æ†¶é«”">æ‰‹å‹•é…ç½®è¨˜æ†¶é«”</a></h3>
<p>é€™ä¸€æ®µï¼Œæˆ‘å€‘å°‡ç‚ºç’°å½¢ç·©è¡å€æ‰“é€ å±¬æ–¼å®ƒè‡ªå·±çš„åº•å±¤å„²å­˜ç©ºé–“ã€‚ä½ å¯èƒ½æƒ³å•ï¼Œæ—¢ç„¶ç’°å½¢ç·©è¡å€æ˜¯ä¸€å€‹å›ºå®šé•·åº¦çš„é™£åˆ—ï¼Œç‚ºä»€éº¼ä¸ç›´æ¥åˆ©ç”¨ Rust æ¨™æº–å‡½å¼åº«çš„ <code>Vec</code> å‘¢ï¼Ÿå› ç‚º <a href="https://doc.rust-lang.org/1.49.0/alloc/vec/struct.Vec.html#capacity-and-reallocation"><code>Vec</code> çš„å®¹é‡å’Œè¨˜æ†¶é«”é…ç½®</a>å±¬æ–¼å¯¦ä½œç´°ç¯€ï¼Œé›–ç„¶ç›®å‰æ˜¯æ»¿äº†æ‰æ“´å……å®¹é‡é‡æ–°é…ç½®ç©ºé–“ï¼Œä½†é›£ä¿æœªä¾†æ”¹è®Šï¼Œç‚ºäº†æ›´ç´°ç·»æ§åˆ¶è¨˜æ†¶é«”ï¼Œæ±ºå®šå¼„é«’æ‰‹ï¼Œè‡ªè¡Œé…ç½®è¨˜æ†¶é«”ã€‚</p>
<blockquote>
<p>âš ï¸ ä»¥ä¸‹ç¯„ä¾‹æœ‰ <code>unsafe</code> ç¨‹å¼ç¢¼ï¼Œæœªç¶“å¯©è¨ˆï¼Œè«‹è¬¹æ…ä½¿ç”¨ã€‚</p>
</blockquote>
<p>é¦–å…ˆï¼Œå®£å‘Šä¸€å€‹ <code>RawVec</code> çµæ§‹é«”ï¼Œå„²å­˜äº†å…©å€‹æ¬„ä½ï¼š</p>
<ul>
<li><code>ptr</code>ï¼šæŒ‡å‘é™£åˆ—æœ€å‰ç«¯çš„æŒ‡æ¨™ï¼Œå› ç‚ºåº•å±¤é™£åˆ—æœƒè®ŠåŒ–ï¼Œæ‰€ä»¥æ˜¯å¯è®Šè£¸æŒ‡æ¨™ <a href="https://doc.rust-lang.org/1.49.0/std/primitive.pointer.html"><code>*mut T</code></a>ã€‚</li>
<li><code>cap</code>ï¼šç•¶å‰ <code>RawVec</code> çš„å®¹é‡ã€‚æ³¨æ„ï¼Œå®¹é‡éœ€æ°¸é å¤§æ–¼ç­‰æ–¼å…ƒæ•¸å€‹æ•¸ï¼Œå¦å‰‡æœƒç™¼ç”Ÿ<a href="https://en.wikipedia.org/wiki/Buffer_overflow">ç·©è¡å€æº¢ä½</a>ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct RawVec&lt;T&gt; {
    ptr: *mut T,
    cap: usize,
}
<span class="boring">}
</span></code></pre></pre>
<p>æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘è¦ç‚º <code>RawVec</code> å¯¦ä½œä¸‰å€‹æ–¹æ³•ï¼Œå®Œæˆè‡ªæˆ‘ç®¡ç†è¨˜æ†¶é«”çš„å‰å¤§å¿—å‘ï¼š</p>
<ul>
<li><code>with_capacity</code>ï¼šå»ºç«‹æŒ‡å®šå®¹é‡çš„ <code>RawVec</code>ï¼Œæœƒåœ¨å †ç–Šä¸Šé…ç½®ä¸€å¡Šè¨˜æ†¶é«”ã€‚</li>
<li><code>try_grow</code>ï¼šå˜—è©¦å°‡ <code>RawVec</code> çš„å®¹é‡åŠ å€ï¼Œæœƒè§¸ç™¼è¨˜æ†¶é«”çš„é‡æ–°é…ç½®ã€‚</li>
<li><code>drop</code>ï¼šå¯¦ä½œ <a href="https://doc.rust-lang.org/1.49.0/core/ops/trait.Drop.html"><code>Drop</code></a> ç‰¹å¾µï¼Œæœƒé‡‹æ”¾åœ¨å †ç–Šä¸Šæ‰‹å‹•é…ç½®çš„è¨˜æ†¶é«”ã€‚</li>
</ul>
<p>å…ˆä¾†çœ‹ <code>with_capacity</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; RawVec&lt;T&gt; {
    // ...
    pub fn with_capacity(cap: usize) -&gt; Self {
        let layout = Layout::array::&lt;T&gt;(cap).unwrap(); // 1

        // 2
        if layout.size() == 0 {
            // This is safe for zero sized types. However, be careful when facing
            // zero capacity layouts. It must be replaced with an actual pointer
            // before operations such as dereference or read/write.
            let ptr = ptr::NonNull::dangling().as_ptr(); // 3
            Self { ptr, cap: 0 }
        } else {
            // This is safe because it conforms to the [safety contracts][1].
            //
            // [1]: https://doc.rust-lang.org/1.49.0/alloc/alloc/trait.GlobalAlloc.html#safety-1
            let ptr = unsafe { alloc(layout) }; // 4
            if ptr.is_null() {
                handle_alloc_error(layout);
            }
            Self {
                ptr: ptr.cast(),
                cap,
            }
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>é¦–å…ˆï¼Œæˆ‘å€‘å…ˆé€é <a href="https://doc.rust-lang.org/1.49.0/alloc/alloc/struct.Layout.html#method.array"><code>Layout::array</code></a> å–å¾—çµ¦å®šé•·åº¦çµ¦å®šå‹åˆ¥çš„é™£åˆ—çš„è¨˜æ†¶é«”ä½ˆå±€ï¼Œé€™å€‹ä½ˆå±€åŒ…å«<a href="https://en.wikipedia.org/wiki/Data_structure_alignment">è¨˜æ†¶é«”å°é½Š</a>ï¼ˆäºŒçš„å€æ•¸çš„ä½å…ƒçµ„ï¼‰èˆ‡ä½”ç”¨è¨˜æ†¶é«”å¤§å°ç­‰è³‡è¨Šã€‚</li>
<li>å†ä¾†é€™å€‹ <code>layout.size()</code> æ¢ä»¶å¼æ˜¯å› ç‚º <a href="https://doc.rust-lang.org/1.49.0/alloc/alloc/fn.alloc.html"><code>alloc</code></a> ç‚º <code>unsafe</code> å‡½å¼ï¼Œéœ€éµå®ˆå…¶å®‰å…¨æ¢æ¬¾ï¼š<a href="https://doc.rust-lang.org/1.49.0/alloc/alloc/trait.GlobalAlloc.html#safety-1">ä¸å…è¨±é…ç½®å¤§å°ç‚ºé›¶çš„ç©ºé–“</a>ã€‚å› æ­¤ï¼Œå¿…é ˆåˆ¤æ–·å¯¦éš›ä¸Šéœ€è¦é…ç½®è¨˜æ†¶é«”èˆ‡å¦ï¼Œæœ‰å…©ç¨®æƒ…æ³ä¸éœ€é…ç½®ï¼š
<ul>
<li><code>T</code> æ˜¯ <a href="https://doc.rust-lang.org/nomicon/exotic-sizes.html#zero-sized-types-zsts">Zero Sized Typesï¼ˆZSTsï¼‰</a>ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦ç©ºé–“çš„å‹åˆ¥ã€‚</li>
<li><code>cap</code> ç‚ºé›¶ï¼Œæ‰€ä»¥ä¸éœ€è¦å®¹é‡ã€‚</li>
</ul>
</li>
<li>è‹¥è¨˜æ†¶é«”ä½ˆå±€æ‰€ä½”ç©ºé–“å¤§å°ç‚ºé›¶ï¼Œå‰‡é…ç½®ä¸€å€‹ <a href="https://doc.rust-lang.org/1.49.0/core/ptr/struct.NonNull.html"><code>NonNull</code></a> çš„è¿·é€”æŒ‡æ¨™ã€‚
<ul>
<li>å° ZST ä¾†èªªï¼Œ<code>NonNull</code> æ˜¯å®‰å…¨çš„ï¼ŒZST çš„æŒ‡æ¨™ç®—è¡“æ“ä½œç„¡è«–å¦‚ä½•åŠ æ¸›ï¼Œéƒ½æœƒæŒ‡å‘åŸå§‹çš„æŒ‡æ¨™ä½å€ï¼Œæ‰€ä»¥ä¸Šå±¤å¯ä»¥é›¶æˆæœ¬çš„æŠ½è±¡æ“ä½œå®¹å™¨çš„å„ç¨®æ–¹æ³•ï¼Œå®Œå…¨ä¸éœ€è¦é…ç½®é¡å¤–è¨˜æ†¶é«”å€å¡Šã€‚</li>
<li>å°é ZST ä½†å®¹é‡ç‚ºé›¶çš„è¨˜æ†¶é«”ä½ˆå±€ä¾†èªªï¼Œ<code>NonNull</code> ä¸æœƒæœ‰å±å®³ä½†è¦éå¸¸å°å¿ƒï¼Œåªæœ‰åœ¨å®¹é‡å¤§æ–¼ 0 ä¸”å…§å®¹æœ‰åˆå§‹åŒ–æ™‚ï¼Œæ‰è©²å…è¨±æŒ‡æ¨™ç®—è¡“ï¼Œå¦å‰‡å¯èƒ½å­˜å–åˆ°æœªåˆå§‹åŒ–çš„è¨˜æ†¶é«”ä½å€ï¼Œé€²è€Œå¼•ç™¼æœªå®šç¾©è¡Œç‚ºã€‚</li>
</ul>
</li>
<li>å¾ˆç°¡å–®åœ°å‘¼å« <a href="https://doc.rust-lang.org/1.49.0/alloc/alloc/fn.alloc.html"><code>alloc</code></a> è®“ Rust å…¨åŸŸé è¨­çš„é…ç½®å™¨å¹¹ä¸€å¡Šç©ºé–“è³‡æºä¾†ã€‚å› ç‚º <code>alloc</code> ç™¼ç”Ÿè¨˜æ†¶é«”é…ç½®éŒ¯èª¤æ™‚æœƒå›å‚³ç©ºæŒ‡æ¨™ï¼Œæ‰€ä»¥é€™è£¡æŒ‰ç…§å®˜æ–¹å»ºè­°ç”¨ <code>handle_alloc_error</code> æ•æ‰é€™å€‹è¡Œç‚ºï¼Œé˜²æ­¢ç©ºæŒ‡æ¨™è¢«ç•¶ä½œåˆæ³•æŒ‡æ¨™ä½¿ç”¨ã€‚</li>
</ol>
<blockquote>
<p>Rust 1.28 å°å…¥ <a href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/global-allocators.html">Global allocators</a> çš„åŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…ä½¿ç”¨ <a href="https://doc.rust-lang.org/1.49.0/std/alloc/trait.GlobalAlloc.html"><code>#[global_allocator]</code></a> å±¬æ€§ï¼Œæ›¿æ¨™æº–å‡½å¼åº«è¨»å†Šå…¨åŸŸçš„è¨˜æ†¶é«”é…ç½®å™¨ï¼Œä¹Ÿå› æ­¤ï¼Œä¸Šè¿°çš„ <code>alloc</code>ã€<code>realloc</code>ã€<code>dealloc</code> å³å°‡åœ¨ <a href="https://github.com/rust-lang/rust/issues/32838">allocator_api</a> ç©©å®šå¾Œè¢«å–ä»£ã€‚</p>
</blockquote>
<p>çœ‹å®Œé…ç½®è¨˜æ†¶é«”ï¼Œä¾†çœ‹å¦‚ä½•æ‰‹å‹•é‡‹æ”¾è¨˜æ†¶é«”ã€‚Rust çš„ <a href="https://doc.rust-lang.org/1.49.0/core/ops/trait.Drop.html"><code>Drop</code></a> ç‰¹å¾µæœ‰ <code>drop()</code> æ–¹æ³•ï¼Œæœƒåœ¨æ•¸å€¼ä¸éœ€è¦æ™‚å‘¼å«ï¼Œé¡ä¼¼å…¶ä»–èªè¨€çš„è§£æ§‹å‡½å¼ï¼ˆdestructorï¼‰ã€‚æˆ‘å€‘å°‡é‡‹æ”¾è¨˜æ†¶é«”çš„é‚è¼¯æ”¾åœ¨ <code>RawVec::drop</code> è£¡é¢ï¼Œç•¶ <code>RawVec</code> ä¸è¢«éœ€è¦æ™‚ï¼Œå°±æœƒå”åŠ©æˆ‘å€‘é‡‹æ”¾æ‰‹å‹•é…ç½®çš„è¨˜æ†¶é«”ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Drop for RawVec&lt;T&gt; {
    /// Deallocates the underlying memory region by calculating the type layout
    /// and number of elements.
    ///
    /// This only drop the memory block allocated by `RawVec` itself but not
    /// dropping the contents. Callers need to drop the contents by themselves.
    fn drop(&amp;mut self) {
        let layout = Layout::array::&lt;T&gt;(self.cap).unwrap(); // 1
        if layout.size() &gt; 0 {
            // This is safe because it conforms to the [safety contracts][1].
            //
            // [1]: https://doc.rust-lang.org/1.49.0/alloc/alloc/trait.GlobalAlloc.html#safety-2
            unsafe { dealloc(self.ptr.cast(), layout) }
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>å¯¦ä½œä¸Šï¼Œç¬¬ä¸€æ­¥å–å¾—ç•¶å‰è¨˜æ†¶é«”ä½ˆå±€ï¼Œä¸¦é€é <a href="https://doc.rust-lang.org/1.49.0/alloc/alloc/fn.dealloc.html"><code>dealloc</code></a> é…åˆæŒ‡æ¨™ä¾†é‡‹æ”¾è¨˜æ†¶é«”ã€‚ç•¶ç„¶ï¼ŒZST æˆ–æ˜¯å®¹é‡ç‚ºé›¶çš„ç‹€æ³ä¸¦æ²’æœ‰é…ç½®è¨˜æ†¶é«”ï¼Œé¡å¤–åˆ¤æ–·ç„¡éœ€é‡‹æ”¾ã€‚</p>
<p>æœ€å¾Œï¼Œä¾†ç§ç§ <code>try_grow</code>ï¼Œç‚ºäº†ç°¡åŒ–å¯¦ä½œï¼Œæ¯æ¬¡å‘¼å«æ™‚ï¼Œè¨˜æ†¶é«”å€å¡Šå°±å–®ç´”åŠ å€ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; RawVec&lt;T&gt; {
    // ...
    pub fn try_grow(&amp;mut self) {
        if mem::size_of::&lt;T&gt;() == 0 {
            return; // 1
        }

        if self.cap == 0 {
            *self = Self::with_capacity(1); // 2
            return;
        }

        let old_layout = Layout::array::&lt;T&gt;(self.cap).unwrap(); // 3
        let new_cap = self.cap &lt;&lt; 1;
        let new_size = old_layout.size() * new_cap;
        // This is safe because it conforms to the [safety contracts][1].
        //
        // [1]: https://doc.rust-lang.org/1.49.0/alloc/alloc/trait.GlobalAlloc.html#safety-4
        let ptr = unsafe { realloc(self.ptr.cast(), old_layout, new_size) };
        if ptr.is_null() {
            handle_alloc_error(old_layout);
        }
        // ...Old allocation is unusable and may be released from here at anytime.

        self.ptr = ptr.cast(); // 4
        self.cap = new_cap;
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>ZST çš„ç©ºé–“ä¸éœ€åŠ å€ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>åŸæœ¬ç©ºé–“å®¹é‡ç‚ºé›¶çš„ç‹€æ³ï¼Œç›´æ¥é…ç½®å®¹é‡ç‚ºä¸€çš„ç©ºé–“ã€‚</li>
<li>æº–å‚™ <code>realloc</code> éœ€è¦çš„åƒæ•¸ï¼šå®¹é‡è¶…éé›¶çš„ï¼Œå–å¾—èˆŠçš„è¨˜æ†¶é«”ä½ˆå±€ï¼Œä¸¦ä¹˜ä¸Šç¿»å€å¾Œçš„å®¹é‡ï¼Œç®—å‡ºæ–°çš„ç©ºé–“å¤§å°ã€‚é€™è®“ä¹‹å¾Œå‘¼å« <code>realloc</code> æ™‚ç¬¦åˆå…¶å®‰å…¨æ¢æ¬¾ï¼šåˆæ³•æŒ‡æ¨™ã€ç©ºé–“å¤§æ–¼é›¶ã€è¨˜æ†¶é«”ä½ˆå±€ç‚ºè©²å€å¡Šçš„èˆŠä½ˆå±€ã€‚</li>
<li>å‘¼å« <code>realloc</code> ä¹‹å¾Œï¼ŒåŸå…ˆè¨˜æ†¶é«”å€å¡Šå¯èƒ½è¢«é‡‹æ”¾ï¼Œå› æ­¤ä¸è©²ç¹¼çºŒç”¨èˆŠæŒ‡æ¨™ï¼Œæ­¤ä»¥æ–°æŒ‡æ¨™å–ä»£ä¹‹ã€‚</li>
</ol>
<p>çµ‚æ–¼å°‡æ‰‹å‹•é…ç½®è¨˜æ†¶é«”çš„é‚è¼¯å°è£åœ¨ <code>RawVec</code> è£¡é¢ï¼Œå¤–éƒ¨ä¸éœ€è¦å¼„é«’æ‰‹æè¨˜æ†¶é«”äº†ï¼</p>
<h3><a class="header" href="#deque" id="deque"><code>Deque</code></a></h3>
<p>æœ‰äº† <code>RawVec</code>ï¼Œç¾åœ¨å¯ä»¥å°‡å…ˆå‰ç¼ºå¤±çš„ <code>SomeStorageType</code> è£œä¸Šï¼Œåˆå§‹åŒ–çš„æ–¹æ³•ä¹Ÿç•°å¸¸å–®ç´”ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Deque&lt;T&gt; {
    tail: usize,
    head: usize,
    ring_buf: RawVec&lt;T&gt;,
}

impl&lt;T&gt; Deque&lt;T&gt; {
    pub fn new() -&gt; Self {
        Self {
            tail: 0,
            head: 0,
            ring_buf: RawVec::with_capacity(DEFAULT_CAPACITY),
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>è‡³æ­¤ï¼Œ<code>Deque</code> çµæ§‹é«”çš„ä½ˆå±€è¨­è¨ˆå‘Šä¸€æ®µè½ï¼Œæ¥ä¸‹ä¾†å°±æ˜¯å„ç¨®æ–¹æ³•å¯¦ä½œã€‚</p>
<h2><a class="header" href="#åŸºæœ¬æ“ä½œ" id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</a></h2>
<p>èº«ç‚ºä¸€å€‹é›™ç«¯ä½‡åˆ—ï¼Œæœƒæœ‰ä»¥ä¸‹ç¬¦åˆå®šç¾©çš„åŸºæœ¬æ“ä½œï¼š</p>
<ul>
<li><code>new</code>ï¼šåˆå§‹åŒ–ä¸€å€‹å®¹å™¨ã€‚</li>
<li><code>push_front</code>ï¼šåœ¨å®¹å™¨æœ€å‰ç«¯æ–°å¢ä¸€å€‹å…ƒç´ ã€‚</li>
<li><code>push_back</code>ï¼šåœ¨å®¹å™¨æœ€æœ«ç«¯æ–°å¢ä¸€å€‹å…ƒç´ ã€‚</li>
<li><code>pop_front</code>ï¼šç§»é™¤åœ¨å®¹å™¨æœ€å‰ç«¯çš„å…ƒç´ ã€‚</li>
<li><code>pop_back</code>ï¼šç§»é™¤åœ¨å®¹å™¨æœ€æœ«ç«¯çš„å…ƒç´ ã€‚</li>
</ul>
<p>å¦å¤–ç‚ºäº†æå‡æ–¹ä¾¿æ€§ï¼Œä¹Ÿæä¾›äº†ä¸€äº›æ–¹æ³•ï¼š</p>
<ul>
<li><code>front</code>ï¼šæŸ¥çœ‹å®¹å™¨æœ€å‰ç«¯çš„å…ƒç´ ã€‚</li>
<li><code>back</code>ï¼šæŸ¥çœ‹å®¹å™¨æœ€æœ«ç«¯çš„å…ƒç´ ã€‚</li>
<li><code>len</code>ï¼šæª¢æŸ¥å®¹å™¨å…§çš„å…ƒç´ æ•¸ç›®ã€‚</li>
<li><code>is_empty</code>ï¼šæª¢æŸ¥å®¹å™¨å…§æ˜¯å¦æ²’æœ‰ä»»ä½•å…ƒç´ ã€‚</li>
<li><code>iter</code>ã€<code>iter_mut</code>ã€<code>into_iter</code>ï¼šç”¢ç”Ÿä¸€å€‹ç–Šä»£å®¹å™¨å…§æ‰€æœ‰å…ƒç´ çš„ç–Šä»£å™¨ã€‚</li>
</ul>
<p>å› ç‚ºéœ€è¦æ¯”è¼ƒå‹•æ…‹ç²¾ç´°åœ°æ§åˆ¶è¨˜æ†¶é«”ï¼Œå°‘ä¸äº†ä¸€äº›å…§éƒ¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>is_full</code>ï¼šæª¢æŸ¥åº•å±¤ç’°å½¢ç·©è¡å€æ˜¯å¦æ»¿è¼‰ã€‚</li>
<li><code>try_grow</code>ï¼šå˜—è©¦å‹•æ…‹å¢åŠ åº•å±¤å„²å­˜ç©ºé–“ã€‚</li>
<li><code>wrapping_add</code>ã€<code>wrapping_sub</code>ï¼šç¢ºä¿é‚è¼¯ç´¢å¼•çš„å¢æ¸›æ­£ç¢ºæ˜ å°„åˆ°åº•å±¤å¯¦éš›ç´¢å¼•ä½å€ã€‚</li>
</ul>
<h3><a class="header" href="#é‚è¼¯ç´¢å¼•æ˜ å°„" id="é‚è¼¯ç´¢å¼•æ˜ å°„">é‚è¼¯ç´¢å¼•æ˜ å°„</a></h3>
<p><a href="#%E7%92%B0%E5%BD%A2%E7%B7%A9%E8%A1%9D%E5%8D%80">å‰ä¸€æ®µ</a>æåŠç’°å½¢ç·©è¡å€å¯ä»¥å¾é ­å°¾å¢åŠ å…ƒç´ ï¼Œé€™ä¸€æ®µä¾†èªªæ˜ã€Œå¦‚ä½•å°è£ç’°å½¢ç·©è¡å€å…§éƒ¨çš„ç‰©ç†ç´¢å¼•ã€ï¼Œè®“å¤–éƒ¨çš„é‚è¼¯ç´¢å¼•å¯æ˜ å°„åˆ°å…§éƒ¨å·²å„²å­˜åˆæ³•æ•¸å€¼çš„ç·©è¡å€ä½å€ã€‚</p>
<p>å†å›ä¾†çœ‹å®¹é‡ç‚º 8 çš„é›™ç«¯ä½‡åˆ—çš„ä¾‹å­ï¼Œå·²é€²è¡Œä¸€ç³»åˆ—æ“ä½œï¼š</p>
<ol>
<li>push_back 1</li>
<li>push_back 2</li>
<li>push_back 3</li>
<li>push_back 4</li>
<li>push_front 5</li>
<li>push_front 6</li>
</ol>
<pre><code>        h   t
---------------
1 2 3 4 x x 6 5
---------------
</code></pre>
<p>å¦‚æœæˆ‘å€‘è¦æŒ‰ç…§é †åºï¼Œå¾ä½‡åˆ—çš„ tail åˆ° head å°å‡ºæ‰€æœ‰å…ƒç´ ï¼Œæ‡‰è©²å¾ tail é–‹å§‹ï¼Œé€ä¸€å¢åŠ ç´¢å¼•ï¼Œä¾åº 6 5 1 2 3 4 å°å‡ºï¼Œæˆ‘å€‘ç•«ä¸Šè™›æ“¬çš„å…ƒç´ å°æ‡‰ä½ç½®ï¼š</p>
<pre><code>~: virtual element

        h   t --&gt;
-----------------------
1 2 3 4 x x 6 5 1 2 3 4
-----------------------
                ~ ~ ~ ~
</code></pre>
<p>é¡¯è€Œæ˜“è¦‹ï¼Œè™›æ“¬å…ƒç´ å°æ‡‰çš„ç´¢å¼•æ˜¯ 8ã€9ã€10ã€11ï¼Œå·²ç¶“è¶…éç·©è¡å€çš„é•·åº¦ï¼Œå¯ä»¥åˆ©ç”¨<a href="https://en.wikipedia.org/wiki/Modulo_operation">æ¨¡é™¤é‹ç®—</a>è¨ˆç®—ç‰©ç†ç´¢å¼•ï¼Œå°‡ç´¢å¼•å›ºå®šåœ¨ä¸€å®šé•·åº¦å…§ã€‚ç›®å‰ç·©è¡å€å®¹é‡ç‚º 8ï¼Œæ‰€ä»¥å°‡ç´¢å¼•å…¨éƒ¨
æ¨¡é™¤ 8ï¼š</p>
<ul>
<li><code>8 % 8 = 0</code>ï¼šå°æ‡‰åˆ° [0] çš„å…ƒç´  1</li>
<li><code>9 % 8 = 1</code>ï¼šå°æ‡‰åˆ° [1] çš„å…ƒç´  2</li>
<li><code>10 % 8 = 2</code>ï¼šå°æ‡‰åˆ° [2] çš„å…ƒç´  3</li>
<li><code>11 % 8 = 3</code>ï¼šå°æ‡‰åˆ° [3] çš„å…ƒç´  4</li>
</ul>
<p>æ¨¡é™¤æ˜¯ç›´è§€çš„ä½œæ³•ï¼Œä½†é‚„æœ‰æ›´ç¥å¥‡çš„æ€è·¯ï¼šä½å…ƒé‹ç®—ï¼ˆbitwise arithmeticï¼‰ã€‚åªè¦æ‹¿ 7 è·Ÿé€™äº›ç´¢å¼•åš <code>&amp;</code> ä½å…ƒ AND é‹ç®—ï¼Œä¹Ÿèƒ½å¾—åˆ°ç›¸åŒçµæœã€‚</p>
<pre><code>       8        9       10       11 &lt;- Logical

  0b1000   0b1001   0b1010   0b1011
&amp; 0b0111   0b0111   0b0111   0b0111
-----------------------------------
  0b0000   0b0001   0b0010   0b0011
=      0        1        2        3 &lt;- Actual
</code></pre>
<p>é€™é‚Šä½¿ç”¨ 7 æœ‰å…¶æ„ç¾©ï¼š</p>
<ol>
<li>7 æ˜¯ $2^3 - 1$ï¼Œå‰›å¥½ $2^n - 1$ åœ¨æ˜¯äºŒé€²ä½åˆ¶ä¸­å…¨éƒ¨ä½å…ƒéƒ½æœƒæ˜¯ 1 ï¼Œä»»æ„æ•¸èˆ‡ $2^n - 1$ åšä½å…ƒ AND é‹ç®—ï¼Œå¯ä»¥å¾—åˆ°ä½ä½ n ä½ä¸­æœ‰å¤šå°‘ 1ï¼ŒåŒæ™‚æ¨æ£„å¤§æ–¼ n çš„ä½å…ƒã€‚é€™å€‹ç‰¹æ€§ä¸åä¸å€šå’Œæ¨¡é™¤çš„çµæœç›¸åŒã€‚</li>
<li>é‚„è¨˜å¾—ç’°å½¢ç·©è¡å€æœ‰å€‹ç‰¹æ€§å—ï¼š<strong>å®¹é‡åƒ…å‰©ä¸€å€‹å„²å­˜å–®å…ƒæ™‚ï¼Œè¡¨ç¤ºç·©è¡å€å·²æ»¿</strong>ã€‚è‹¥èƒ½ä¿è­‰ç’°å½¢ç·©è¡å€çš„å®¹é‡å¿…ç‚º $2^n$ï¼Œç•¶ç·©è¡å€æ»¿æ™‚ï¼Œå…ƒç´ å€‹æ•¸å®šç‚º $2^n - 1$ï¼Œå®Œå…¨ç¬¦åˆå‰ä¸€é»çš„ç‰¹æ€§ã€‚</li>
</ol>
<p>ç¶œåˆä»¥ä¸Šï¼Œåªéœ€è¦ä¿è­‰ç·©è¡å€å®¹é‡æ˜¯ $2^n$ï¼Œå°‡é‚è¼¯ç´¢å¼•æ˜ å°„åˆ°å¯¦éš›ç´¢å¼•ï¼Œåªè¦å°‡ç´¢å¼•å’Œå¯¦éš›å¯ç”¨å®¹é‡ï¼ˆ$2^n - 1$ï¼‰åšä½å…ƒ AND é‹ç®—å³å¯ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn wrap_index(index: usize, size: usize) -&gt; usize {
    debug_assert!(size.is_power_of_two());
    index &amp; (size - 1)
}
<span class="boring">}
</span></code></pre></pre>
<p>æ¥ä¸‹ä¾†ï¼Œå°±å¯ä»¥æ¨å‡º <code>wrapping_add</code> å’Œ <code>wrapping_sub</code> é€™å…©æ”¯æ­£ç¢ºå¢æ¸›ç´¢å¼•çš„æ–¹æ³•ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Deque&lt;T&gt; {
    // ...
    fn wrapping_add(&amp;self, index: usize, addend: usize) -&gt; usize {
        wrap_index(index.wrapping_add(addend), self.cap())
    }

    fn wrapping_sub(&amp;self, index: usize, subtrahend: usize) -&gt; usize {
        wrap_index(index.wrapping_sub(subtrahend), self.cap())
    }

    fn cap(&amp;self) -&gt; usize {
        self.ring_buf.cap()
    }
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>ä¸Šé¢ç”¨ç’°ç¹ç®—è¡“é‹ç®—ï¼ˆwrapping arithmetic operationï¼‰ å¯ä»¥ä½¿é–‹ç™¼æ›´æ–¹ä¾¿ï¼Œä¾‹å¦‚é‡ä¸Š index 0 è€Œ subtrahend 1 æ™‚ï¼Œå·§å¦™é¿é–‹ $0 - 1 = -1$ ä½† <code>usize</code> ä¸èƒ½ç‚ºè² çš„é™åˆ¶ï¼Œç›´æ¥ç’°ç¹å› <code>usize::MAX</code>ã€‚</p>
</blockquote>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ <code>Deque::cap</code> é€™å€‹ç°¡å–®çš„å°è£ä¸Šå‘¼å«äº† <code>RawVec::cap</code>ï¼Œé€™æ˜¯æ–°å¢çš„æ–¹æ³•ï¼Œæ—¨åœ¨æä¾› ZST ä¸€å€‹å¾ˆå¤§å¾ˆå¤§çš„è™›æ“¬å®¹é‡ï¼Œä½†åŒæ™‚ä¿è­‰æ˜¯ 2 çš„æ¬¡æ–¹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; RawVec&lt;T&gt; {
    // ...
    pub fn cap(&amp;self) -&gt; usize {
        if mem::size_of::&lt;T&gt;() == 0 {
            1usize &lt;&lt; (mem::size_of::&lt;usize&gt;() * 8 - 1)
        } else {
            self.cap
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#å‹•æ…‹å¢åŠ è¨˜æ†¶é«”ç©ºé–“" id="å‹•æ…‹å¢åŠ è¨˜æ†¶é«”ç©ºé–“">å‹•æ…‹å¢åŠ è¨˜æ†¶é«”ç©ºé–“</a></h3>
<p>å‰é¢æåŠç’°å½¢ç·©è¡å€æ˜¯é•·åº¦å›ºå®šçš„é™£åˆ—ï¼Œä½†é›™ç«¯ä½‡åˆ—è‹¥å¿…é ˆå›ºå®šé•·åº¦å°±å¤ªæ²’è·¯ç”¨ï¼Œç›´è§€ä½œæ³•å°±æ˜¯é€éåŠ å€ <code>RawVec</code> å®¹é‡ï¼Œå†ç¹¼çºŒæ–°å¢å…ƒç´ ã€‚é€™å€‹æƒ³æ³•æ²’éŒ¯ï¼Œä½†æœƒé‡åˆ°ä¸€å€‹å•é¡Œï¼šå¦‚ä½•ç¢ºä¿é‚è¼¯ç´¢å¼•åœ¨è¨˜æ†¶é«”åŠ å€å¾Œä¾ç„¶æ­£ç¢ºæ˜ å°„åˆ°å¯¦éš›ç´¢å¼•ï¼Ÿé€™è£¡èˆ‰ä¸€å€‹å¯¦éš›æ¡ˆä¾‹ï¼š</p>
<pre><code>Before:
         h   t
[o o o o x x o o]

Resize:
         h   t
[o o o o x x o o | x x x x x x x x]
</code></pre>
<p>åŒæ¨£ä¸€å€‹å®¹é‡ç‚º 8 çš„ä½‡åˆ—ï¼Œè§¸ç™¼äº†è¨˜æ†¶é«”é‡æ–°é…ç½®ï¼Œæ‰€ä»¥è¨˜æ†¶é«”åŠ å€ï¼Œç„¡å¥ˆä»Šéæ˜”æ¯”ï¼Œç¾åœ¨çš„é‚è¼¯ç´¢å¼• tail ç„¡æ³•æ˜ å°„åˆ°å¯¦éš›ç´¢å¼•ï¼Œç’°å½¢ç·©è¡å€çš„ã€Œç’°ã€å·²ç¶“æ–·æ‰ã€‚è‹¥æˆ‘å€‘ç¹¼çºŒ <code>push_back</code> å¾€ head æ·»åŠ å…ƒç´ ï¼Œå°±æœƒè¦†è“‹æ‰ tail å’Œå¾Œé¢çš„å…ƒç´ ã€‚</p>
<pre><code>after 4 push_back:

overwritten: âŒ€
newly added: _

             t h
[o o o o o o âŒ€ âŒ€ | x x x x x x x x]
         _ _ _ _
</code></pre>
<p>æœ‰é‘‘æ–¼æ­¤ï¼Œéœ€è¦ä¿®æ­£å°‡æ–·æ‰çš„ç’°ï¼Œæœ€ç°¡å–®çš„ä½œæ³•å°±æ˜¯å°‡ç·©è¡å€é¦–å€‹ç´¢å¼•åˆ° head ä¹‹å‰çš„ç´¢å¼•é€™æ®µè¨˜æ†¶é«”ç©ºé–“ï¼Œè¤‡è£½åˆ°æ–°ç¿»å€çš„ç©ºé–“ä¸Šï¼Œè®“ tail åœ¨ head å‰é¢ï¼Œåˆæ³•çš„è¨˜æ†¶é«”å€å¡Šå†æ¬¡è®Šå¾—é€£çºŒï¼š</p>
<pre><code>Before:
         h   t
[o o o o x x o o]

Resize:
         h   t
[o o o o x x o o | x x x x x x x x]

Copy:
             t           h
[x x x x x x o o | o o o o x x x x]
 _ _ _ _           _ _ _ _
</code></pre>
<p>äº†è§£å¯¦ä½œçš„ç›®æ¨™å¾Œï¼Œå…ˆå®šç¾©å€‹å®¹é‡å·²æ»¿çš„æ–¹æ³•æš–æš–èº«ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn is_full(&amp;self) -&gt; bool {
        self.cap() - self.len() == 1
    }
<span class="boring">}
</span></code></pre></pre>
<p>ç„¶å¾Œæ˜¯ <code>try_grow</code> çš„å¯¦ä½œï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn try_grow(&amp;mut self) {
        if self.is_full() {
            let old_cap = self.cap(); // 1
            self.ring_buf.try_grow(); // 2

            // 3
            if self.tail &gt; self.head {
                // The content of ring buffer won't overlapped, so it's safe to
                // call `copy_nonoverlapping`. It's also safe to advance the
                // pointer by `old_cap` since the buffer has been doubled.
                unsafe {
                    let src = self.ptr(); // 4-1
                    let dst = self.ptr().add(old_cap); // 4-2
                    ptr::copy_nonoverlapping(src, dst, self.head);
                }
                self.head += old_cap; // 5
            }
        }
    }
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å°‡èˆŠçš„å®¹é‡å­˜èµ·ä¾†ï¼Œå› ç‚ºç•¶ <code>ring_buf</code> å®¹é‡ç¿»å€å¾Œï¼Œ<code>cap()</code> è¿”å›çš„å®¹é‡å°±æœƒç¿»å€ã€‚</li>
<li>å‘¼å« <code>RawVec::try_grow()</code> è®“å®¹é‡ç¿»å€ã€‚</li>
<li>åœ¨ <code>tail</code> å¤§æ–¼ <code>head</code> æ™‚ï¼Œä»£è¡¨ç’°åœ¨ç¿»å€å¾Œæœƒä¸é€£çºŒï¼Œæ‰€ä»¥éœ€è¦è¤‡è£½å…ƒç´ ã€‚</li>
<li>é€™è£¡ç”¨ <a href="https://doc.rust-lang.org/1.49.0/std/ptr/fn.copy_nonoverlapping.html"><code>ptr::copy_nonoverlapping</code></a> é€²è¡Œä½å…ƒè¤‡è£½ï¼Œæ­¤å‡½å¼èªç¾©ä¸Šèˆ‡ C çš„ <a href="https://en.cppreference.com/w/c/string/byte/memcpy"><code>memcpy</code></a> ç›¸åŒã€‚
<ol>
<li>å–å¾—ç·©è¡å€é¦–å€‹ç´¢å¼•çš„ä½å€ï¼Œä½œç‚ºè¤‡è£½çš„èµ·å§‹ä½å€ã€‚</li>
<li>å–æ“´å¢å¾Œéƒ¨åˆ†çš„é¦–å€‹ç´¢å¼•ä½å€ï¼Œä½œç‚ºè¤‡è£½çš„ç›®æ¨™ä½å€ã€‚</li>
<li>å¯¦éš›å‘¼å« <code>memcpy</code> ï¼Œå› ç‚º head æ°¸é æ¯”æœ€å¾Œä¸€å€‹å…ƒç´ ç´¢å¼•å¤š 1ï¼Œå‰›å¥½å¯ä½œç‚ºå…ƒç´ æ•¸ç›®ã€‚</li>
</ol>
</li>
<li>è¢«è¤‡è£½çš„å…ƒç´ ä½ç§»äº† <code>old_cap</code>ï¼Œå› æ­¤æ›´æ–° <code>head</code> æ˜ å°„åˆ°æ­£ç¢ºçš„ <code>head + old_cap</code>ã€‚</li>
</ol>
<p>æˆ‘å€‘å®Œæˆäº†å‹•æ…‹å¢åŠ å®¹é‡çš„æ–¹æ³•çš„åŒæ™‚ï¼Œä¹Ÿç¶­æŒé‚è¼¯ç´¢å¼•æ˜ å°„çš„æ­£ç¢ºæ€§ã€‚</p>
<blockquote>
<p>é€™è£¡ç¶­æŒç´¢å¼•æ­£ç¢ºæ€§æœ‰ç¨å¾®ç°¡åŒ–ï¼Œæ›´é«˜æ•ˆå„ªç¾çš„è§£æ³•è«‹åƒè€ƒæ¨™æº–å‡½å¼åº« <a href="https://github.com/rust-lang/rust/blob/a118ee2/library/alloc/src/collections/vec_deque/mod.rs#L405-L447"><code>VecDeque::handle_capacity_increase</code></a> ã€‚</p>
</blockquote>
<h3><a class="header" href="#æŸ¥çœ‹å…ƒç´ " id="æŸ¥çœ‹å…ƒç´ ">æŸ¥çœ‹å…ƒç´ </a></h3>
<p>æŸ¥çœ‹é¦–æœ«å…©æ®µçš„å…ƒç´ éå¸¸ç°¡å–®ï¼Œä¸éç”±æ–¼æ¶‰åŠåº•å±¤å„²å­˜ç©ºé–“çš„æŒ‡æ¨™æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å¯« Unsafe Rustï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn front(&amp;self) -&gt; Option&lt;&amp;T&gt; {
        if self.is_empty() {
            return None;
        }
        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { Some(&amp;*self.ptr().add(self.tail)) }
    }

    pub fn back(&amp;self) -&gt; Option&lt;&amp;T&gt; {
        if self.is_empty() {
            return None;
        }
        let head = self.wrapping_sub(self.head, 1);
        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { Some(&amp;*self.ptr().add(head)) }
    }
<span class="boring">}
</span></code></pre></pre>
<p>å…©å€‹å‡½å¼éƒ½å…ˆåˆ¤æ–·é›™ç«¯ä½‡åˆ—æ˜¯å¦ç‚ºç©ºï¼Œå†åšæŒ‡æ¨™ä½ç§»é‹ç®—ï¼Œhead - 1 æ˜¯ <code>back</code> çš„æŒ‡æ¨™ä½ç§»é‡ï¼Œè€Œ <code>front</code> å°±ç›´æ¥å›å‚³ tail æŒ‡å‘çš„å€¼ã€‚å…¶ä¸­ <code>&amp;*</code> æ˜¯å¸¸è¦‹çš„ Rust æ¨¡å¼ï¼Œå¯è¦–ç‚º<strong>å°‡è£¸æŒ‡æ¨™ã€Œå‡ç´šã€ç‚ºæ›´å®‰å…¨çš„å¼•ç”¨å‹åˆ¥</strong>ï¼Œæ­¥é©Ÿå¦‚ä¸‹ï¼š</p>
<ol>
<li>è§£å¼•ç”¨è£¸æŒ‡æ¨™ï¼Œå¾—åˆ°åº•ä¸‹çš„è£¸æ•¸å€¼ã€‚</li>
<li>å»ºç«‹ä¸€å€‹å®‰å…¨çš„å¼•ç”¨ï¼ŒæŒ‡å‘è£¸æ•¸å€¼ã€‚</li>
</ol>
<p>é€™è£¡å†ä¾†å“åš <code>is_empty</code> å’Œ <code>len</code> çš„å¯¦ä½œï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn is_empty(&amp;self) -&gt; bool {
        self.len() == 0
    }

    pub fn len(&amp;self) -&gt; usize {
        self.head.wrapping_sub(self.tail) &amp; (self.cap() - 1)
    }
<span class="boring">}
</span></code></pre></pre>
<p><code>len</code> ç”¨äº†ç’°ç¹ç®—è¡“é‹ç®—ï¼Œè®“ <code>head - tail</code> èƒ½æ­£ç¢ºç®—å‡ºå…©è€…çš„è·é›¢ï¼Œä¸¦åœ¨ç”¨å‰é¢æåŠçš„ã€Œå®¹é‡ - 1ã€çš„ $2^n - 1$ åšä½å…ƒ AND é‹ç®—ä¾†æ¨æ£„é«˜ä½ã€‚</p>
<h3><a class="header" href="#å¢åˆªå…ƒç´ " id="å¢åˆªå…ƒç´ ">å¢åˆªå…ƒç´ </a></h3>
<p>ä¾†çœ‹å¾é ­å°¾åˆªé™¤å…ƒç´ çš„ <code>pop_front</code> å’Œ <code>pop_back</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn pop_front(&amp;mut self) -&gt; Option&lt;T&gt; {
        if self.is_empty() {
            return None; // 1
        }

        let tail = self.tail;
        self.tail = self.wrapping_add(self.tail, 1); // 2

        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { Some(self.ptr().add(tail).read()) } // 3
    }


<span class="boring">}
</span></code></pre></pre>
<ol>
<li>åŒæ¨£å…ˆåˆ¤æ–·é›™ç«¯ä½‡åˆ—æ˜¯å¦ç‚ºç©ºã€‚</li>
<li>å†ä¾†ç§»å‹•åˆ°ä¸‹ä¸€å€‹åˆæ³•çš„ç´¢å¼•ä¸Šï¼Œæœƒæ˜¯ head - 1 æˆ– tail + 1ã€‚</li>
<li>æœ€å¾Œæ˜¯æŒ‡æ¨™ä½ç§»å†è®€å–ï¼Œæ³¨æ„ï¼Œé›–ç„¶ <a href="https://doc.rust-lang.org/1.49.0/core/ptr/fn.read.html"><code>ptr::read</code></a> æœƒè¤‡è£½æŒ‡æ¨™æŒ‡å‘çš„å€¼ï¼Œä½†å¯è¦–ç‚ºæ‰€æœ‰æ¬Šè½‰ç§»åˆ°å›å‚³å€¼ä¸Šäº†ï¼Œé€™æ˜¯å› ç‚ºå€˜è‹¥åŸå§‹ <code>src</code> æŒ‡å‘çš„è³‡æ–™å¸¶æœ‰å…¶ä»–æŒ‡æ¨™ï¼Œé‚£éº¼ç¹¼çºŒä½¿ç”¨ <code>src</code> å°±å¯èƒ½å°è‡´è¨˜æ†¶é«”å®‰å…¨å•é¡Œã€‚</li>
</ol>
<p>å†ä¾†çœ‹å¢åŠ å…ƒç´ çš„ <code>push_front</code> èˆ‡ <code>push_back</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub fn push_front(&amp;mut self, elem: T) {
        self.try_grow(); // 1
        self.tail = self.wrapping_sub(self.tail, 1); // 2

        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { self.ptr().add(self.tail).write(elem) } // 3
    }

    pub fn push_back(&amp;mut self, elem: T) {
        self.try_grow(); // 1
        let head = self.head;
        self.head = self.wrapping_add(self.head, 1); // 2

        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { self.ptr().add(head).write(elem) } // 3
    }
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>åŒæ¨£å…ˆåˆ¤æ–·é›™ç«¯ä½‡åˆ—æ˜¯å¦ç‚ºç©ºã€‚</li>
<li>å†ä¾†ç§»å‹•åˆ°ä¸‹ä¸€å€‹åˆæ³•çš„ç´¢å¼•ä¸Šï¼Œæœƒæ˜¯ head + 1 æˆ– tail - 1ã€‚</li>
<li>æœ€å¾Œæ˜¯æŒ‡æ¨™ä½ç§»å†å¯«å…¥ï¼Œ <a href="https://doc.rust-lang.org/1.49.0/core/ptr/fn.write.html"><code>ptr::write</code></a> ä¸æœƒè§¸ç™¼è®€å–æˆ–æ˜¯ drop è£¸æŒ‡æ¨™æŒ‡å‘çš„å€¼ï¼Œä½†ä½¿ç”¨ä¸Šä»ç„¶è¦ç¢ºèªå­˜å–è©²ä½å€æ˜¯å¦åˆæ³•ã€‚</li>
</ol>
<p>ä»¥ä¸Šå°±æ˜¯ <code>Deque</code>   åŸºæœ¬æ“ä½œæ–¹æ³•ï¼Œè‡³æ­¤ï¼Œå‰©ä¸‹æœ€å¾Œä¸€æ­¥ã€Œ<a href="#drop">æ­£ç¢ºé‡‹æ”¾è¨˜æ†¶é«”</a>ã€ï¼Œé›™ç«¯ä½‡åˆ—åŸºæœ¬æ¬¾å°±å®Œæˆäº†ã€‚</p>
<h2><a class="header" href="#ç‰¹å¾µ" id="ç‰¹å¾µ">ç‰¹å¾µ</a></h2>
<p>Rust æä¾›è¨±å¤šç‰¹å¾µï¼ˆTraitï¼‰ï¼Œå¯¦ä½œç‰¹å¾µå¯ä»¥è®“è³‡æ–™çµæ§‹æ›´æ–¹ä¾¿ï¼Œæ›´ç¬¦åˆ Rust ç¤¾ç¾¤çš„å¯«ä½œæ…£ä¾‹ã€‚</p>
<h3><a class="header" href="#drop" id="drop"><code>Drop</code></a></h3>
<p>é€™æ˜¯ <code>Deque</code> æœ€é‡è¦çš„ç‰¹å¾µä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å®Œæˆ <code>Deque</code> åŸºæœ¬æ¬¾çš„æœ€å¾Œä¸€å€‹å¿…è¦åŠŸèƒ½ã€‚<code>Drop</code> æœƒç”¨ä¾†é‡‹æ”¾å„²å­˜åœ¨ <code>Deque</code> è£¡é¢å…ƒç´ çš„è³‡æºã€‚å¯¦ä½œæ˜¯å°‡æ‰€æœ‰å…ƒç´  <code>pop_back</code> å‡ºä¾†ï¼Œæ‰€æœ‰æ¬Šè½‰ç§»åˆ° <code>drop</code> å‡½å¼å…§ï¼Œå‡½å¼æœ¬é«”åŸ·è¡ŒçµæŸå¾Œï¼Œå°±æœƒè‡ªå‹•å‘¼å«è©²å…ƒç´ å‹åˆ¥çš„ <code>drop</code> ä¸¦é‡‹æ”¾è³‡æºã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Drop for Deque&lt;T&gt; {
    fn drop(&amp;mut self) {
        while let Some(_) = self.pop_back() {}
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¹Ÿè¨±ä½ æœƒå•ã€Œç‚ºä»€éº¼ä¸åœ¨ <code>Deque.ring_buf</code> çš„ <code>RawVec</code> å¯¦ä½œ <code>Drop</code> ä¾†é‡‹æ”¾å…¶å…§å®¹çš„è³‡æºï¼Ÿã€ä¸»å› æ˜¯æ¬Šè²¬å€åˆ†ï¼Œ<code>RawVec</code> åƒ…è² è²¬é‡‹æ”¾å®ƒè‡ªè¡Œé…ç½®çš„å †ç–Šè¨˜æ†¶é«”ï¼Œä¸æ¸…æ¥šå…§å®¹å…ƒç´ è©²å¦‚ä½•é‡‹æ”¾è¨˜æ†¶é«”ï¼Œä¾‹å¦‚å…§å®¹å¯èƒ½æ˜¯ <a href="https://en.wikipedia.org/wiki/Region-based_memory_management">Region-based memory management</a>ï¼Œä¸€èµ·é‡‹æ”¾æ•ˆç‡æ›´é«˜ï¼Œå…ƒç´ å„åˆ¥ <code>mem::drop</code> åè€Œæ‹–ç´¯æ•ˆç‡ã€‚</p>
<blockquote>
<p>äº‹å¯¦ä¸Š <code>Deque::drop</code> ä¹Ÿèƒ½æ›´é«˜æ•ˆï¼Œ<a href="https://github.com/rust-lang/rust/blob/a118ee2/library/alloc/src/collections/vec_deque/mod.rs#L117-L139"><code>std::colletions::VecDeque::drop</code></a> å°±æ˜¯ç›´æ¥ drop å…©å€‹æŒ‡å‘åˆ‡ç‰‡ï¼ˆsliceï¼‰çš„æŒ‡æ¨™ï¼Œè€Œéæ¯å€‹å…ƒç´ å„è‡ªè™•ç†ï¼Œé›–ç„¶æœ€å¾Œå¯èƒ½æ®Šé€”åŒæ­¸ï¼Œè¦–ç·¨è­¯å™¨æœ€ä½³åŒ–ç¨‹åº¦è€Œå®šã€‚</p>
</blockquote>
<h3><a class="header" href="#iterator" id="iterator"><code>Iterator</code></a></h3>
<p>èº«ç‚ºå®¹å™¨å‹åˆ¥ï¼Œæ²’æœ‰ç–Šä»£å™¨ç°¡ç›´ä¸èƒ½ç”¨ï¼ŒRust æä¾›è¨±å¤šç–Šä»£å™¨ç‰¹å¾µä¾›å¯¦ä½œï¼Œå…¶ä¸­ <a href="https://doc.rust-lang.org/1.49.0/core/iter/trait.Iterator.html"><code>Iterator</code></a> ç‰¹å¾µæœ€ç‚ºåŸºç¤ä¸”é‡è¦ï¼Œå¯¦ä½œ <code>Iterator</code> ç‰¹å¾µéœ€æ±‚ä¸€å€‹ <code>next</code> æ–¹æ³•ï¼Œæœƒä¸æ–·å›å‚³ä¸‹ä¸€å€‹å…ƒç´ ã€‚ä»»ä½•å¯¦ä½œ <code>Iterator</code> ç‰¹å¾µçš„å‹åˆ¥ï¼Œéƒ½å¯ä»¥æ”¾å…¥ for è¿´åœˆç–Šä»£ã€‚</p>
<p>è€Œ Rust å¸¸è¦‹çš„ç–Šä»£å™¨è¨­è¨ˆæ¨¡å¼åŒ…å«ä¸‰å€‹ç”¢ç”Ÿç–Šä»£å™¨çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>iter()</code>ï¼šæ…£ä¾‹ä¸Šå›å‚³æœƒç”¢ç”Ÿä¸å¯è®Šå¼•ç”¨ <code>&amp;T</code> çš„ <code>Iterator</code>ã€‚</li>
<li><code>iter_mut()</code>ï¼šæ…£ä¾‹ä¸Šå›å‚³æœƒç”¢å‡ºå¯è®Šå¼•ç”¨ <code>&amp;mut T</code> çš„ <code>Iterator</code>ã€‚</li>
<li><code>into_iter()</code>ï¼šæ…£ä¾‹ä¸Šå›å‚³åƒæ‰æ‰€æœ‰æ¬Š <code>T</code> çš„ <code>Iterator</code> ï¼Œé€šå¸¸ç›´æ¥å¯¦ä½œ <code>IntoIterator</code> ç‰¹å¾µå³å¯ï¼Œæˆ‘å€‘åœ¨<a href="#intoiterator">ä¸‹ä¸€æ®µ</a>ä»‹ç´¹å®ƒã€‚</li>
</ul>
<p>å¯¦ä½œ <code>Iterator</code> éœ€è¦æ–°çš„çµæ§‹é«”ï¼Œä»¥å„²å­˜ç–Šä»£çš„å…§éƒ¨ç‹€æ…‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Iter&lt;'a, T&gt; {
    head: usize,
    tail: usize,
    ring_buf: &amp;'a [T],
}

pub struct IterMut&lt;'a, T&gt; {
    head: usize,
    tail: usize,
    ring_buf: &amp;'a mut [T],
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li><code>Iter</code>ï¼šç”±æ–¼å®šä½ <code>Deque</code> ä¸­æœ‰å…ƒç´ çš„åˆæ³•è¨˜æ†¶é«”å€åŸŸéœ€è¦ <code>head</code> å’Œ <code>tail</code>ï¼Œå› æ­¤å„²å­˜è©²å…©è€…ï¼Œä¸¦ä¸”å„²å­˜åº•å±¤çš„ç’°å½¢ç·©è¡å€çš„åˆ‡ç‰‡å¼•ç”¨ï¼Œæ–¹ä¾¿å­˜å–å…ƒç´ ã€‚</li>
<li><code>IterMut</code>ï¼šåŒ <code>Iter</code>ï¼Œä½†æ”¹ç‚ºå„²å­˜å¯è®Šçš„åˆ‡ç‰‡å¼•ç”¨ã€‚</li>
</ul>
<p>ä¾†çœ‹çœ‹ <code>Iter</code> å¦‚ä½•å¯¦ä½œç–Šä»£å™¨ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'a, T&gt; Iterator for Iter&lt;'a, T&gt; {
    type Item = &amp;'a T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        if self.tail == self.head {
            return None; // 1
        }
        let tail = self.tail; // 2
        self.tail = wrap_index(self.tail.wrapping_add(1), self.ring_buf.len()); // 3
        self.ring_buf.get(tail) // 4
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>ç•¶ tail ç­‰æ–¼ head æ™‚ï¼Œä»£è¡¨ç’°å½¢ç·©è¡å€ç‚ºç©ºï¼Œç›´æ¥å›å‚³ <code>None</code>ã€‚</li>
<li>tail æ˜¯ <code>Deque</code> æœ€å‰ç«¯ï¼Œé€™è£¡å…ˆå°‡ç•¶å‰çš„ tail å„²å­˜èµ·ä¾†ã€‚</li>
<li>å†å°‡ Iter ä¸Šçš„ tail å¢åŠ  1ï¼ˆä¸å½±éŸ¿åŸå§‹ Dequeï¼‰ï¼Œä¸‹ä¸€æ¬¡å‘¼å« <code>next</code> å°±æœƒå–å¾—ä¸‹ä¸€å€‹å…ƒç´ ã€‚</li>
<li>åˆ©ç”¨ç¬¬äºŒæ­¥å„²å­˜çš„ç•¶å‰ tailï¼Œé…åˆ <code>slice::get</code> ç›´æ¥å›å‚³ä¸€å€‹å…ƒç´ ã€‚</li>
</ol>
<p>å†ä¾†è™•ç† <code>IterMut::next</code>ï¼Œç›´è§€ä¸Šå°‡ <code>Iter::next</code> çš„ <code>self.ring_buf.get(tail)</code> æ”¹æˆ <code>get_mut</code> å³å¯ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'a, T&gt; Iterator for IterMut&lt;'a, T&gt; {
    type Item = &amp;'a mut T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        if self.tail == self.head {
            return None;
        }
        let tail = self.tail;
        self.tail = wrap_index(self.tail.wrapping_add(1), self.ring_buf.len());
        self.ring_buf.get_mut(tail) // Change to `get_mut`
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>æ¬¸ï¼å±…ç„¶ç·¨è­¯å¤±æ•—äº†ï¼Œåˆ°åº•ç‚ºä»€éº¼å‘¢ï¼Ÿ</p>
<pre><code class="language-console">error[E0495]: cannot infer an appropriate lifetime for autoref due to conflicting requirements
   --&gt; src/collections/deque/mod.rs:353:23
    |
353 |         self.ring_buf.get_mut(tail)
    |                       ^^^^^^^
    |
note: first, the lifetime cannot outlive the anonymous lifetime #1 defined on the method body at 347:5...
   --&gt; src/collections/deque/mod.rs:347:5
    |
347 |     fn next(&amp;mut self) -&gt; Option&lt;&amp;'a mut T&gt; {
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
note: ...so that reference does not outlive borrowed content
   --&gt; src/collections/deque/mod.rs:353:9
    |
353 |         self.ring_buf.get_mut(tail)
    |         ^^^^^^^^^^^^^
note: but, the lifetime must be valid for the lifetime `'a` as defined on the impl at 344:6...
   --&gt; src/collections/deque/mod.rs:344:6
    |
344 | impl&lt;'a, T&gt; Iterator for IterMut&lt;'a, T&gt; {
    |      ^^
note: ...so that the expression is assignable
   --&gt; src/collections/deque/mod.rs:353:9
    |
353 |         self.ring_buf.get_mut(tail)
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    = note: expected `Option&lt;&amp;'a mut T&gt;`
               found `Option&lt;&amp;mut T&gt;`
</code></pre>
<p>é€™å€‹ç·¨è­¯éŒ¯èª¤æ˜¯å› ç‚ºåŒ¿åçš„ <code>&amp;mut self</code> å’Œ <code>Self::Item</code> å…©è€…ç”Ÿå‘½é€±æœŸä¸åŒ¹é…ã€‚ä»¥ä¸‹æŠŠå‡½å¼ç°½åçš„ç”Ÿå‘½é€±æœŸå±•é–‹ä¾†çœ‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn next&lt;'anonymous&gt;(&amp;'anonymous mut self) -&gt; Option&lt;&amp;'a mut T&gt; {
        // ...
        self.ring_buf // &amp;'anonymous [T]
            .get_mut(tail) // Some(&amp;'anonymous mut T)
    }
<span class="boring">}
</span></code></pre></pre>
<p>å—¯ï¼Œé€™ä¸å¤ªå°ï¼Œæˆ‘å€‘çŸ¥é“ Rust ä¿è­‰ã€Œå°±ç®— drop äº†ç–Šä»£å™¨æœ¬èº«ï¼Œç”¢å‡ºçš„å…ƒç´ ä»ç„¶åˆæ³•ã€ï¼Œç”¢å‡ºçš„å…ƒç´ è‹¥ç‚ºå¼•ç”¨çµ•å°<a href="https://users.rust-lang.org/t/iterator-lifetime-error-only-when-using-a-mutable-reference/50460/6">ä¸æœƒæ˜¯è¿·é€”å¼•ç”¨</a>ï¼Œä¾‹å¦‚ä¸‹é¢ç¯„ä¾‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a = iter.next().unwrap();
let b = iter.next().unwrap();
drop(iter);
use_both(a, b);
<span class="boring">}
</span></code></pre></pre>
<p>ä½†ç·¨è­¯å™¨åªçœ‹å‹åˆ¥æ˜¯å¦æ­£ç¢ºï¼Œä¸¦ç„¡æ³•æª¢æŸ¥åŸ·è¡ŒæœŸé–“çš„ <code>&amp;mut self</code> å…§éƒ¨ <code>ring_buf</code> å’Œ <code>Self::Item</code> æ˜¯å¦æ´»å¾—ä¸€æ¨£ä¹…ï¼Œä¸”ç”±æ–¼ <code>Iterator::next</code> å‡½å¼ç°½åä¸Šæ²’æœ‰å° <code>&amp;mut self</code> çš„ç”Ÿå‘½é€±æœŸåšä»»ä½•é™åˆ¶ï¼Œå› æ­¤ç„¡æ³•å¯«å‡ºä¸‹åˆ—é€™ç¨®é æœŸä¸­çš„ç”Ÿå‘½é€±æœŸé™åˆ¶ï¼ˆå¯è¦–ç‚ºè¦æ±‚ <code>'b</code> è‡³å°‘æ´»å¾—è·Ÿ <code>'a</code> ä¸€æ¨£é•·ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'a, T&gt; Iterator for IterMut&lt;'a, T&gt; {
    type Item = &amp;'a mut T;

    fn next&lt;'b: 'a&gt;(&amp;'b mut self) -&gt; Option&lt;Self::Item&gt; {
        // ...omit
    }
}

// error[E0195]: lifetime parameters or bounds on method `next` do not match the trait declaration
//    --&gt; src/collections/deque/mod.rs:347:12
//     |
// 347 |     fn next&lt;'b: 'a&gt;(&amp;'b mut self) -&gt; Option&lt;Self::Item&gt; {
//     |            ^^^^^^^^ lifetimes do not match method in trait
<span class="boring">}
</span></code></pre></pre>
<p>ç•¶ç„¶ï¼Œæˆ‘å€‘çŸ¥é“å›å‚³ <code>ring_buf</code> çš„ <code>&amp;'a mut T</code> åœ¨ç”Ÿå‘½é€±æœŸä¸Šåˆæ³•ï¼Œä½†ç·¨è­¯å™¨èªä¸å‡ºä¾†ï¼Œæ‰€ä»¥ unsafe åˆè¦ä¾†æ‹¯æ•‘ä¸–ç•Œã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'a, T&gt; Iterator for IterMut&lt;'a, T&gt; {
    type Item = &amp;'a mut T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        if self.tail == self.head {
            return None;
        }
        let tail = self.tail;
        self.tail = wrap_index(self.tail.wrapping_add(1), self.ring_buf.len());
        // This unsafe block is needed for solving the limitation of Iterator
        // trait: the `&amp;mut self` is bound to an anonymous lifetime which rustc
        // cannot figure out whether it would outlive returning element. Hence
        // the explicit pointer casting is required.
        unsafe {
            let ptr = self.ring_buf as *mut [T]; // 1
            let slice = &amp;mut *ptr; // 2
            slice.get_mut(tail) // 3
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol>
<li>å°‡ <code>ring_buf</code> è½‰æ›æˆè£¸æŒ‡æ¨™ï¼Œå› ç‚ºè£¸æŒ‡æ¨™ç„¡ç”Ÿå‘½é€±æœŸï¼Œæ‰€ä»¥ <code>&amp;mut self</code> çµ¦çš„é™åˆ¶ä¸è¦‹äº†ã€‚</li>
<li>å†æŠŠ <code>ptr</code> æŒ‡å‘çš„ <code>*mut [T]</code> è£¸æŒ‡æ¨™è½‰æ›æˆæœ‰ç”Ÿå‘½é€±æœŸçš„å¯è®Šå¼•ç”¨ <code>&amp;mut [T]</code> çš„åˆ‡ç‰‡ã€‚è—‰ç”± Rust å°å›å‚³å‹åˆ¥çš„è‡ªå‹•æ¨æ–·ï¼Œæ­¤åˆ‡ç‰‡çš„å¯¦éš›å‹åˆ¥æœƒæ˜¯ <code>&amp;'a mut [T]</code>ã€‚Got itï¼é€™å°±æ˜¯æˆ‘å€‘æ‰€è¦çš„ã€‚</li>
<li>è€è€å¯¦å¯¦åœ°å‘¼å« <code>slice::get_mut</code>ï¼Œå®Œå…¨æ­£ç¢ºã€‚</li>
</ol>
<blockquote>
<p>é€™é¡ <em>An iterator yields borrowing contents from it<code>self</code></em> çš„å•é¡Œï¼Œæœ‰å€‹ä¿—åå«åš <em>streaming iterator</em>ï¼Œå¯ä»¥é€é<strong>æ³›å‹é—œè¯å‹åˆ¥</strong>ï¼ˆgeneric associated type a.k.a GATï¼‰è§£æ±ºï¼Œä½†ç›®å‰ GAT å°šæœªç©©å®šã€‚è©³æƒ…å¯åƒè€ƒé€™ç¯‡ä»‹ç´¹ <a href="https://lukaskalbertodt.github.io/2018/08/03/solving-the-generalized-streaming-iterator-problem-without-gats.html">GAT èˆ‡ streaming iterator workaroud</a> çš„æ–‡ç« ã€‚</p>
</blockquote>
<blockquote>
<p>æ¬¸ï¼Œæˆ–è¨±ä½ æœ‰ç–‘æƒ‘ï¼Œ<code>Iter::next</code> ä¸ä¹ŸåŒæ¨£æœ‰ç”Ÿå‘½é€±æœŸå•é¡Œå—ï¼Œç‚ºä»€éº¼æ²’æœ‰å ±éŒ¯å‘¢ï¼Ÿé€™æ˜¯å› ç‚º<a href="https://doc.rust-lang.org/1.49.0/core/marker/trait.Copy.html#impl-Copy-130">æ‰€æœ‰ <code>&amp;T</code> å¼•ç”¨éƒ½é è¨­å¯¦ä½œ Copy ç‰¹å¾µ</a>ï¼Œå‘¼å« <code>slice::get()</code> æ™‚æœƒ<strong>è‡ªå‹•è¤‡è£½</strong> <code>ring_buf</code> çš„å¼•ç”¨ï¼Œå› æ­¤æ²’æœ‰ç”Ÿå‘½é€±æœŸçš„å•é¡Œï¼Œä½† <code>&amp;mut T</code> ä¸¦æ²’æœ‰å¯¦ä½œ Copy ç‰¹å¾µï¼Œæ‰æœƒé‡ä¸Šç”Ÿå‘½é€±æœŸä¸ç¬¦çš„ç·¨è­¯éŒ¯èª¤ã€‚</p>
</blockquote>
<h3><a class="header" href="#intoiterator" id="intoiterator"><code>IntoIterator</code></a></h3>
<p>ç›¸è¼ƒæ–¼ <code>Interator</code>ï¼Œ<a href="https://doc.rust-lang.org/1.49.0/core/iter/trait.IntoIterator.html"><code>IntoIterator</code></a> æ˜¯ä¸€å€‹è®“å®¹å™¨å‹åˆ¥éŒ¦ä¸Šæ·»èŠ±çš„ç‰¹å¾µï¼Œä¸»è¦åŠŸèƒ½æ˜¯ï¼šå°‡ä¸€å€‹å‹åˆ¥è‡ªå‹•è½‰æ›ç‚ºæœ‰å¯¦ä½œ <code>Iterator</code> çš„å‹åˆ¥ï¼Œå¯¦ä½œå¾Œè©²å‹åˆ¥å°±å¯ä»¥ç›´æ¥æ”¾å…¥ for è¿´åœˆä¸­ã€‚</p>
<p>ä¾‹å¦‚ä¸‹åˆ—ç”¨æ³•ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut d = Deque::new();
d.push_back(1);
d.push_back(2);
d.push_front(3);
d.push_front(4);

for elem in &amp;d {
    println!(&quot;{:?}&quot;. elem);
}

for elem in &amp;mut d {
    *elem *= *elem;
}
<span class="boring">}
</span></code></pre></pre>
<p>å¯¦ä½œä¸Šåˆ†ä¸‰å€‹ï¼š</p>
<ul>
<li><code>impl&lt;T&gt; IntoIterator for Deque&lt;T&gt;</code>ï¼šå°‡å®¹å™¨è½‰æ›æˆç–Šä»£å™¨ï¼Œä¸¦è½‰ç§»å®¹å™¨å’Œå…ƒç´ çš„æ‰€æœ‰æ¬Šã€‚</li>
<li><code>impl&lt;'a, T&gt; IntoIterator for &amp;'a Deque&lt;T&gt;</code>ï¼šå°‡å®¹å™¨ä¸å¯è®Šå¼•ç”¨è½‰æ›æˆä¸å¯è®Šå…ƒç´ çš„ç–Šä»£å™¨ã€‚</li>
<li><code>impl&lt;'a, T&gt; IntoIterator for &amp;'a mut Deque&lt;T&gt;</code>ï¼šå°‡å®¹å™¨å¯è®Šå¼•ç”¨è½‰æ›æˆå¯è®Šå…ƒç´ çš„ç–Šä»£å™¨ã€‚</li>
</ul>
<p>å…ˆèªªæ˜å¾Œé¢å…©è€…ã€‚ä»¥ä¸‹å¯¦ä½œéå¸¸ç°¡å–®ï¼Œåªè¦æ ¹æ“šå®¹å™¨å¼•ç”¨å¯è®Šèˆ‡å¦ï¼Œå°æ‡‰å‘¼å«å‰ä¸€æ®µæåŠçš„ <code>Deque::iter</code> æˆ– <code>Deque::iter_mut</code> å³å¯ï¼Œé€™ç®—æ˜¯ Rust å®¹å™¨å‹åˆ¥çš„ä¸€è²«ä½œæ³•ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;'a, T&gt; IntoIterator for &amp;'a Deque&lt;T&gt; {
    type Item = &amp;'a T;
    type IntoIter = Iter&lt;'a, T&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        self.iter()
    }
}

impl&lt;'a, T&gt; IntoIterator for &amp;'a mut Deque&lt;T&gt; {
    type Item = &amp;'a mut T;
    type IntoIter = IterMut&lt;'a, T&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        self.iter_mut()
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>è‡³æ–¼ <code>impl&lt;T&gt; IntoIterator for Deque&lt;T&gt;</code> å’Œ <code>iter</code> èˆ‡ <code>iter_mut</code> ä¸ä¸€æ¨£ï¼Œæœƒåƒæ‰€æœ‰æ¬Šï¼Œæ‰€ä»¥éœ€è¦å®£å‘Šé¡å¤–çš„çµæ§‹é«”ä¾†å„²å­˜å…¶å…§éƒ¨ç‹€æ…‹ï¼Œä¸¦ç›´æ¥å¯¦ä½œ <code>IntoIterator</code> è¦æ±‚çš„ <code>into_iter</code> æ–¹æ³•ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct IntoIter&lt;T&gt;(Deque&lt;T&gt;);

impl&lt;T&gt; IntoIterator for Deque&lt;T&gt; {
    type Item = T;
    type IntoIter = IntoIter&lt;T&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        IntoIter(self)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>æ­¤ç–Šä»£æ–¹æ³•ä¸­ï¼Œä½‡åˆ—å…§å…ƒç´ çš„æ‰€æœ‰æ¬Šæœƒè½‰ç§»ï¼Œæ‰€ä»¥ä¸éœ€è¦è·Ÿ <code>Iter</code> ä¸€æ¨£ä¿å­˜åˆ‡ç‰‡ï¼Œå¯ä»¥ç›´æ¥å­˜æ•´å€‹ <code>Deque</code> ä½œç‚ºå…§éƒ¨ç‹€æ…‹ï¼Œæ‹¿èµ° <code>Deque</code> çš„æ‰€æœ‰æ¬Šã€‚</p>
<p>æ—¢ç„¶æŒæ§ <code>Deque</code> æ‰€æœ‰æ¬Šï¼Œå¯¦ä½œç–Šä»£å™¨å°±æ²’æœ‰å›°é›£äº†ï¼Œç›´æ¥å°‡æ‰€æœ‰å…ƒç´  pop å–å‡ºå³å¯ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Iterator for IntoIter&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.0.pop_front()
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#index-and-indexmut" id="index-and-indexmut"><code>Index</code> and <code>IndexMut</code></a></h3>
<p>ç”¨ç´¢å¼•ä¸‹æ¨™ <code>array[index]</code> å–å€¼çš„èªæ³•å¸¸è¦‹æ–¼å„å¤§ä¸»æµèªè¨€ï¼ŒRust æä¾› <a href="https://doc.rust-lang.org/1.49.0/core/ops/trait.Index.html"><code>Index</code></a> å’Œ <a href="https://doc.rust-lang.org/1.49.0/core/ops/trait.IndexMut.html"><code>IndexMut</code></a> å…©å€‹ç‰¹å¾µä¾†å¯¦ä½œé€™å€‹é‹ç®—å­ï¼Œè®“å®¹å™¨å‹åˆ¥æ›´ç¬¦åˆäººé«”å·¥å­¸ã€‚</p>
<p>å¯¦ä½œæ–¹æ³•æ˜¯åˆ©ç”¨<a href="#%E9%82%8F%E8%BC%AF%E7%B4%A2%E5%BC%95%E6%98%A0%E5%B0%84">é‚è¼¯ç´¢å¼•æ˜ å°„</a> æ®µè½å¯¦ä½œçš„ <code>wrap_index</code> å¾—å‡ºå¯¦éš›ç´¢å¼•ï¼Œå†é€éæŒ‡æ¨™å–å€¼å³å¯ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯è¶Šç•Œå­˜å–ï¼ˆout of bound accessï¼‰å¯èƒ½ç”¢ç”Ÿæœªå®šç¾©è¡Œç‚ºï¼Œä¸ç¬¦åˆ Rust å°è¨˜æ†¶é«”å®‰å…¨çš„è¦æ±‚ï¼Œæ‰€ä»¥åœ¨è£¸æŒ‡æ¨™å­˜å–ä¹‹å‰ï¼Œå°±è¦ç›´æ¥ <code>assert!</code> ç´¢å¼•æ˜¯å¦åœ¨å…ƒç´ æ•¸é‡çš„å®‰å…¨ç¯„åœå…§ï¼Œé˜²æ­¢è¶Šç•Œå­˜å–ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Index&lt;usize&gt; for Deque&lt;T&gt; {
    type Output = T;

    fn index(&amp;self, index: usize) -&gt; &amp;Self::Output {
        assert!(index &lt; self.len(), &quot;Out of bound&quot;);
        let index = self.wrapping_add(self.tail, index);
        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { &amp;*self.ptr().add(index) }
    }
}

impl&lt;T&gt; IndexMut&lt;usize&gt; for Deque&lt;T&gt; {
    fn index_mut(&amp;mut self, index: usize) -&gt; &amp;mut T {
        assert!(index &lt; self.len(), &quot;Out of bound&quot;);
        let index = self.wrapping_add(self.tail, index);
        // This is safe because the offset is wrapped inside valid memory region.
        unsafe { &amp;mut *self.ptr().add(index) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#debug" id="debug"><code>Debug</code></a></h3>
<p>æœ€å¾Œï¼Œä»‹ç´¹ä¸€ä¸‹ <code>fmt::Formatter</code> æœ‰è¨±å¤šæ–¹ä¾¿çš„ debug æ ¼å¼åŒ–è¼¸å‡ºçš„æ–¹æ³•ï¼Œä¾‹å¦‚ <a href="https://doc.rust-lang.org/1.49.0/alloc/fmt/struct.Formatter.html#method.debug_list"><code>debug_list</code></a> å¯ä»¥ä¸Ÿä¸€å€‹ç–Šä»£å™¨ï¼Œæœƒè½‰åŒ–æˆåºåˆ—èˆ¬çš„è¼¸å‡ºæ ¼å¼ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T: fmt::Debug&gt; fmt::Debug for Deque&lt;T&gt; {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        f.debug_list().entries(self.iter()).finish()
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ç•¶ç„¶ï¼Œå¦‚æœæƒ³è¦å° <code>RawVec</code> å¯¦ä½œ <code>Debug</code> ç‰¹å¾µï¼Œå…æ‰‹å¯«ï¼Œå¯ç›´æ¥ç”¨ <code>derive</code> å±¬æ€§è®“<a href="https://doc.rust-lang.org/stable/book/appendix-03-derivable-traits.html#debug-for-programmer-output">ç·¨è­¯å™¨æ¨å°å¯¦ä½œ</a>ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug)] // Add this line to derive Debug trait automatically.
struct RawVec&lt;T&gt; {
    ptr: *mut T,
    cap: usize,
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#æ•ˆèƒ½" id="æ•ˆèƒ½">æ•ˆèƒ½</a></h2>
<p>ä»¥ç’°å½¢ç·©è¡å€ç‚ºåº•å±¤å„²å­˜å®¹å™¨çš„é›™ç«¯åºåˆ—ï¼Œå„æ“ä½œè¤‡é›œåº¦å¦‚ä¸‹:</p>
<table><thead><tr><th>Operation</th><th>Best case</th><th>Worst case</th></tr></thead><tbody>
<tr><td>push_front(v)</td><td>$O(1)$</td><td>$O(1)$~</td></tr>
<tr><td>push_back(v)</td><td>$O(1)$</td><td>$O(1)$~</td></tr>
<tr><td>pop_front(v)</td><td>$O(1)$</td><td>$O(1)$~</td></tr>
<tr><td>pop_back(v)</td><td>$O(1)$</td><td>$O(1)$~</td></tr>
<tr><td>front</td><td>$O(1)$</td><td>$O(1)$</td></tr>
<tr><td>back</td><td>$O(1)$</td><td>$O(1)$</td></tr>
<tr><td>len</td><td>$O(1)$</td><td>$O(1)$</td></tr>
</tbody></table>
<blockquote>
<p>$n$ï¼šè³‡æ–™ç­†æ•¸ã€‚<br />
$v$ï¼šè³‡æ–™å€¼ã€‚<br />
<strong>~</strong>ï¼šå¹³æ”¤å¾Œçš„è¤‡é›œåº¦ï¼ˆamortizedï¼‰ã€‚</p>
</blockquote>
<p>é›™ç«¯ä½‡åˆ—ä»»ä½•æ“ä½œéƒ½æ˜¯ç›´æ¥å° head æˆ– tail çš„ç´¢å¼•è®€å¯«è¨˜æ†¶é«”ï¼Œè¤‡é›œåº¦çš†ç‚º $O(1)$ï¼Œä¸éå› ç‚ºå¢æ¸›å…ƒç´ éœ€è¦å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“å¤§å°ï¼Œæ‰€ä»¥é€™äº›æ–¹æ³•çš„æ™‚é–“è¤‡é›œåº¦éœ€è¦å¹³æ”¤ã€‚</p>
<p>ç©ºé–“è¤‡é›œåº¦å‰‡æ˜¯åªç”¨äº†ä¸€å€‹ç’°å½¢ç·©è¡å€å„²å­˜å…ƒç´ ï¼Œå’Œå¹¾å€‹æ¬„ä½å„²å­˜ tailã€head é‚„æœ‰å®¹é‡ï¼Œå› æ­¤é¡å¤–ç©ºé–“è¤‡é›œåº¦åªæœ‰ $O(1)$ã€‚</p>
<h2><a class="header" href="#åƒè€ƒè³‡æ–™" id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</a></h2>
<ul>
<li><a href="https://doc.rust-lang.org/stable/std/collections/vec_deque/struct.VecDeque.html">Rust Documentation: <code>VecDeque</code></a></li>
<li><a href="https://github.com/rust-lang/rust/blob/ff6ee2a/library/alloc/src/raw_vec.rs">Rust <code>RawVec</code> Implementation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Circular_buffer">Wiki: Circular buffer</a></li>
<li>Circular Buffer Image by Cburnett <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA-3.0</a> via Wikimedia Commons.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../collections/queue/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../collections/linked_list/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../collections/queue/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../collections/linked_list/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../theme/custom.js"></script>
        

        

    </body>
</html>
